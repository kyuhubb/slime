<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>map</title>
	<script src='lib/nikolib.js'></script>
	<script src='lib/filesaver.js'></script>
	<script src='lib/ai.js'></script>
	<script src='lib/cpu.js'></script>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
	<div id="particles-js"></div>
	<audio id='bgm' src='' loop></audio>
	<audio id='birds' src='sfx/birds.mp3' loop></audio>
	<audio id='river' src='sfx/river.mp3' loop></audio>
	<audio id='abyss' src='sfx/abyss.mp3' loop></audio>
	<audio id='wind' src='sfx/wind.mp3' loop></audio>
	<audio id='morning' src='sfx/morning.mp3'></audio>
	<audio id='amogus' src='sfx/amogus.mp3'></audio>
	<audio id='oof' src='sfx/poison.mp3'></audio>
	<audio id='splash' src='sfx/splash.mp3'></audio>
	<audio id='selcity1' src='sfx/selcity1.mp3' loop></audio>
	<audio id='buildbridge' src='sfx/buildbridge.mp3'></audio>
	<audio id='night-ambient' src='sfx/night.mp3' loop></audio>
	<audio id='fire' src='sfx/fire.mp3' loop></audio>
	<audio id='fireball' src='sfx/fireball.mp3'></audio>
	<audio id='owl-ambient' src='sfx/owl.mp3' loop></audio>
	<audio id='victory_theme' src='sfx/victory_theme.mp3'></audio>
	<audio id='slash' src='sfx/slash.mp3'></audio>
	<audio id='town' src='sfx/town.mp3'></audio>
	<audio id='getin' src='sfx/getin.mp3'></audio>
	<audio id='getout' src='sfx/getout.mp3'></audio>
	<audio id='muffled' src='sfx/muffled.mp3'></audio>
	<audio id='deflect' src='sfx/deflect.mp3'></audio>
	<audio id='nightfall' src='sfx/nightfall.mp3'></audio>
	<audio id='collapse' src='sfx/collapse.mp3'></audio>
	<audio id='sellsfx' src='sfx/sell.mp3'></audio>
	<audio id='house' src='sfx/house.mp3'></audio>
	<audio id='cargosfx' src='sfx/cargo.mp3'></audio>
	<audio id='selcity2' src='sfx/selcity2.mp3'></audio>
	<audio id='selcity3' src='sfx/selcity3.mp3'></audio>
	<audio id='fart' src='sfx/fart.mp3'></audio>
	<audio id='fart_short' src='sfx/fart_short.mp3'></audio>
	<audio id='gib' src='sfx/gib.mp3'></audio>
	<audio id='scream' src='sfx/scream.mp3'></audio>
	<audio id='hev' src='sfx/hev.mp3'></audio>
	<audio id='startengine' src='sfx/start_engine.mp3'></audio>
	<audio id='stopengine' src='sfx/stop_engine.mp3'></audio>
	<audio id='strider' src='sfx/strider.mp3'></audio>
	<audio id='cannon_sel' src='sfx/cannon_sel.mp3'></audio>
	<audio id='cannon' src='sfx/cannon.mp3'></audio>
	<audio id='tree' src='sfx/tree.mp3'></audio>
	<audio id='hevend' src='sfx/hevend.mp3'></audio>
	<audio id='sfx' src='sfx/kill.mp3'></audio>
	<audio id='laser' src='sfx/laser.mp3'></audio>
	<audio id='bomb' src='sfx/bomb.mp3'></audio>
	<audio id='satellite_shot' src='sfx/satellite_shot.mp3'></audio>
	<audio id='sfx2' src='sfx/build.mp3'></audio>
	<audio id='capta' src='sfx/capture.mp3'></audio>
	<audio id='captb' src='sfx/capturebad.mp3'></audio>
	<audio id='spawn' src='sfx/spawn.mp3'></audio>
	<audio id='spawn2' src='sfx/spawn2.mp3'></audio>
	<audio id='spawn3' src='sfx/spawn3.mp3'></audio>
	<audio id='trumpet_1' src='sfx/trumpet.mp3'></audio>
	<div id='victory_bigslime'></div>
	<img id="night-filter" src="tiles/night_filter.png">
	<img id="blackscreen0" src="tiles/blackscreen_b.png">
	<img id="blackscreen1" src="tiles/blackscreen1.png">
	<img id="blackscreen2" src="tiles/blackscreen2.png">
	<img id="blackscreen3" src="tiles/blackscreen_b.png">
	<img id="victory_splashscreen" src="tiles/victory_splash1.png">
	<img id="speed2" src="tiles/speed2.png">
	<img id="cash700" src="tiles/cash700.png">
	<img id="cash250" src="tiles/cash250.png">
	<img id="cash400" src="tiles/cash400.png">
	<img id="cash150" src="tiles/cash150.png">
	<img id="cash50" src="tiles/cash50.png">
	<img id="cash100" src="tiles/cash100.png">
	<img id="embark" src="tiles/embark.png">
	<img id="attack" src="tiles/attack.png">
	<img id="radiorange" src="tiles/radiorange.png">
	<img id="speed3" src="tiles/speed3.png">
	<img id="speed4" src="tiles/speed4.png">
	<img id="speed1" src="tiles/speed1.png">
	<img id="napalm_range" src="tiles/napalm_range.png">
	<img id="tankrange" src="tiles/tankrange.png">
	<img id="gunnerange" src="tiles/gunnerange.png">
	<img id="builder-menu" src="tiles/builder_menu.png">
	<div id="margin-left"></div>
	<div id="margin-right"></div>
	<canvas id="canvas"></canvas><br>
	<div id='moneybox'><p id='money'></p><span id='wsymb'>↞</span><span id='wsymb2'>↞</span><span id='wsymb3'>↞</span><span id='wsymb4'>↟</span></div>
	<div id='particle'></div>
  <img id="source" src="tiles/tiles.png"width="595" height="100">
   <div id='selection'></div>
   <div id='buybox'>
   	<div class='upperbuy'>
   		<h3>Fonds possédé : <span id='teambal'></span> 🪙
   		<br><br>villes possédée(s) : <span id='teamcities'></span>
   		<br><br>profits : <span id='profits'></span> 🪙/Tour</h3>
   	</div><br>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='fts-img' src='tiles/fts1/fts1.png'><br>Fantassin
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>150 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➊</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='shield-img' src='tiles/shield1/shield1.png'><br>Paladin
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>200 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➋</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='gunner-img' src='tiles/gunner1/gunner1.png'><br>Sniper
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>250 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➌</span>
   			</div>
   		</div>
   	</div>
   	<br><br><br><br><br><br>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='builder-img' src='tiles/builder1/builder1.png'><br>Architecte
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>50 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➍</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='radio-img' src='tiles/radio1/radio1.png'><br>Opérateur
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>200 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➎</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='tank-img' src='tiles/tank1/tank1.png'><br>Artificier
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>300 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➏</span>
   			</div>
   		</div>
   	</div>
   	<br><br><br><br><br><br>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='seg-img' src='tiles/seg1/seg1.png'><br>Kamikaze
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>200 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➐</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='ninja-img' src='tiles/ninja1/ninja1.png'><br>Ninja
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>200 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➑</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='vtb-img' src='tiles/vtb1/vtb1.png'><br>Transport
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>50 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>➒</span>
   			</div>
   		</div>
   	</div>
   	<br><br><br><br><br><br>
   <div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='trumpet-img' src='tiles/trumpet1/trumpet1.png'><br>Troubadoure
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>300 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>⓪</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='napalm-img' src='tiles/napalm1/napalm1.png'><br>Napalm
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>250 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>Ⓐ</span>
   			</div>
   		</div>
   	</div>
   	<div class='article'>
   		<div class='artleft'>
   			<img class='artimg' id='poison-img' src='tiles/poison1/poison1.png'><br>Toxico
   		</div>
   		<div class='artright'>
   			<div class='artright1'>
   				<span class='price'>200 🪙</span>
   			</div>
   			<div class='artright2'>
   				<span class='number'>Ⓩ</span>
   			</div>
   		</div>
   	</div>
   </div>
</body>
<script>
	//custom map size
	if(screen.width == 1920){
		document.getElementsByTagName('body')[0].style.fontSize = "1.3em"
		document.getElementsByTagName('body')[0].style.zoom = "1.4";
		document.getElementById('buybox').style.left = "200px";
		document.getElementById('night-filter').src = "tiles/night_filter_1920.png";
		document.getElementById('blackscreen0').src = "tiles/blackscreen_b_1920.png";
		document.getElementById('blackscreen3').src = "tiles/blackscreen_b_1920.png";
		document.getElementById('blackscreen1').src = "tiles/blackscreen1_1920.png";
		document.getElementById('blackscreen2').src = "tiles/blackscreen2_1920.png";
	}
	let tiles = [];
	let xtiles = 21;
	let ytiles = 12;
	if($_GET('xtiles') && $_GET('ytiles')){
		xtiles = $_GET('xtiles');
		ytiles = $_GET('ytiles');
	}
	//edition mode for maps
	let editmode = 0;
	if($_GET('edit')){
		editmode = $_GET('edit');
	}

  	//color used for each team
  	let player1 = 1;
  	let player2 = 2;
  	let player3 = "3";
  	if($_GET('player1')){
  		player1 = $_GET('player1');
  	}
  	if($_GET('player2')){
  		player2 = $_GET('player2');
  	}
  	if($_GET('player3')){
  		player3 = $_GET('player3');
  	}

  	// set night mode
  	let isnight = 0;
  	if($_GET('nightmode')){
  		enableShadows = parseInt($_GET('nightmode'));
  		if(enableShadows == 2){
  			isnight = 1;
  		}else{
  			isnight = 0;
  		}
  	}

  	switch(player1){
    	case '1':
			document.getElementsByClassName('upperbuy')[0].style.background = 'deepskyblue';
		break
		case '2':
			document.getElementsByClassName('upperbuy')[0].style.background = 'mediumpurple';
		break
		case '3':
        	document.getElementsByClassName('upperbuy')[0].style.background = 'lawngreen';
        break
		case '4':
			document.getElementsByClassName('upperbuy')[0].style.background = '#CCC';
		break
		case '5':
			document.getElementsByClassName('upperbuy')[0].style.background = 'deeppink';
		break
		case '6':
			document.getElementsByClassName('upperbuy')[0].style.background = 'darkorange';
		break
		case '7':
			document.getElementsByClassName('upperbuy')[0].style.background = '#D00';
		break
   	}
   	let wateranim = 1;
   	let iteration = 0;
   	let loadUnits = [];
   	let loadcannons = [];
   	let memotowerids = [];
   	let poisonmemo = -1;
   	let numidright = false;
   	let numidleft = false;
   	let numidbottom = false;
   	let numidtop = false;
   	let poisonmap = [];
   	let firemap = [];
   	let firemap2 = [];
   	let defaultmode = 1;
   	let leavevtb = false;
   	let villageteam1 = 0;
   	let villageteam2 = 0;
   	let legoteam1 = 0;
   	let legoteam2 = 0;
   	let nextscreen = 0;
   	let content = "";
   	let count = 0;
   	let exlist = [];
   	let shadow = [];
   	let shadowNum = 0;
  	let cityteam2 = "";
	let memo = 0;
	let memofirstpoison = 0;
	let memoposx = 0;
	let memoposy = 0;
	let nightcycle = 0;
	let loadedmap = false;
	let changetoteam = 3;
	let is_ai_on = false;
	let noenter = false;
	let nospace = false;
	let perc4 = 3;
	let infop = 0;
	let toxtiles = [];
	let toxtilesblue = [];
	let toxtilespurple = [];
	let cannonselected = false;
	let turnstotal = 0;
	let turnswind = 1;
	let citiesTeam1 = 0;
	let citiesTeam2 = 0;
	let turn = 1;
	let balanceteam1 = 300;
	let balanceteam2 = 300;
	let woods = [];
	let woodsN = 0;
	let plains = [];
	let plainsN = 0;
	let gasN = 0;
	let poisonN = 0;
	let mountains = [];
	let waters = [];
	let bridges = [];
	let mountainsN = 0;
	let watersN = 0;
	let bridgesN = 0;
	let cities = [];
	let towns = [];
	let cannons = [];
	cannons[0] = {};
	let townteam1 = 0;
	let townteam2 = 0;
	let villageN = 0;
	let villages = [];
	let citiesN = 0;
	let townN = 0;
	let cannonN = 1;
	let currentselection = "";
	let unit = [];
	let cur_uniId = 0;
	let selchar = "none";
	let charlist = [];
	let selposx = 0;
	let selposy = 0;
	let casen = 1;
	let posx = 0;
	let posy = 0;
	let wind = 'left';
	let gas = [];
	let presavebridges = [];
	let selfkill = false;
	let activeCities = citiesTeam1+citiesTeam2;
	var canvas = document.getElementById("canvas");
  	var ctx = canvas.getContext("2d");
  	let screenposy = 0;
   	let screenposx = 0;
	let marginsizex = 0;
	let marginsizey = 0;
  	if(xtiles < 22){
  		marginsizex = (1366-(xtiles*64))/2;
  		canvas.style.left = marginsizex+"px";
  		selposx = marginsizex+"px";
  	}
  	if(ytiles < 13){
		marginsizey = (768-ytiles*64)/2;
  		canvas.style.top = marginsizey+"px";
  		selposy = marginsizey+"px";
  	}
  	var image = document.getElementById("source");
  	var map = document.getElementById("map");
  	document.getElementById('fire').volume = 0.2;
  	document.getElementById('fireball').volume = 0.5;
  	document.getElementsByTagName('body')[0].style.opacity = '1';

	document.getElementsByTagName('html')[0].scrollTop = screenposy;
	document.getElementsByTagName('html')[0].scrollLeft = screenposx;
  	setTimeout(newmap, 100);

  	function loadbiome(){
  		if($_GET('biome') == 0){
  			document.getElementById('blackscreen3').src = "tiles/blackscreen_c.png";
  			if(screen.width == 1920){
				document.getElementsByTagName("body")[0].style.zoom = "1.4";
				document.getElementById('blackscreen0').src = "tiles/blackscreen_c_1920.png"; 
				document.getElementById('blackscreen3').src = "tiles/blackscreen_c_1920.png"; 
			}
  			if(waters.length > 20){
  				river.volume = 0.06;
  				river.play();
  				birds.pause();
  			}else{
  				birds.volume = 0.3;
  				birds.play();
  				river.pause();
  			}
  		}

		if($_GET('biome') == 1){
  			document.getElementById('blackscreen3').src = "tiles/blackscreen_b.png";
  			if(screen.width == 1920){
				document.getElementsByTagName("body")[0].style.zoom = "1.4";
				document.getElementById('blackscreen0').src = "tiles/blackscreen_b_1920.png"; 
				document.getElementById('blackscreen3').src = "tiles/blackscreen_b_1920.png"; 
			}
  			document.getElementById('source').src = "tiles/tiles2.png";
  			document.getElementById('wind').volume = 1;
  			document.getElementById('wind').play();
  		}

  		if($_GET('biome') == 2){
  			document.getElementById('blackscreen3').src = "tiles/blackscreen_a.png";
  			if(screen.width == 1920){
				document.getElementsByTagName("body")[0].style.zoom = "1.4";
				document.getElementById('blackscreen0').src = "tiles/blackscreen_a_1920.png"; 
				document.getElementById('blackscreen3').src = "tiles/blackscreen_a_1920.png"; 
			}
  			document.getElementById('source').src = "tiles/tiles3.png";
  			abyss.volume = 1;
  			abyss.play();
  		}
  	}

  	function gentiles(){
  		//generate tiles according to custom map size
  		var temp = "";
  		var x = 0;
  		var y = 0;
  		document.getElementById('canvas').height = ytiles*64;
  		document.getElementById('canvas').width = xtiles*64;
  		for(x = 0; x < xtiles; x++){
  			for(y = 0; y < ytiles; y++){
  				temp = x+"/"+y;
  				tiles.push(temp);
  			}
  		}
  	}

	function newmap(){
		AI_start();
		citiesTeam1 = 1;
		citiesTeam2 = 1;
		wsymb.style.color = 'white';
		wsymb2.style.color = 'grey';
		wsymb3.style.color = 'white';
		wsymb4.style.color = 'grey';
		updatemoney();
		document.getElementById('moneybox').style.display = 'none';
		// select each map position and apply a random tile to it
		posx = -1;
		posy = 0;
		//load temp save
		if($_GET("content")){
			content = $_GET("content");
			content = content.replaceAll('%22', '"');
			eval(content);
			drawFromSave();

			//drawFromSave();
		}else if($_GET('map')){
			//load mapfile
			var map = $_GET('map');
			importJs('maps/'+map);
		}else{
			//generate new map
			gentiles();
			var thislength = tiles.length/2-1;
			for(i=0; i <= thislength; i++){
				posx++;
				random(posx, posy);
				if(posx == xtiles-1){
					posy++;
					posx = -1;
				}
			}
			if(cities[0]){
				cities[0].team = 1;
			}else{
				newmap();
				return
			}
			mirroring();
		}
	}

	function istowermap(coord, team){
		if(team == 1){
			var ennemyteam = 2;
		}else if(team == 2){
			var ennemyteam = 1;
		}
		if(istowerange(ennemyteam,coord) !== false){
			var posx = coord.substr(0, coord.indexOf('/') );
      		var posy = coord.substr(coord.indexOf('/')+1, coord.length);
			var unitid = isunit(posx,posy);
			for(w=0; w < memotowerids.length; w++){
				shielding(unitid, memotowerids[w]);
			}
		}
	}

	function istowerange(team,coord){
		memotowerids = [];
		for(i=0; i < unit.length; i++){
			if(unit[i].type == "tower" && unit[i].team == team && unit[i].playable == true){
				for(z=0; z < unit[i].rangemap.length; z++){
					if(unit[i].rangemap[z] == coord){
						memotowerids.push(i);
					}
				}
			}
		}
		if(memotowerids){
			return memotowerids;
		}else{
			return false
		}
	}

	function setpoison(x,y,team,temp,retry,loadsize){
		if(Number(x) > Number(xtiles) || Number(y) > Number(ytiles)){
			return
		}
		var thisunit = unit[isunit(x,y,true)];
		if(iscity(x+"/"+y, false) || isvillage(x+"/"+y) || iscannon(x+"/"+y) || ismountain(x+"/"+y) || isfire(x,y) || iswater(x+"/"+y)){
			//nothing
		}else if(thisunit){
			if(thisunit.type != "tower"){
				if(ispoison(x,y)){
					if(poisonmap[poisonmemo].id){
						poisonmap[poisonmemo].team = team;
						poisonmap[poisonmemo].leftturns = 3;
						poisonhide();
					}
				}else{
					poisonmap[poisonN] = new poison(x,y,team,temp,loadsize);
					poisonmap[poisonN].spawn();
					poisonN++;
					if(retry){
						poisonturninfection();
					}
				}
			}
		}else{
			if(ispoison(x,y)){
				if(poisonmap[poisonmemo].id){
					poisonmap[poisonmemo].team = team;
					poisonmap[poisonmemo].leftturns = 3;
					if(retry){
						poisonturninfection();
					}
					poisonhide();
				}
			}else{
				poisonmap[poisonN] = new poison(x,y,team,temp,loadsize);
				poisonmap[poisonN].spawn();
				poisonN++;
				if(retry){
					poisonturninfection();
				}
			}
		}
	}

	function setfire(x,y,explosion){
		if(iswood(x+"/"+y)){
			firemap.push(x+"/"+y);
			casen = 8;
			draw(x,y);
			document.getElementById('fire').play();
			document.getElementById('fireball').play();
		}else if(isplain(x+"/"+y)){
			if(unit[isunit(x,y)]){
				if(unit[isunit(x,y)].type != 'tower'){
					firemap.push(x+"/"+y);
					casen = 8;
					draw(x,y);
					document.getElementById('fire').play();
					document.getElementById('fireball').play();
				}
			}else{
				firemap.push(x+"/"+y);
				casen = 8;
				draw(x,y);
				document.getElementById('fire').play();
				document.getElementById('fireball').play();
			}
		}else if(isbridge(x+"/"+y)){
			firemap.push(x+"/"+y);
			casen = 11;
			draw(x,y);
			document.getElementById('fire').play();
			document.getElementById('fireball').play();
		}
		if(unit[isunit(x,y)] && explosion){
			unit[isunit(x,y)].die();
		}
		if(isnight == 1 && enableShadows > 0){
			shadowExList();
		}
	}

	function barbecuetime(){
		var positionx = 0;
		var positiony = 0;
		var newpx = 0;
		var newpy = 0;
		var max = firemap.length;
		var remfire = [];
		
		//delete last turn's firemap2
		for(o=0; o < firemap2.length; o++){
			firemap2.shift();
		}

		for(o=0; o < max; o++){
			positionx = firemap[o].substr(0, firemap[o].indexOf('/') );
      		positiony = firemap[o].substr(firemap[o].indexOf('/')+1, firemap[o].length);

      		if(isbridge(positionx+"/"+positiony) || iswater(positionx+"/"+positiony)){
      			ctx.drawImage(image, 2673, 0, 99, 100, positionx*64, positiony*64, 64, 64);
      		}else{
	      		ctx.drawImage(image, 0, 0, 99, 100, positionx*64, positiony*64, 64, 64);
      		}
      		//iswood right
      		newpx = parseInt(positionx)+1;
      		newpy = positiony;
			if(iswood(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdwood(newpx, newpy);
				casen = 1;
				draw(newpx, newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge right
			if(isbridge(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdbridge(newpx, newpy);
				casen = 9;
				draw(newpx, newpy);
				casen = 11;
				draw(newpx, newpy);
			}

			//iswood left
      		newpx = parseInt(positionx)-1;
      		newpy = positiony;
			if(iswood(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdwood(newpx, newpy);
				casen = 1;
				draw(newpx, newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge left
			if(isbridge(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdbridge(newpx, newpy);
				casen = 9;
				draw(newpx, newpy);
				casen = 11;
				draw(newpx, newpy);
			}

			//iswood bottom
      		newpx = positionx;
      		newpy = parseInt(positiony)+1;
			if(iswood(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdwood(newpx, newpy);
				casen = 1;
				draw(newpx, newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge bottom
			if(isbridge(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdbridge(newpx, newpy);
				casen = 9;
				draw(newpx, newpy);
				casen = 11;
				draw(newpx, newpy);
			}

			//iswood top
      		newpx = positionx;
      		newpy = parseInt(positiony)-1;
			if(iswood(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdwood(newpx, newpy);
				casen = 1;
				draw(newpx, newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge top
			if(isbridge(newpx+"/"+newpy)){
				firemap.push(newpx+"/"+newpy);
				sdbridge(newpx, newpy);
				casen = 9;
				draw(newpx, newpy);
				casen = 11;
				draw(newpx, newpy);
			}
		}

		//new firemap2
		var index = 0;
		var thisdelete = 0;
		for(o=0; o < firemap.length; o++){
			positionx = firemap[o].substr(0, firemap[o].indexOf('/') );
      		positiony = firemap[o].substr(firemap[o].indexOf('/')+1, firemap[o].length);
      		
      		//iswood right
      		newpx = parseInt(positionx)+1;
      		newpy = positiony;
			if(iswood(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge right
			if(isbridge(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 11;
				draw(newpx, newpy);
			}

			//iswood left
      		newpx = parseInt(positionx)-1;
      		newpy = positiony;
			if(iswood(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge left
			if(isbridge(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 11;
				draw(newpx, newpy);
			}

			//iswood bottom
      		newpx = positionx;
      		newpy = parseInt(positiony)+1;
			if(iswood(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge bottom
			if(isbridge(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 11;
				draw(newpx, newpy);
			}

			//iswood top
      		newpx = positionx;
      		newpy = parseInt(positiony)-1;
			if(iswood(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 8;
				draw(newpx, newpy);
			}

			//isbridge top
			if(isbridge(newpx+"/"+newpy)){
				firemap2.push(newpx+"/"+newpy);
				casen = 11;
				draw(newpx, newpy);
			}
		}

		for(o=0; o < firemap2.length; o++){
			if(firemap2[o] == firemap2[o+1]){
				index = firemap2.indexOf(firemap2[o]);
				thisdelete = firemap2.splice(index, 1);
			}
			for(b=0; b < firemap.length; b++){
				if(firemap[b] == firemap2[o]){
					index = firemap2.indexOf(firemap2[o]);
					thisdelete = firemap2.splice(index, 1);
				}
			}
		}

		for(o=0; o < max; o++){
			firemap.shift();
		}
		
		if(firemap.length == 0){
			for(o=0; o < firemap2.length ;o++){
				firemap2.shift();
			}
			document.getElementById('fire').pause();
			if(isnight == 1 && enableShadows > 0){
				shadowExList();
			}
		
		}else{
			document.getElementById('fireball').currentTime = 0;
			document.getElementById('fireball').play();
			if(isnight == 1 && enableShadows > 0){
				shadowExList();
			}
		}
		firekill();
		firepoison();
	}

	function firekill(){
		for(i=0; i < unit.length; i++){
			for(b=0; b < firemap.length; b++){
				positionx = firemap[b].substr(0, firemap[b].indexOf('/') );
      			positiony = firemap[b].substr(firemap[b].indexOf('/')+1, firemap[b].length);
				if(unit[i]){
					if(isfire(unit[i].posx, unit[i].posy)){
						firekill2(unit[i]);
					}
				}
			}
		}
	}

	//tente d'infecter un slime spécifique
	function tryinfect(thispoison, thisunit, turns){
		if(poisonmap[thispoison].team != thisunit.team && thisunit.infected == false && thisunit.team != 3){
			thisunit.infected = turns;
		}
	}

	//tente l'infection depuis toutes cases poison
	function poisonturninfection(first){
		for(let i=0; i < poisonmap.length; i++){
			if(poisonmap[i].posx){
				for(b=0; b < unit.length; b++){
					if(b != memofirstpoison){
      					if(unit[b]){
							if(poisonmap[i].posx == unit[b].posx && poisonmap[i].posy == unit[b].posy){
								tryinfect(i, unit[b], 4);
      						}
      						if(unit[b].infected >= 1){
      							if(first == true){
      								var thisposx = selposx;
									var thisposy = selposy;
      							}else{
      								var thisposx = unit[b].posx;
									var thisposy = unit[b].posy;
      							}
      							if(unit[b].team == 1){
									var _team = 2;
								}else{
									var _team = 1;
								}
							setpoison(Number(thisposx)+1, Number(thisposy), _team, 3, false, 0);
      						setpoison(Number(thisposx)-1, Number(thisposy), _team, 3, false, 0);
      						setpoison(Number(thisposx), Number(thisposy)-1, _team, 3, false, 0);
      						setpoison(Number(thisposx), Number(thisposy)+1, _team, 3, false, 0);
      						setpoison(Number(thisposx), Number(thisposy), _team, 3, true, 0);
      						}
						}
					}
				}
			}
		}
	}

	//détérioration du poison au sol
	function poisoncycle(){
		for(i=0; i < poisonmap.length; i++){
			if(poisonmap[i]){
				if(poisonmap[i].leftturns != false){
					if(poisonmap[i].leftturns == 1){
						poisonmap[i].die();
					}else{
						poisonmap[i].leftturns--;
					}
				}
			}
		}
	}

	//progression de l'infection chez les slimes infectés
	function poisonprogress(){
		for(let i=0; i < unit.length; i++){
			if(unit[i].infected){
				if(unit[i].infected != false){
					unit[i].infected--;
					if(unit[i].infected == 1){
						var _unit = unit;
						if(unit[i].type == 'vtb' && unit[i].unitinside != 0){
							unit[i].unitinside.die();
						}else if(unit[i].vtb != -1){
							unit[unit[i].vtb].unitinside = 0;
							unit[unit[i].vtb].delcargo();
						}
						if(unit[i].cannon != -1){
							cannons[unit[i].cannon].unitinside = 0;
							cannons[unit[i].cannon].delcargo();
						}
						setTimeout(function(){unit[i].die()}, 500);
						bgm.volume = 0.1;
						document.getElementById("oof").play();
						setTimeout(function(){bgm.volume = 0.2}, 2000);
					}
				}
			}
		}
	}

	function firepoison(){
		for(i=0; i < firemap.length; i++){
			for(b=0; b < poisonmap.length; b++){
				positionx = firemap[i].substr(0, firemap[i].indexOf('/') );
      			positiony = firemap[i].substr(firemap[i].indexOf('/')+1, firemap[i].length);
      			if(poisonmap[b]){
					if(poisonmap[b].posx == positionx && poisonmap[b].posy == positiony){
						poisonmap[b].die();
      				}
				}
			}
		}
	}

	function firekill2(thisunit){
		if(thisunit){
			if(thisunit.type == 'vtb' && thisunit.unitinside != false){
				thisunit.unitinside.die();
			}
			if(thisunit.type == 'seg'){
				thisunit.fart2();
			}
			noenter = true;
			if(thisunit){
				setTimeout(function(){noenter = false; eval(thisunit.die());document.getElementById('gib').play();}, 500);
			}
		}
	}

	function sidekill(basex, basey, team){
		var tempx = basex;
		var tempy = basey;
	    slash.currentTime = 0;

		//right
		tempx = Number(basex)+1;
		numidright = isunit(tempx, tempy, true);
		if(numidright != false || numidright === 0){
			if(unit[numidright].team != team && unit[numidright].type != 'tower'){
				if(eval(unit[numidright]).type == 'seg'){
	      			setTimeout(function(){unit[numidright].fart2();slash.play()}, 1000);
	      		}else{
					setTimeout(function(){unit[numidright].die();sfx.currentTime = 0;sfx.play();slash.play()}, 1000);
	      		}
			}
		}

		//left
		tempx = Number(basex)-1;
		numidleft = isunit(tempx, tempy, true);
		if(numidleft != false || numidleft === 0){
			if(unit[numidleft].team != team && unit[numidleft].type != 'tower'){
				if(eval(unit[numidleft]).type == 'seg'){
	      			setTimeout(function(){unit[numidleft].fart2();slash.play()}, 1000);
	      		}else{
					setTimeout(function(){unit[numidleft].die();sfx.currentTime = 0;sfx.play();slash.play()}, 1000);
	      		}
			}
		}

		//bottom
		tempy = Number(basey)+1;
		tempx = basex;
		numidbottom = isunit(tempx, tempy, true);
		if(numidbottom != false || numidbottom === 0){
			if(unit[numidbottom].team != team && unit[numidbottom].type != 'tower'){
				if(eval(unit[numidbottom]).type == 'seg'){
	      			setTimeout(function(){unit[numidbottom].fart2();slash.play()}, 1000);
	      		}else{
					setTimeout(function(){unit[numidbottom].die();sfx.currentTime = 0;sfx.play();slash.play()}, 1000);
	      		}
			}
		}

		//top
		tempy = Number(basey)-1;
		numidtop = isunit(tempx, tempy, true);
		if(numidtop != false || numidtop === 0){
			if(unit[numidtop].team != team && unit[numidtop].type != 'tower'){
				if(eval(unit[numidtop]).type == 'seg'){
	      			setTimeout(function(){unit[numidtop].fart2();slash.play()}, 1000);
	      		}else{
					setTimeout(function(){unit[numidtop].die();sfx.currentTime = 0;sfx.play();slash.play()}, 1000);
	      		}
			}
		}
	}

	function citySharing(n){
			var citycoord = iscity2(n);
			cities[citycoord].team = 2;
			if(player1 == 1){
				ctx.drawImage(image, 297, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}else if(player1 == 2){
				ctx.drawImage(image, 792, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}else if(player1 == 3){
				ctx.drawImage(image, 2476, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}else if(player1 == 4){
				ctx.drawImage(image, 892, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}else if(player1 == 5){
				ctx.drawImage(image, 1089, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}else if(player1 == 6){
				ctx.drawImage(image, 1386, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}else if(player1 == 7){
				ctx.drawImage(image, 1485, 0, 99, 100, cities[0].posx*64, cities[0].posy*64, 64, 64);
			}

			if(player2 == 1){
				ctx.drawImage(image, 297, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}else if(player2 == 2){
				ctx.drawImage(image, 792, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}else if(player2 == 3){
				ctx.drawImage(image, 2476, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}else if(player2 == 4){
				ctx.drawImage(image, 892, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}else if(player2 == 5){
				ctx.drawImage(image, 1089, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}else if(player2 == 6){
				ctx.drawImage(image, 1386, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}else if(player2 == 7){
				ctx.drawImage(image, 1485, 0, 99, 100, cities[citycoord].posx*64, cities[citycoord].posy*64, 64, 64);
			}
	}

	function random(x,y){
		//select a random tile and draw it at x,y position
		var perc1 = 40;
		var perc2 = 60;
		var perc3 = 96;
		var perc4 = 99;
		if($_GET('p')){
			//plain
			perc1 = $_GET('p');
		}
		if($_GET('w')){
			//wood
			perc2 = $_GET('w');
		}
		if($_GET('m')){
			//mountain
			perc3 = $_GET('m');
		}
		if($_GET('c')){
			//city
			perc4 = $_GET('c');
		}
		var tile = Math.floor(Math.random()*100)+1;
		if(tile <= perc1){
			//plain
			casen = 1;
		}else if(tile <= perc2){
			//wood
			casen = 2;
		}else if(tile <= perc3){
			//mountain
			casen = 3;
		}else if(tile <= perc4){
			//city
			casen = 4;
		}else{
			//village
			casen = 7;
		}
		draw(x, y);
	}

	function mirroring(){
		posx = -1;
		posy = 0;
		var newtile_posx = xtiles;
		var newtile_posy = ytiles-1;
		var check = "none";
		var thislength = tiles.length/2;
		for(i=0; i < thislength; i++){
			posx++;
			newtile_posx--;
			check = checktile(posx+"/"+posy);
			switch(check){
				case 'plain':
				casen = 1;
				break

				case 'wood':
				casen = 2;
				break

				case 'mountain':
				casen = 3;
				break

				case 'village':
				casen = 7;
				break

				case 'water':
				casen = 9;
				break

				case 'bridge':
				casen = 10;
				break

				case 1:
				cityteam2 = newtile_posx+"/"+newtile_posy;
				case 3:
				casen = 4;
				break
			}
			draw(newtile_posx, newtile_posy);

			if(posx == xtiles-1){
				posy++;
				posx = -1;
				newtile_posy--;
				newtile_posx = xtiles;
			}
		}
		citySharing(cityteam2);
		turn = 2;
		resetselection()
		turn = 1;
	}

	function draw(x,y,q){
		//draw a tile at x,y position
		x = x*64;
		y = y*64;
		switch(casen){
			case 1:
				var selgrass = Math.floor(Math.random()*3);
				if(selgrass == 0){
					ctx.drawImage(image, 3960, 0, 99, 100, x, y, 64, 64);
				}else if(selgrass == 1){
					ctx.drawImage(image, 3861, 0, 99, 100, x, y, 64, 64);
				}else{
					ctx.drawImage(image, 0, 0, 99, 100, x, y, 64, 64);					
				}
				newplace("plain",x/64,y/64);
			break

			case 2:
				var seltree = Math.floor(Math.random()*2);
				if(seltree == 0){
					ctx.drawImage(image, 594, 0, 99, 100, x, y, 64, 64);
					newplace("wood",x/64,y/64);
				}else{
					ctx.drawImage(image, 100, 0, 99, 100, x, y, 64, 64);
					newplace("wood",x/64,y/64);
				}
			break

			case 3:
				ctx.drawImage(image, 198, 0, 99, 100, x, y, 64, 64);
				newplace("mountain",x/64,y/64,0);
			break

			case 4:
				if(editmode == 1){
					if(player1 == 1){
						ctx.drawImage(image, 297, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 2){
						ctx.drawImage(image, 792, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 3){
						ctx.drawImage(image, 2476, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 4){
						ctx.drawImage(image, 892, 0, 99, 100, x, y, 64, 64);
      				}else if(player1 == 5){
						ctx.drawImage(image, 1089, 0, 99, 100, x, y, 64, 64);
      				}else if(player1 == 6){
						ctx.drawImage(image, 1386, 0, 99, 100, x, y, 64, 64);
      				}else if(player1 == 7){
						ctx.drawImage(image, 1485, 0, 99, 100, x, y, 64, 64);
      				}
				}else{	
					ctx.drawImage(image, 396, 0, 99, 100, x, y, 64, 64);
				}
				newplace("city",x/64,y/64);
			break

			case 5:
				sdplain(eval(selchar).posx, eval(selchar).posy);

				if(eval(selchar).team == 1){
					if(player1 == 1){
						//blue
						ctx.drawImage(image, 693, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 2){
						//black
						ctx.drawImage(image, 495, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 3){
						//green
						ctx.drawImage(image, 2575, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 4){
						//white
						ctx.drawImage(image, 990, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 5){
						//pink
						ctx.drawImage(image, 1188, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 6){
						//yellow
						ctx.drawImage(image, 1287, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 7){
						//red
						ctx.drawImage(image, 1584, 0, 99, 100, x, y, 64, 64);
					}
					townteam1++;			
				}else{
					if(player2 == 1){
						//blue
						ctx.drawImage(image, 693, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 2){
						//black
						ctx.drawImage(image, 495, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 3){
						//green
						ctx.drawImage(image, 2575, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 4){
						//white
						ctx.drawImage(image, 990, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 5){
						//pink
						ctx.drawImage(image, 1188, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 6){
						//yellow
						ctx.drawImage(image, 1287, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 7){
						//red
						ctx.drawImage(image, 1584, 0, 99, 100, x, y, 64, 64);
					}
					townteam2++;	
				}
				newplace("town",x/64,y/64, q);
				bgm.volume = 0.1;
				document.getElementById('town').play();
				setTimeout(function(){bgm.volume=1}, 840);
			break

			case 6:
				sdplain(eval(selchar).posx, eval(selchar).posy);

				if(eval(selchar).team == 1){
					if(player1 == 1){
						//blue
						ctx.drawImage(image, 2970, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 2){
						//black
						ctx.drawImage(image, 3069, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 3){
						//green
						ctx.drawImage(image, 3168, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 4){
						//white
						ctx.drawImage(image, 3267, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 5){
						//pink
						ctx.drawImage(image, 3366, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 6){
						//yellow
						ctx.drawImage(image, 3465, 0, 99, 100, x, y, 64, 64);
					}else if(player1 == 7){
						//red
						ctx.drawImage(image, 3564, 0, 99, 100, x, y, 64, 64);
					}			
				}else{
					if(player2 == 1){
						//blue
						ctx.drawImage(image, 2970, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 2){
						//black
						ctx.drawImage(image, 3069, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 3){
						//green
						ctx.drawImage(image, 3168, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 4){
						//white
						ctx.drawImage(image, 3267, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 5){
						//pink
						ctx.drawImage(image, 3366, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 6){
						//yellow
						ctx.drawImage(image, 3465, 0, 99, 100, x, y, 64, 64);
					}else if(player2 == 7){
						//red
						ctx.drawImage(image, 3564, 0, 99, 100, x, y, 64, 64);
					}	
				}
				newplace("cannon",x/64,y/64,q);
				bgm.volume = 0.1;
				setTimeout(function(){bgm.volume=1}, 840);
			break

			case 7:
				switch(player3){
					case '1':
					ctx.drawImage(image, 1783, 0, 99, 100, x, y, 64, 64);
					break

					case '2':
					ctx.drawImage(image, 1882, 0, 99, 100, x, y, 64, 64);
					break

					case '3':
					ctx.drawImage(image, 1684, 0, 99, 100, x, y, 64, 64);
					break

					case '4':
					ctx.drawImage(image, 1981, 0, 99, 100, x, y, 64, 64);
					break

					case '5':
					ctx.drawImage(image, 2080, 0, 99, 100, x, y, 64, 64);
					break

					case '6':
					ctx.drawImage(image, 2179, 0, 99, 100, x, y, 64, 64);
					break

					case '7':
					ctx.drawImage(image, 2278, 0, 99, 100, x, y, 64, 64);
					break
				}
				newplace("village",x/64,y/64);
			break

			case 8:
			ctx.drawImage(image, 2377, 0, 99, 100, x, y, 64, 64);
			break

			case 9:
			ctx.drawImage(image, 2673, 0, 99, 100, x, y, 64, 64);
			newplace("water",x/64,y/64);
			break

			case 10:
			ctx.drawImage(image, 2772, 0, 99, 100, x, y, 64, 64);
			newplace("bridge",x/64,y/64);
			break

			case 11:
			ctx.drawImage(image, 2871, 0, 99, 100, x, y, 64, 64);
			break
		}
	}

	document.onkeydown = checkKey;

function checkKey(e) {

    e = e || window.event;

	if (e.keyCode == '164'){
		// $
        if(infop == 0){
        	moneybox.style.right = '89.8vw';
        	infop = 1;
        }else{
        	moneybox.style.right = 0;
        	infop = 0;
        }
    }	

    if(e.keyCode == '32'){
        // spacebar
        if(nospace == true){
        	return
        }
        toxtiles = [];
        toxtilesblue = [];
        toxtilespurple = [];
        if(nextscreen == 1){
        	nextscreen = 0;
        	document.getElementById('blackscreen0').style.opacity = "0";
        	isgasexplosion();
        	nextturn();
	        windupdate();
	        tempsave();
    	}else{
        	nextscreen = 1;
        	document.getElementById('blackscreen0').style.opacity = "1";
        	if(turn == 1){
				document.getElementById('blackscreen2').style.opacity = "1";
        	}else{
				document.getElementById('blackscreen1').style.opacity = "1";
        	}
			bgm.pause();
    	}
    }

    if (e.keyCode == '121'){
        // F10
        e.preventDefault();
        if(editmode == 0){
        	editmode = 1;
        	alert('édition de carte activé !');
        }else{
        	editmode = 0;
        	alert('édition de carte désactivé !');
        }
    }

    if (e.keyCode == '123'){
        // F12
        e.preventDefault();
        if(editmode == 1){
        	exportmap();
        }
    }

    if (e.keyCode == '27'){
        // ESC
        e.preventDefault();
        window.location = 'menu.html';
    }

    if (e.keyCode == '112'){
        // F1
        e.preventDefault();
        if(editmode == 1){
        	changetoplain();
        }
    }

    if (e.keyCode == '113'){
        // F2
        e.preventDefault();
        if(editmode == 1){
    	    changetowood();
    	}
    }

    if (e.keyCode == '114'){
        // F3
        e.preventDefault();
        if(editmode == 1){
        	changetomount();
    	}
    }

    if (e.keyCode == '115'){
        // F4
        e.preventDefault();
        if(editmode == 1){
 	       changetocity();
    	}
    }

    if (e.keyCode == '116'){
        // F5
        if(editmode == 1){
    	    e.preventDefault();
    		changetovillage();
    	}
    }

    if (e.keyCode == '118'){
        // F7
        if(editmode == 1){
    	    e.preventDefault();
    		changetowater();
    	}
    }

    if (e.keyCode == '119'){
        // F8
        if(editmode == 1){
    	    e.preventDefault();
    		changetobridge();
    	}
    }

    if (e.keyCode == '222'){
        //²
    	e.preventDefault();
    	if(isnight == 0){
	    	var base_url = window.location.href.split("&content=");
	    	location.href = base_url[0]+"&content="+content;    		
    	}
    }

    if (e.keyCode == '49') {
        // 1
        event.preventDefault();
        if(selchar != 'none'){
        	if(eval(selchar).type == 'seg'){
        		eval(selchar).fart();
        	}else if(eval(selchar).type == 'builder'){
        		for(x=0; x < plains.length; x++){
        		if(plains[x]){
      				if(currentselection == plains[x].posx+"/"+plains[x].posy){
      					var thisteamlego = eval('legoteam'+eval(selchar).team);
      					if(thisteamlego < 4){
							alert("points de construction insufisants !");
							return
						}else{
							if(eval(selchar).team == 1){
								legoteam1 = thisteamlego-4;
							}else{
								legoteam2 = thisteamlego-4;
							}
        					eval(selchar).build(2);
        					selchar = "none";
        					resetvisual();
							updatemoney();
      						if(isnight == 1 && enableShadows > 0){
      							shadowExList();
      						}
      							return
							}
      					}
      				}
        		}
        	}
        }else{
        	keypress(1);
        }
    }

    if (e.keyCode == '50') {
        // 2
        event.preventDefault();
        if(selchar != 'none'){
        	if(eval(selchar).type == 'builder'){
        		for(x=0; x < plains.length; x++){
        		if(plains[x]){
      				if(currentselection == plains[x].posx+"/"+plains[x].posy){
      					//check if enough legos
      					if(turn == 1){
      						var thisteamlego = legoteam1;
      					}else{
      						var thisteamlego = legoteam2;
      					}	
      					if(thisteamlego < 5){
							alert("points de construction insufisants !");
      						return
      					}
      					//end of check section

      					if(turn == 1){
      						if(villageteam1 <= townteam1){
								alert("nombre de villages insufisants !");
        						selchar = "none";
								return
      						}
						}else{
							if(villageteam2 <= townteam2){
								alert("nombre de villages insufisants !");
		        				selchar = "none";
								return
      						}
						}
						if(turn == 1){
      						legoteam1 = legoteam1 - 5;
      					}else{
      						legoteam2 = legoteam2 - 5;
      					}
        				buildtown();
        				selchar = "none";
        				resetvisual();
						updatemoney();
      					if(isnight == 1 && enableShadows > 0){
      						shadowExList();
      					}
      					return
      					}
      				}
        		}
        	}
        }else{
    	    keypress(2);
    	}
	}

    if (e.keyCode == '51') {
        // 3
        event.preventDefault();
        if(selchar != 'none'){
        	if(eval(selchar).type == 'builder'){
        		for(x=0; x < plains.length; x++){
        			if(plains[x]){
      					if(currentselection == plains[x].posx+"/"+plains[x].posy){
      						var thisteamlego = eval('legoteam'+eval(selchar).team);
      						if(thisteamlego < 10){
								alert("points de construction insufisants !");
								return
							}else{
								if(eval(selchar).team == 1){
									legoteam1 = thisteamlego-10;
								}else{
									legoteam2 = thisteamlego-10;
								}
							}
        					buildcity();
        					selchar = "none";
        					resetvisual();
							updatemoney();
      						if(isnight == 1 && enableShadows > 0){
      							shadowExList();
      						}
      						return
	      				}
	      			}
	        	}
    	    }
    	}else{
    		keypress(3);
    	}
    }

    if (e.keyCode == '52') {
        // 4
        event.preventDefault();
        if(selchar != 'none'){
        	if(eval(selchar).type == 'builder'){
        		for(x=0; x < plains.length; x++){
        			if(plains[x]){
      					if(currentselection == plains[x].posx+"/"+plains[x].posy){
      						var thisteamlego = eval('legoteam'+eval(selchar).team);
      						if(thisteamlego < 5){
								alert("points de construction insufisants !");
								return
							}else{
								if(eval(selchar).team == 1){
									legoteam1 = thisteamlego-5;
								}else{
									legoteam2 = thisteamlego-5;
								}
							}
        					buildvillage();
        					selchar = "none";
        					resetvisual();
							updatemoney();
      						if(isnight == 1 && enableShadows > 0){
      							shadowExList();
      						}
      						return
	      				}
	      			}
	        	}
    	    }
    	}else{
    	    keypress(4);
    	}
    }

    if (e.keyCode == '53') {
        // 5
        event.preventDefault();
        if(selchar != 'none'){
        	if(eval(selchar).type == 'builder'){
        		for(x=0; x < plains.length; x++){
        			if(plains[x]){
      					if(currentselection == plains[x].posx+"/"+plains[x].posy){
      						var thisteamlego = eval('legoteam'+eval(selchar).team);
      						if(thisteamlego < 10){
								alert("points de construction insufisants !");
								return
							}else{
								if(eval(selchar).team == 1){
									legoteam1 = thisteamlego-10;
								}else{
									legoteam2 = thisteamlego-10;
								}
							}
        					buildcannon();
        					selchar = "none";
        					resetvisual();
							updatemoney();
      						if(isnight == 1 && enableShadows > 0){
      							shadowExList();
      						}
      						return
	      				}
	      			}
	        	}
    	    }
    	}else{
        	keypress(5);
    	}
    }

    if (e.keyCode == '54') {
        // 6
        event.preventDefault();
        keypress(6);
    }

    if (e.keyCode == '55') {
        // 7
        event.preventDefault();
        keypress(7);
    }

    if (e.keyCode == '56') {
        // 8
        event.preventDefault();
        keypress(8);
    }

    if (e.keyCode == '57') {
        // 9
        event.preventDefault();
        keypress(9);
    }

    if (e.keyCode == '48') {
        // 0
        event.preventDefault();
        if(selchar != 'none'){
        	isembark();
        }else{
	        keypress(0);
        }
    }

    if (e.keyCode == '65') {
        // a
        event.preventDefault();
        keypress('a');
    }

    if (e.keyCode == '90') {
        // z
        event.preventDefault();
        keypress('z');
    }

    if ((e.keyCode == '8') || (e.keyCode == '117')) {
        // backspace
        event.preventDefault();
        if(document.getElementById('moneybox').style.display == 'none')
        {
        	document.getElementById('moneybox').style.display = 'block';
        	setTimeout(function(){document.getElementById('moneybox').style.opacity = '0.9'}, 100);

        	setTimeout(function(){document.getElementById('moneybox').style.opacity = '0';}, 6000)
        	setTimeout(function(){document.getElementById('moneybox').style.display = 'none';}, 7000)
        }
        
    }

    if (e.keyCode == '38') {
        // up arrow
        event.preventDefault();
        changetoteam = 3;
        if(selposy != 0){
  			selposy = selposy - 1;
        	movescreen('up');
  			document.getElementById('selection').style.top = (selposy*64)+marginsizey+'px';
  		}
    }
    else if (e.keyCode == '40') {
        // down arrow
        event.preventDefault();
        changetoteam = 3;
        if(selposy != ytiles-1){
  			selposy = selposy + 1;
        	movescreen('down');
  			document.getElementById('selection').style.top = (selposy*64)+marginsizey+'px';
  		}
    }
    else if (e.keyCode == '37') {
    	// left arrow
		event.preventDefault();
    	changetoteam = 3;
		if(selposx != 0){
  			selposx = selposx - 1;
	    	movescreen('left');
  			document.getElementById('selection').style.left = (selposx*64)+marginsizex+'px';
  		}
    }
    else if (e.keyCode == '39') {
       // right arrow
      	event.preventDefault();
      	changetoteam = 3;
      	if(selposx != xtiles-1){
  			selposx = selposx + 1;
      		movescreen('right');
  			document.getElementById('selection').style.left = (selposx*64)+marginsizex+'px';
  		}
  	}

  	if (e.keyCode == '160') {
        // ^ key
        event.preventDefault();
        if(bgm.paused){
        	bgm.play();
        }else{
        	bgm.pause();
        }
    }

  	else if (e.keyCode == '13') {
  		// enter key
  		if(noenter == true){
  			return
  		}

      	event.preventDefault();

      	if(currentselection == selposx+"/"+selposy && cannonselected){
      		cannon_sel.pause();
      		cannon_sel.currentTime = 0;
      		bgm.volume = 0.2;
			currentselection = "";
			document.getElementById('selection').style.background = 'black';
			cannonselected = false;
			resetvisual();
			return
      	}

      	if(document.getElementById('buybox').style.zIndex == 999){
      		document.getElementById('buybox').style.zIndex = -1;
      		selcity1.pause();
      		selcity1.currentTime = 0;
      		selcity2.pause();
      		selcity2.currentTime = 0;
      		selcity3.pause();
      		selcity3.currentTime = 0;
      		bgm.volume = 0.2;
			document.getElementById('selection').style.background = 'black';
			currentselection = "";
      		return
      	}

      	currentselection = selposx+"/"+selposy;
      	if(selchar == "none"){
      		for(x=0; x <= charlist.length-1; x++){
      			//check coords of each existing char
      			if(currentselection == getcharpos(eval(charlist[x]))){
      				if(cannonselected){
      					if(eval(charlist[x]).type == "tower"){
      						document.getElementById('selection').style.background = 'black';
      						cannon_sel.currentTime = 0;
      						cannon_sel.pause();
      						bgm.volume = 0.2;
      						cannonselected = false;
      						resetvisual();
      						return
      					}else{
      						if(cannons[cannonselected].unitinside){
      							eval(charlist[x]).die();
		    	  				sfx.play();
      						}
      						cannons[cannonselected].outcannon();
	      					cannon.currentTime = 0;
	      					document.getElementById("cannon").play();
	      					cycletowers();
	      					resetvisual();
      						cannon_sel.pause();
      						cannonselected = false;
    			  			cannon_sel.currentTime = 0;
    			  			bgm.volume = 0.1;
		    	  			setTimeout(function(){bgm.volume = 0.2}, 1000);
      					}
      				}
      				//if a character coords match
      				if(eval(charlist[x]).playable == true && eval(charlist[x]).team == turn){
      					selchar = charlist[x];
      					switch(eval(charlist[x]).type){
      						case 'builder':
      						document.getElementById('speed2').style.top = ((selposy-2)*64)+marginsizey+"px";
      						document.getElementById('speed2').style.left = ((selposx-2)*64)+marginsizex+"px";
      						document.getElementById('builder-menu').style.left = 522+"px";
      						if(eval(selchar).posy < 6){
      							var posy = 704;
      						}else{
      							var posy = 0;
      						}
      						document.getElementById('builder-menu').style.top = posy+"px";
      						break

      						case 'fts':
      						document.getElementById('speed3').style.top = ((selposy-3)*64)+marginsizey+"px";
      						document.getElementById('speed3').style.left = ((selposx-3)*64)+marginsizex+"px";
      						break

      						case 'shield':
      						document.getElementById('speed2').style.top = ((selposy-2)*64)+marginsizey+"px";
      						document.getElementById('speed2').style.left = ((selposx-2)*64)+marginsizex+"px";
      						break

      						case 'trumpet':
      						document.getElementById('speed4').style.top = ((selposy-4)*64)+marginsizey+"px";
      						document.getElementById('speed4').style.left = ((selposx-4)*64)+marginsizex+"px";
      						break

      						case 'gunner':
      						document.getElementById('gunnerange').style.top = ((selposy-4)*64)+marginsizey+"px";
      						document.getElementById('gunnerange').style.left = ((selposx-4)*64)+marginsizex+"px";
      						break

      						case 'vtb':
      						startengine.currentTime = 0;
      						startengine.play();
      						document.getElementById('speed3').style.top = ((selposy-3)*64)+marginsizey+"px";
      						document.getElementById('speed3').style.left = ((selposx-3)*64)+marginsizex+"px";
      						break

      						case 'tower':
      						document.getElementById('bgm').volume = 0.1;
      						document.getElementById('hev').currentTime = 0;
      						document.getElementById('hev').play();
      						document.getElementById('speed3').style.top = ((selposy-3)*64)+marginsizey+"px";
      						document.getElementById('speed3').style.left = ((selposx-3)*64)+marginsizex+"px";
      						break

      						case 'tower':
      						document.getElementById('bgm').volume = 0.1;
      						document.getElementById('hev').currentTime = 0;
      						document.getElementById('hev').play();
      						document.getElementById('speed3').style.top = ((selposy-3)*64)+marginsizey+"px";
      						document.getElementById('speed3').style.left = ((selposx-3)*64)+marginsizex+"px";
      						break

      						case 'tank':
      						document.getElementById('speed1').style.top = ((selposy-1)*64)+marginsizey+"px";
      						document.getElementById('speed1').style.left = ((selposx-1)*64)+marginsizex+"px";
      						document.getElementById('tankrange').style.top = ((selposy-4)*64)+marginsizey+"px";
      						document.getElementById('tankrange').style.left = ((selposx-4)*64)+marginsizex+"px";
      						break

      						case 'napalm':
      						document.getElementById('napalm_range').style.top = ((selposy-3)*64)+marginsizey+"px";
      						document.getElementById('napalm_range').style.left = ((selposx-3)*64)+marginsizex+"px";
      						break

      						case 'poison':
      						document.getElementById('speed2').style.top = ((selposy-2)*64)+marginsizey+"px";
      						document.getElementById('speed2').style.left = ((selposx-2)*64)+marginsizex+"px";
      						break

      						case 'radio':
      						document.getElementById('speed2').style.top = ((selposy-2)*64)+marginsizey+"px";
      						document.getElementById('speed2').style.left = ((selposx-2)*64)+marginsizex+"px";
      						document.getElementById('radiorange').style.top = ((selposy-8)*64)+marginsizey+"px";
      						document.getElementById('radiorange').style.left = ((selposx-8)*64)+marginsizex+"px";
      						break

      						case 'seg'://sepcialiste en gaz
      						document.getElementById('speed2').style.top = ((selposy-2)*64)+marginsizey+"px";
      						document.getElementById('speed2').style.left = ((selposx-2)*64)+marginsizex+"px";
      						break

      						case 'ninja':
      						document.getElementById('speed2').style.top = ((selposy-2)*64)+marginsizey+"px";
      						document.getElementById('speed2').style.left = ((selposx-2)*64)+marginsizex+"px";
      						break
      					}
      					document.getElementById('selection').style.background = 'white';
      					return
      				}else{
      					if(eval(charlist[x]).team == turn && eval(charlist[x]).type == 'vtb'){
      						if(leavevtb == false && eval(charlist[x]).unitinside != false){
      							selchar = charlist[x];
	      						vtbskill();
      						}else{
      							leavevtb = false;
      							selchar = 'none';
      							resetvisual();
      						}
      					}
      					return
      				}
      			}
      		}

      		// if is a city
      		for(x=0; x < cities.length; x++){
      			if(currentselection == cities[x].posx+"/"+cities[x].posy){
      				if(cannonselected !== false){
      					if(cities[x].team == turn){
      						//shoot cannon on ally city
      						var distx = Math.abs(cannons[cannonselected].posx - selposx);
      						var disty = Math.abs(cannons[cannonselected].posy - selposy);
      						var distot = distx + disty;
      						if(((distot > 4 && distot < 9) || distot == 1) && (selposx == cannons[cannonselected].posx || cannons[cannonselected].posy == selposy)){
      						cannons[cannonselected].outcannon();
      							if(distot != 1){
      								cannon.currentTime = 0;
      								document.getElementById("cannon").play();
      							}else{
      								getout.play()
      							}
      							cycletowers();
      						}
      						cannonselected = false;
      						document.getElementById('selection').style.background = 'black';
      						cannon_sel.currentTime = 0;
      						cannon_sel.pause();
      						bgm.volume = 0.2;
      						resetvisual();
      						return
      					}else{
      						cannonselected = false;
      						document.getElementById('selection').style.background = 'black';
      						cannon_sel.currentTime = 0;
      						cannon_sel.pause();
      						bgm.volume = 0.2;
      						resetvisual();
      						return
      					}
      				}
      				if(cities[x].team != turn){
      					return
      				}
      				bgm.volume = 0.2;

      				if(turn == 1){
      					if(player1 == 1 || player1 == 7 || player1 == 3){
      						selcity1.play();
      					}else if(player1 == 2 || player1 == 6){
      						selcity3.play();
      					}else{
      						selcity2.play();
      					}
      				}else if(player2 == 1 || player2 == 7){
						selcity1.play();
      				}else if(player2 == 2 || player2 == 6){
						selcity3.play();
						bgm.volume = 0.05;
      				}else{
						selcity2.play();
      				}

      				document.getElementById('selection').style.background = 'white';
      				document.getElementById('buybox').style.zIndex = 999;
      				document.getElementById('teambal').innerHTML = eval('balanceteam'+eval(cities[x].team));
      				document.getElementById('teamcities').innerHTML = eval('citiesTeam'+eval(cities[x].team));
      				document.getElementById('profits').innerHTML = eval('citiesTeam'+eval(cities[x].team))*50;
      				cannonselected = false;
      				return
      			}
      		}

      		// if is a cannon
      		for(x=0; x < cannons.length; x++){
      			if(currentselection == cannons[x].posx+"/"+cannons[x].posy && cannonselected == false){
      				if(cannons[x].team != turn){
      					return
      				}
      				// select cannon
      				document.getElementById('radiorange').style.top = ((selposy-8)*64)+marginsizey+"px";
      				document.getElementById('radiorange').style.left = ((selposx-8)*64)+marginsizex+"px";
      				document.getElementById('speed1').style.top = ((selposy-1)*64)+marginsizey+"px";
      				document.getElementById('speed1').style.left = ((selposx-1)*64)+marginsizex+"px";
      				cannonselected = x;
      				bgm.volume = 0.1;
      				cannon_sel.play();
      				document.getElementById('selection').style.background = 'white';
      				return
      			}
      		}
      		if(cannonselected){
      			// shoot cannon
      			var checkthistile = checktile(selposx+"/"+selposy);
      			if(checkthistile == "plain" || checkthistile == "wood" || checkthistile == "bridge" || checkthistile == "village" || checkthistile == "town" || checkthistile == "cannon"){
      				if(checkthistile == "town" || checkthistile == "village" || checkthistile == "cannon"){
      					if(checkthistile == "town"){
      						var placeid = towns[istown(selposx+"/"+selposy, true)];
      					}else if(checkthistile == "village"){
      						var placeid = villages[isvillage2(selposx+"/"+selposy)];
      					}else{
      						var placeid = cannons[iscannon(selposx+"/"+selposy, true)];
      					}
      					if(placeid.team == turn){
      						var distx = Math.abs(cannons[cannonselected].posx - selposx);
      						var disty = Math.abs(cannons[cannonselected].posy - selposy);
      						var distot = distx + disty;
      						if(((distot > 4 && distot < 9) || distot == 1) && (selposx == cannons[cannonselected].posx || cannons[cannonselected].posy == selposy)){
      						cannons[cannonselected].outcannon();
      						if(distot != 1){
		      					cannon.currentTime = 0;
		      					document.getElementById("cannon").play();
      						}else{
      							getout.play()
      						}
      						cycletowers();
      						cannon_sel.pause();
      						cannonselected = false;
      						cannon_sel.currentTime = 0;
      						setTimeout(function(){bgm.volume = 0.2}, 850);
      						resetvisual();
      						return
      						}
      					}
      				}else{
      				var distx = Math.abs(cannons[cannonselected].posx - selposx);
      				var disty = Math.abs(cannons[cannonselected].posy - selposy);
      				var distot = distx + disty;
      				if(((distot > 4 && distot < 9) || distot == 1) && (selposx == cannons[cannonselected].posx || cannons[cannonselected].posy == selposy)){
      						cannons[cannonselected].outcannon();
      				if(distot != 1){
		      			cannon.currentTime = 0;
		      			document.getElementById("cannon").play();
      				}else{
      					getout.play()
      				}
      					cycletowers();
      					resetvisual();
      					cannon_sel.pause();
      					cannonselected = false;
      					cannon_sel.currentTime = 0;
      					setTimeout(function(){bgm.volume = 0.2}, 850);
      					}
      				}
      				resetvisual();
      				cannon_sel.pause();
      				cannonselected = false;
      				cannon_sel.currentTime = 0;
      				setTimeout(function(){bgm.volume = 0.2}, 850);
      			}else{
      				cannon_sel.pause();
      				cannonselected = false;
      				cannon_sel.currentTime = 0;
      				setTimeout(function(){bgm.volume = 0.2}, 850);
      				resetvisual();
      			}
      		}

      		document.getElementById('selection').style.background = 'black';
			}else{
      			if(currentselection == eval(selchar).posx+"/"+eval(selchar).posy){
      				if(eval(selchar).type == 'tower'){
      					document.getElementById('hevend').play();
      				}
      				if(eval(selchar).type == 'vtb'){
      					if(leavevtb == false){
	      					vtbskill();
	      					return
      					}else{
      						leavevtb = false;
      					}
      				}
      				selchar = "none";
      				resetvisual();
      				document.getElementById('hev').pause();
      				setTimeout(function(){document.getElementById('bgm').volume = 0.3}, 1200);

      				return
      			}else{
      				if(canmove(eval(selchar).id, eval(selchar).type, eval(selchar).range, eval(selchar).posx, eval(selchar).posy, eval(selchar).speed, eval(selchar).team, currentselection, eval(selchar).skin, true, false)){
      					var x = currentselection.substr(0, currentselection.indexOf('/') );
      					var y = currentselection.substr(currentselection.indexOf('/')+1, currentselection.length);
      					mvchar(eval(selchar), x, y);
      					memofirstpoison = -1;
      					if(enableShadows > 0 && isnight == 1){
      						shadowExList();
      					}
      					cycletowers();
      				}else{
      					selchar = 'none';
						resetvisual();
      				}
      				return
      			}
			}
		}
	}

	function cycletowers(){
		for(zi=0; zi < unit.length; zi++){
			if(unit[zi].type == "villager"){
				istowermap(unit[zi].posx+"/"+unit[zi].posy, unit[zi].skinteam);
			}else{
				istowermap(unit[zi].posx+"/"+unit[zi].posy, unit[zi].team);
			}
		}
	}

	function setbgm(player){
		bgm.volume = 0.2;
		var maxnum = 1;
		var bgmtype = '';
		var folder = '';
		var team1 = "citiesTeam"+player;
		if(player == 1){
			var team2 = "citiesTeam"+"2";
		}else{
			var team2 = "citiesTeam"+"1";
		}
		activeCities = citiesTeam1+citiesTeam2;
		if(player == 1){
			bgmset = player1;
		}

		if(player == 2){
			bgmset = player2;
		}

		if(turnstotal > 8){
						
			if(eval(team1)/activeCities*100 >= 60 || eval(team1)/activeCities*100 <= 40){
	       		//team 1 a 60% ou plus de villes || 40% ou moins de ville
       			bgmtype = 'action';
       			switch(bgmset){
					case "1":
					folder = 'ice';
					maxnum = 6;
					break

					case "2":
					folder = 'void';
					maxnum = 7;
					break

					case "3":
					folder = 'pomme';
					maxnum = 4;
					break

					case "4":
					folder = 'meca';
					maxnum = 3;
					break

					case "5":
					folder = 'bonbon';
					maxnum = 5;
					break

					case "6":
					folder = 'orange';
					maxnum = 10;
					break

					case "7":
					folder = 'magma';
					maxnum = 5;
					break
				}
				var selnum = Math.floor(Math.random()*maxnum)+1;
        		bgm.src = 'sfx/'+folder+'/'+bgmtype+selnum+'.mp3';
        		bgm.play();
       		}else{
       			//main
       			bgmtype = 'main';
       			switch(bgmset){
					case "1":
					folder = 'ice';
					maxnum = 5;
					break

					case "2":
					folder = 'void';
					maxnum = 4;
					break

					case "3":
					folder = 'pomme';
					maxnum = 3;
					break

					case "4":
					folder = 'meca';
					maxnum = 4;
					break

					case "5":
					folder = 'bonbon';
					maxnum = 4;
					break

					case "6":
					folder = 'orange';
					maxnum = 3;
					break

					case "7":
					folder = 'magma';
					maxnum = 4;
					break
					}
				}
        		var selnum = Math.floor(Math.random()*maxnum)+1;
        		bgm.src = 'sfx/'+folder+'/'+bgmtype+selnum+'.mp3';
        		bgm.play();
       	}else{
       		//main
       		switch(bgmset){
				case "1":
				folder = 'ice';
				maxnum = 5;
				break

				case "2":
				folder = 'void';
				maxnum = 4;
				break

				case "3":
				folder = 'pomme';
				maxnum = 3;
				break

				case "4":
				folder = 'meca';
				maxnum = 4;
				break

				case "5":
				folder = 'bonbon';
				maxnum = 4;
				break

				case "6":
				folder = 'orange';
				maxnum = 3;
				break

				case "7":
				folder = 'magma';
				maxnum = 4;
				break
			}
       		bgmtype = 'main';
        	var selnum = Math.floor(Math.random()*maxnum)+1;
        	bgm.src = 'sfx/'+folder+'/'+bgmtype+selnum+'.mp3';
        	bgm.play();
		}
	}

	function nextturn(){
		cannonselected = false;
		nospace = true;
		noenter = true;
		hidespies();
		//fire progress
		setTimeout(function(){
			barbecuetime();
			setTimeout(function(){isgasexplosion();barbecuetime();
				setTimeout(function(){
					treecycle();nospace = false; noenter = false
				}, 500);
			}, 500);
		}, 500);
	//check quality of mines
		var px = 0;
		var py = 0;
		var newpx = 0;
		var newpy = 0;
		for(i=0 ; i < towns.length; i++){
			px = towns[i].posx;
			py = towns[i].posy;
			towns[i].quality = 0;
		
			//check mountain on right
			newpx = parseInt(px)+1;
			newpy = py;
			if(ismountain(newpx+"/"+newpy)){towns[i].quality++};

			//check mountain on left
			newpx = px-1;
			if(ismountain(newpx+"/"+newpy)){towns[i].quality++};

			//check mountain on top
			newpx = px;
			newpy = py-1;
			if(ismountain(newpx+"/"+newpy)){towns[i].quality++};

			//check mountain on bottom
			newpy = parseInt(py)+1;
			if(ismountain(newpx+"/"+newpy)){towns[i].quality++};
		}
		resetselection();
		defaultmode = 0;
		document.getElementById('blackscreen1').style.opacity = "0";
		document.getElementById('blackscreen2').style.opacity = "0";
		resetvillagers();
		if(is_ai_on == true){
        	playAI();
        }
		document.getElementById('moneybox').style.display = 'none';
        selchar = "none";
        document.getElementById('hev').pause();
        nightcycle++;
        
        if(nightcycle == 6){
        	if(isnight == 0 && enableShadows !=2){
        		isnight = 1;
        		document.getElementById('nightfall').play();
        		nightcycle = 0;
        	}else if (isnight == 1 && enableShadows !=2){
        		isnight = 0;
	        	document.getElementById('morning').play();
        		nightcycle = 0;
        	}
        }

        if(isnight == 0){
        	if(nightcycle == 0){
				killshadows();
        	}
 	     	document.getElementById('bgm').volume = 0.3;
        	document.getElementById('night-filter').style.opacity = 0;
			document.getElementById('night-ambient').currentTime = 0;
			document.getElementById('night-ambient').pause();
			document.getElementById('owl-ambient').currentTime = 0;
			document.getElementById('owl-ambient').pause();
			loadbiome();
        }else{
        	document.getElementById('night-filter').style.opacity = 1;
			document.getElementById('night-ambient').play();
			document.getElementById('owl-ambient').play();
			birds.pause();
			river.pause();
			birds.currentTime = 0;
			river.currentTime = 0;
        }
        resetvisual();
        turnstotal++;
        document.getElementById('buybox').style.zIndex = -1;
        selcity1.pause();
     	selcity1.currentTime = 0;
      	selcity2.pause();
      	selcity2.currentTime = 0;
      	selcity3.pause();
      	selcity3.currentTime = 0;
        for(i=0; i < towns.length; i++){
        	towns[i].work();
        }

        if(turn == 1){
      		var Nskin = player2;
      		setbgm(2);
      	}else{
     		var Nskin = player1;
      		setbgm(1);
     	}
      	document.getElementById('fts-img').src = "tiles/fts"+Nskin+"/fts1.png";
      	document.getElementById('gunner-img').src = "tiles/gunner"+Nskin+"/gunner1.png";
      	document.getElementById('shield-img').src = "tiles/shield"+Nskin+"/shield1.png";
      	document.getElementById('builder-img').src = "tiles/builder"+Nskin+"/builder1.png";
      	document.getElementById('tank-img').src = "tiles/tank"+Nskin+"/tank1.png";
      	document.getElementById('ninja-img').src = "tiles/ninja"+Nskin+"/ninja1.png";
      	document.getElementById('seg-img').src = "tiles/seg"+Nskin+"/seg1.png";
      	document.getElementById('radio-img').src = "tiles/radio"+Nskin+"/radio1.png";
      	document.getElementById('vtb-img').src = "tiles/vtb"+Nskin+"/vtb1.png";
      	document.getElementById('trumpet-img').src = "tiles/trumpet"+Nskin+"/trumpet1.png";
      	document.getElementById('napalm-img').src = "tiles/napalm"+Nskin+"/napalm1.png";
      	document.getElementById('poison-img').src = "tiles/poison"+Nskin+"/poison1.png";

        if(turn == 1){

        	switch(player2){
        		case '1':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'deepskyblue';
        		break
        		case '2':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'mediumpurple';
        		break
        		case '3':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'lawngreen';
        		break
        		case '4':
        			document.getElementsByClassName('upperbuy')[0].style.background = '#CCC';
        		break
        		case '5':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'deeppink';
        		break
        		case '6':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'darkorange';
        		break
        		case '7':
        			document.getElementsByClassName('upperbuy')[0].style.background = '#D00';
        		break
        	}
        	balanceteam1 = balanceteam1 + citiesTeam1*50;
        	if(legoteam1 < 20){
        		legoteam1 = legoteam1 + 1 + villageteam1;
        	}
        	turn = 2;
        	if(enableShadows > 0 && isnight == 1){
				if(nightcycle != 0){
					killshadows();
				}
				shadowExList();
			}
        	updatemoney();

        	if(cpuOn == true){
        		playCpu();
        	}

        }else{
        	switch(player1){
        		case '1':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'deepskyblue';
        		break
        		case '2':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'mediumpurple';
        		break
        		case '3':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'lawngreen';
        		break
        		case '4':
        			document.getElementsByClassName('upperbuy')[0].style.background = '#CCC';
        		break
        		case '5':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'deeppink';
        		break
        		case '6':
        			document.getElementsByClassName('upperbuy')[0].style.background = 'darkorange';
        		break
        		case '7':
        			document.getElementsByClassName('upperbuy')[0].style.background = '#D00';
        		break
        	}
        	balanceteam2 = balanceteam2 + citiesTeam2*50;
        	if(legoteam2 < 20){
        		legoteam2 = legoteam2 + 1 + villageteam2;
        	}
        	turn = 1;
        	if(enableShadows > 0 && isnight == 1){
				if(nightcycle != 0){
					killshadows();
				}
				shadowExList();
			}
        	updatemoney();
        }
        setTimeout(function(){isgasexplosion()}, 2000) ;
        //moves gas entities
        for(i2=0; i2 < gas.length; i2++){
        	if(gas[i2].id){
        		gas[i2].move();
        	}
        }
        setTimeout(function(){isgasexplosion()}, 2000);
        for(x=0; x < unit.length ;x++){
        	if(unit[x].id){
        		unit[x].playable = true;
        		if(unit[x].type == 'builder'){
        			unit[x].cuttree = 0;
        		}else if(unit[x].type == 'gunner'){
        			unit[x].canreshoot = 0;
        		}else if(unit[x].type == 'vtb'){
        			unit[x].leftmoves = 1;
        			if(iscity(unit[x].posx+"/"+unit[x].posy, false) || iscannon(unit[x].posx+"/"+unit[x].posy) || isvillage(unit[x].posx+"/"+unit[x].posy) || istown(unit[x].posx+"/"+unit[x].posy, false)){
        				unit[x].leftmoves++;
        			}
        		}

        		if(unit[x].id && unit[x].posx != -10){
        			if(unit[x].type == 'villager' && unit[x].team == 3){
        				document.getElementById("unit"+x).classList.remove('villager'+unit[x].skin+"_off");
        				document.getElementById("unit"+x).classList.add('villager'+unit[x].skin);
        			}else if(cpuOn == true && unit[x].team == 2){
        				document.getElementById("unit"+x).classList.remove("villager"+unit[x].skin+"_off");
        				document.getElementById("unit"+x).classList.add("villager"+unit[x].skin);
        			}else{
        				unit[x].playedtwice = false;
        				if(unit[x].moved){
        					unit[x].moved = false;
        				}
        				document.getElementById("unit"+x).classList.remove(unit[x].type+unit[x].skin+"_off");
        				document.getElementById("unit"+x).classList.add(unit[x].type+unit[x].skin);
        			}
        		}
        	}
        }
        cycletowers();
        poisonhide();
        gaskill();
        poisoncycle();
        poisonturninfection();
        poisonprogress();
	}

	function movescreen(direction){
		switch(direction){
			case 'down':
			if(selposy < 12){
				return
			}
			if(document.getElementsByTagName('html')[0].scrollTop == document.getElementsByTagName('html')[0].scrollTopMax){
				screenposy = document.getElementsByTagName('html')[0].scrollTopMax;
			}else{
				screenposy += 64;
        		document.getElementsByTagName('html')[0].scrollTop = screenposy;
			}
			break

			case 'up':
			if(selposy > ytiles-13){
				return
			}
			if(document.getElementsByTagName('html')[0].scrollTop == 0){
				screenposy = 0;
			}else{
				screenposy -= 64;
        		document.getElementsByTagName('html')[0].scrollTop = screenposy;
			}
			break

			case 'left':
			if(selposx > xtiles-22){
				return
			}
			if(document.getElementsByTagName('html')[0].scrollLeft == 0){
				screenposx = 0;
			}else{
				screenposx -= 64;
        		document.getElementsByTagName('html')[0].scrollLeft = screenposx;
			}
			break

			case 'right':
			if(selposx < 21){
				return
			}
			if(document.getElementsByTagName('html')[0].scrollLeft == document.getElementsByTagName('html')[0].scrollLeftMax){
				screenposx = document.getElementsByTagName('html')[0].scrollLeftMax;
			}else{
				screenposx += 64;
        		document.getElementsByTagName('html')[0].scrollLeft = screenposx;
			}
			break
		}
	}

	function resetselection(){
		for(i=0; i < cities.length; i++){
			if(cities[i].team != turn && cities[i].team != 3){
				selposx = cities[i].posx;
				selposy = cities[i].posy;
				var tempscreenposx = (selposx-20)*64;
				var tempscreenposy = (selposy-11)*64;
				if(tempscreenposx > 0){
					document.getElementsByTagName('html')[0].scrollLeft = tempscreenposx;
					screenposx = tempscreenposx;
				}
				else{
					document.getElementsByTagName('html')[0].scrollLeft = 0;
					screenposx = 0;
				}
				if(tempscreenposy > 0){
					document.getElementsByTagName('html')[0].scrollTop = tempscreenposy;
					screenposy = tempscreenposy;
				}else{
					document.getElementsByTagName('html')[0].scrollTop = 0;
					screenposy = 0;
				}
				break
			}
		}
		document.getElementById('selection').style.top = (selposy*64)+marginsizey+'px';
		document.getElementById('selection').style.left = (selposx*64)+marginsizex+'px';
	}

	function resetvillagers(){
		for(i=0; i < villages.length; i++){
			if(hasvillager(i) == false){
				villages[i].slimeleft = 1;
			}
		}
	}

	function hasvillager(id){
		for(j=0; j < unit.length; j++){
			if(unit[j].origin == id){
				return true
			}
		}
		return false
	}

	function killshadows(){
		for(i=0; i < shadow.length; i++){
			if(shadow[i].id){
				shadow[i].die();
			}
		}
	}

	function bornshadow(){
		shadowNum = 0;
		var positionx = -1;
		var positiony = -1;
		var found = 1;
		//loop all tiles
		for(i=0; i < tiles.length; i++){
			
			found = 1;
			for(j=0; j < exlist.length; j++){
				//loop exception list
				//if match
				if(tiles[i] == exlist[j]){
					found = 2;
				}
			}
			positionx = tiles[i].substr(0, tiles[i].indexOf('/'))*64;
      		positiony = tiles[i].substr(tiles[i].indexOf('/')+1, tiles[i].length)*64;
      		shadow[shadowNum] = new shadowtile(positionx, positiony);
      		shadow[shadowNum].spawn();
      		if(found == 2){
      			shadow[shadowNum].die();
			}
      		shadowNum++;
		}
	}

	function vtbskill(){
		leavevtb = true;
		resetvisual();
		document.getElementById('speed1').style.top = ((selposy-1)*64)+marginsizey+"px";
      	document.getElementById('speed1').style.left = ((selposx-1)*64)+marginsizex+"px";
	}

	function shadowExList(){
		killshadows();
		exlist = [];
		var positionx = -1;
		var positiony = -1;
		var speed = -1;
		for(i=0; i < unit.length; i++){
			speed = unit[i].speed;
			positionx = unit[i].posx;
			positiony = unit[i].posy;
			if(unit[i].team == turn || (unit[i].teamskin == turn && unit[i].skin != 3)){
				if(unit[i].type == "ninja"){
					speed = 3;
				}
				switch(speed){
					case 3:
						addexlist(parseInt(positionx)+1, parseInt(positiony)+2);
						addexlist(parseInt(positionx)+1, parseInt(positiony)-2);
						addexlist(parseInt(positionx)+2, parseInt(positiony)+1);
						addexlist(parseInt(positionx)+2, parseInt(positiony)-1);
						addexlist(parseInt(positionx)-1, parseInt(positiony)+2);
						addexlist(parseInt(positionx)-1, parseInt(positiony)-2);
						addexlist(parseInt(positionx)-2, parseInt(positiony)+1);
						addexlist(parseInt(positionx)-2, parseInt(positiony)-1);
						addexlist(parseInt(positionx)+3, parseInt(positiony));
						addexlist(parseInt(positionx)-3, parseInt(positiony));
						addexlist(parseInt(positionx), parseInt(positiony)+3);
						addexlist(parseInt(positionx), parseInt(positiony)-3);
					case 2:
						addexlist(parseInt(positionx)-1, parseInt(positiony)-1);
						addexlist(parseInt(positionx)+1, parseInt(positiony)+1);
						addexlist(parseInt(positionx)-1, parseInt(positiony)+1);
						addexlist(parseInt(positionx)+1, parseInt(positiony)-1);
						addexlist(parseInt(positionx)+2, parseInt(positiony));
						addexlist(parseInt(positionx)-2, parseInt(positiony));
						addexlist(parseInt(positionx), parseInt(positiony)+2);
						addexlist(parseInt(positionx), parseInt(positiony)-2);
					case 1:
						addexlist(parseInt(positionx)-1, parseInt(positiony));
						addexlist(parseInt(positionx)+1, parseInt(positiony));
						addexlist(parseInt(positionx), parseInt(positiony)+1);
						addexlist(parseInt(positionx), parseInt(positiony)-1);
						addexlist(parseInt(positionx), parseInt(positiony));
					break

					default:
						addexlist(parseInt(positionx)+1, parseInt(positiony)+2);
						addexlist(parseInt(positionx)+1, parseInt(positiony)-2);
						addexlist(parseInt(positionx)+2, parseInt(positiony)+1);
						addexlist(parseInt(positionx)+2, parseInt(positiony)-1);
						addexlist(parseInt(positionx)-1, parseInt(positiony)+2);
						addexlist(parseInt(positionx)-1, parseInt(positiony)-2);
						addexlist(parseInt(positionx)-2, parseInt(positiony)+1);
						addexlist(parseInt(positionx)-2, parseInt(positiony)-1);
						addexlist(parseInt(positionx)+3, parseInt(positiony));
						addexlist(parseInt(positionx)-3, parseInt(positiony));
						addexlist(parseInt(positionx), parseInt(positiony)+3);
						addexlist(parseInt(positionx), parseInt(positiony)-3);
						addexlist(parseInt(positionx)-1, parseInt(positiony)-1);
						addexlist(parseInt(positionx)+1, parseInt(positiony)+1);
						addexlist(parseInt(positionx)-1, parseInt(positiony)+1);
						addexlist(parseInt(positionx)+1, parseInt(positiony)-1);
						addexlist(parseInt(positionx)+2, parseInt(positiony));
						addexlist(parseInt(positionx)-2, parseInt(positiony));
						addexlist(parseInt(positionx), parseInt(positiony)+2);
						addexlist(parseInt(positionx), parseInt(positiony)-2);
						addexlist(parseInt(positionx)-1, parseInt(positiony));
						addexlist(parseInt(positionx)+1, parseInt(positiony));
						addexlist(parseInt(positionx), parseInt(positiony)+1);
						addexlist(parseInt(positionx), parseInt(positiony)-1);
						addexlist(parseInt(positionx), parseInt(positiony));
				}
			}
		}

		for(i=0; i < cities.length; i++){
			positionx = cities[i].posx;
			positiony = cities[i].posy;
			if(cities[i].team == turn){
				addexlist(positionx, positiony);
			}
		}

		for(i=0; i < towns.length; i++){
			positionx = towns[i].posx;
			positiony = towns[i].posy;
			if(towns[i].team == turn){
				addexlist(positionx, positiony);
			}
		}

		for(i=0; i < villages.length; i++){
			positionx = villages[i].posx;
			positiony = villages[i].posy;
			if(villages[i].team == turn){
				addexlist(positionx, positiony);
			}
		}

		for(i=0; i < cannons.length; i++){
			positionx = cannons[i].posx;
			positiony = cannons[i].posy;
			if(cannons[i].team == turn){
				addexlist(positionx, positiony);
			}
		}

		for(i=0; i < firemap.length; i++){
			positionx = firemap[i].substr(0, firemap[i].indexOf('/') );
      		positiony = firemap[i].substr(firemap[i].indexOf('/')+1, firemap[i].length);
			addexlist(positionx, positiony);
			addexlist(parseInt(positionx)-1, parseInt(positiony));
			addexlist(parseInt(positionx)+1, parseInt(positiony));
			addexlist(parseInt(positionx), parseInt(positiony)+1);
			addexlist(parseInt(positionx), parseInt(positiony)-1);
		}

		for(i=0; i < firemap2.length; i++){
			positionx = firemap2[i].substr(0, firemap2[i].indexOf('/') );
      		positiony = firemap2[i].substr(firemap2[i].indexOf('/')+1, firemap2[i].length);
			addexlist(positionx, positiony);
			addexlist(parseInt(positionx)-1, parseInt(positiony));
			addexlist(parseInt(positionx)+1, parseInt(positiony));
			addexlist(parseInt(positionx), parseInt(positiony)+1);
			addexlist(parseInt(positionx), parseInt(positiony)-1);
		}

		bornshadow();
	}

	function addexlist(x,y){
		var position = x+"/"+y;
		var found = false;
		for(o=0; o < exlist.length; o++){
			if(exlist[o] == position){
				found = true;
			}
		}

		if(found != true){
			exlist.push(x+"/"+y);
		}
	}
	
	function train(x, u, cpu){;
		var type = "";
		if(eval(cities[x]).team != turn){
			return;
		}
		var thisteambalance = eval('balanceteam'+eval(cities[x].team));
		var price = 0;
		if(cities[x].team == '3'){
			return;
		}
		switch(u){

			case 1:
			type = 'fts';
			if(thisteambalance < 150 && cpu != true){
				alert("fonds insufisants !");
			}else if(cpu != true){
				price = 150;
			}else{
				price = 1;
			}
			break

			case 2:
			type = 'shield';
			if(thisteambalance < 200){
				alert("fonds insufisants !");
			}else{
				price = 200;
			}
			break

			case 3:
			type = 'gunner';
			if(thisteambalance < 250){
				alert("fonds insufisants !");
			}else{
				price = 250;
			}
			break

			case 4:
			type = 'builder';
			if(thisteambalance < 50){
				alert("fonds insufisants !");
			}else{
				price = 50;
			}
			break

			case 5:
			type = 'radio';
			if(thisteambalance < 200){
				alert("fonds insufisants !");
			}else{
				price = 200;
			}
			break

			case 6:
			type = 'tank';
			if(thisteambalance < 300){
				alert("fonds insufisants !");
			}else{
				price = 300;
			}
			break

			case 7:
			type = 'seg';
			if(thisteambalance < 200){
				alert("fonds insufisants !");
			}else{
				price = 200;
			}
			break

			case 8:
			type = 'ninja';
			if(thisteambalance < 200){
				alert("fonds insufisants !");
			}else{
				price = 200;
			}
			break

		case 9:
			type = 'vtb';
			if(thisteambalance < 50){
				alert("fonds insufisants !");
			}else{
				price = 50;
			}
			break

		case 0:
			type = 'trumpet';
			if(thisteambalance < 300){
				alert("fonds insufisants !");
			}else{
				price = 300;
			}
			break

		case 'a':
			type = 'napalm';
			if(thisteambalance < 250){
				alert("fonds insufisants !");
			}else{
				price = 250;
			}
			break

		case 'z':
			type = 'poison';
			if(thisteambalance < 200){
				alert("fonds insufisants !");
			}else{
				price = 200;
			}
			break
		}


		if(cities[x].team == 1){
			balanceteam1 = thisteambalance-price;
		}else{
			balanceteam2 = thisteambalance-price;
		}
		updatemoney();
		document.getElementById('buybox').style.zIndex = -1;
		selcity1.pause();
      	selcity1.currentTime = 0;
      	selcity2.pause();
      	selcity2.currentTime = 0;
      	selcity3.pause();
      	selcity3.currentTime = 0;
      	bgm.volume = 0.2;
		currentselection = "";
		if(price != 0){
			create(type, cities[x].team, cities[x].posx, cities[x].posy, false);
		}
		document.getElementById('selection').style.background = 'black';

	}

	function isembark(){
		if(defaultmode == 0){
			defaultmode = 1;
			document.getElementById('embark').style.opacity = 1;
			setTimeout(function(){document.getElementById('embark').style.opacity = 0;}, 1000);
		}else{
			defaultmode = 0;
			document.getElementById('attack').style.opacity = 1;
			setTimeout(function(){document.getElementById('attack').style.opacity = 0;}, 1000);
		}
	}

	function keypress(key){
		var xx = 0;
        var cantrain = true;
        for(x=0; x < cities.length; x++){
      		if(currentselection == cities[x].posx+"/"+cities[x].posy){
      			for(i = 0 ; i < unit.length; i++){
      				if(unit[i] != undefined){
      					if(cities[x].posx+"/"+cities[x].posy == getcharpos(unit[i])){
      						cantrain = false;
      					}
      				}
      			}
      			if(cantrain == true){
      				train(x,key);
      				if(isnight == 1 && enableShadows > 0){
      					shadowExList();
					}
      			}
      		}
      	}
	}

	function canmove(id, type, range, startx, starty, speed, team, dest, skin, kill, ai){
		// check if can move according to currently selected char's team and his destination, as well as his speed
		selfkill = false;
		eval(selchar).playable = false;
		var shilded = false;
		var shieldtower = false;
		var found = false;
		var agree = true;
		var destx = dest.substr(0, dest.indexOf('/') );
      	var desty = dest.substr(dest.indexOf('/')+1, dest.length);
      	if(desty < 0 || destx < 0 || desty > ytiles-1 || destx > xtiles-1){
      		agree = false;
      	}
      	var diffx = Math.abs(startx-destx);
      	var diffy = Math.abs(starty-desty);
      	var diff = diffx + diffy;
      	var subm = "";
      	if(startx == destx && starty == desty){
      		//if destination == position actuelle
      		eval(selchar).playable = true;
      		return
      	}

      	//if destination is a mountain, can't move
      	for(x=0; x < mountains.length; x++){
      		subm = mountains[x].posx+"/"+mountains[x].posy;
      		if(subm == dest){
      			agree = false;
      			if(leavevtb != true){
      				eval(selchar).playable = true;
      			}
      		}
      	}
      	//if destination is a water, can't move
      	for(x=0; x < waters.length; x++){
      		subm = waters[x].posx+"/"+waters[x].posy;
      		if(subm == dest){
      			if(turn == 1){
      				var thisteamlego = legoteam1;
      			}else{
      				var thisteamlego = legoteam2;
      			}
      			if(eval(selchar).type == 'builder' && diff == 1 && thisteamlego >= 1){
      				if(turn == 1){
						legoteam1 = legoteam1 - 1;
      				}else{
						legoteam2 = legoteam2 - 1;
      				}
      				sdwater(destx, desty);
      				casen = 10;
      				draw(destx, desty);
      				buildbridge.play();
      				updatemoney();
      			}else{
      				agree = false;
      				if(leavevtb != true){
      					eval(selchar).playable = true;
      				}
      			}
      		}
      	}

      	//if character goes in straight line 2 of distance, check if there's mountain in between
      	if(((diffx == 2 && diffy != 1) || (diffy == 2 && diffx != 1)) && speed > 1){
      		startx = Number(startx);
      		starty = Number(starty);
      		desty = Number(desty);
      		destx = Number(destx);
      		if(diffx == 2){
      			if(Number(startx) > Number(destx)){
      				//gauche
      				indest = startx-1;
      				indest = indest+"/"+starty;
      			}else{
      				//droite
      				indest = startx+1;
      				indest = indest+"/"+starty;
      			}
      		}else if(Number(starty) > Number(desty)){
      			//haut
      			indest = starty-1;
      			indest = startx+"/"+indest;
      		}else{
      			//bas
      			indest = starty+1;
      			indest = startx+"/"+indest;
      		}
      		for(x=0; x < mountains.length; x++){
      			subm = mountains[x].posx+"/"+mountains[x].posy;
      			if(subm == indest){
      				agree = false;
      				if(leavevtb != true){
      					eval(selchar).playable = true;
      				}
      				//un fantassin ne peut ni tuer à distance, ni se déplacer.
      				if(range >= 2 && type !='gunner'){
      					kill = false;
      				}
      			}
      		}
      		//same as moutain but for water
      		for(x=0; x < waters.length; x++){
      			subm = waters[x].posx+"/"+waters[x].posy;
      			if(subm == indest){
      				agree = false;
      				if(leavevtb != true){
      					eval(selchar).playable = true;
      				}
      				//un fantassin ne peut ni tuer à distance, ni se déplacer.
      				if(range >= 2 && type !='gunner'){
      					kill = false;
      				}
      			}
      		}
      	}
      	//check for water if going diagonal
      	if((diffx >= 1 && diffy == 1) || (diffx >= 1 && diffy >= 1) && speed > 1){
      		if(Number(startx) > Number(destx) && Number(starty) < Number(desty)){
      			//gauche-bas
      			indest = Number(startx)-1;
      			indest = indest+"/"+starty;
      			indest2 = Number(starty)+1;
      			indest2 = startx+"/"+indest2;
      		}else if(Number(startx) < Number(destx) && Number(starty) < Number(desty)){
      			//droite-bas
      			indest = Number(startx)+1;
      			indest = indest+"/"+starty;
      			indest2 = Number(starty)+1;
      			indest2 = startx+"/"+indest2;
      		}else if(Number(startx) > Number(destx) && Number(starty) > Number(desty)){
      			//gauche-haut
      			indest = Number(startx)-1;
      			indest = indest+"/"+starty;
      			indest2 = Number(starty)-1;
      			indest2 = startx+"/"+indest2;
      		}else{
      			//droite-haut
      			indest = Number(startx)+1;
      			indest = indest+"/"+starty;
      			indest2 = Number(starty)-1;
      			indest2 = startx+"/"+indest2;
      		}

      		//check for water
      		mountfound = 0;
      		for(x=0; x < waters.length; x++){
      			subm = waters[x].posx+"/"+waters[x].posy;
      			if(subm == indest || subm == indest2){
      				mountfound++;
      				if(mountfound == 2){
      					agree = false;
      					if(leavevtb != true){
      						eval(selchar).playable = true;
      					}
      					//un fantassin ne peut ni tuer à distance, ni se déplacer.
      					if(range >= 2 && type !='gunner'){
      						kill = false;
      					}
      				}
      			}
      		}
			if(mountfound == 1){
      			for(x=0; x < mountains.length; x++){
      				subm = mountains[x].posx+"/"+mountains[x].posy;
      				if(subm == indest || subm == indest2){
      					mountfound++;
      					if(mountfound == 2){
      						agree = false;
      						if(leavevtb != true){
      							eval(selchar).playable = true;
      						}
      						//un fantassin ne peut ni tuer à distance, ni se déplacer.
      						if(range >= 2 && type !='gunner'){
      							kill = false;
      						}
      					}
      				}
      			}
      		}
      	}

      	//check for water digonal speed 3
      	if((diffx == 2 && diffy == 1) || (diffx == 1 && diffy == 2) && speed == 3){
      		if(Number(startx) > Number(destx) && Number(starty) < Number(desty)){
      			//gauche 2x bas 1x
      			if(diffx == 2){
      				indest = Number(startx)-2;
      				indest = indest+"/"+starty;
      				indest2 = Number(starty)+1;
      				indest2 = startx-1+"/"+indest2;
      			}else{
      				//gauche 1x bas 2x
      				indest = Number(startx)-1;
      				indest = indest+"/"+starty;
      				indest2 = Number(startx);
      				indest2 += "/";
      				indest2 += Number(starty)+1;
      			}
      		}else if(Number(startx) < Number(destx) && Number(starty) < Number(desty)){
      			//droite 2x bas 1x
      			if(diffx == 2){
	      			indest = Number(startx)+2;
	      			indest = indest+"/"+starty;
	      			indest2 = Number(startx)+1;
	      			indest2 += "/";
	      			indest2 += Number(starty)+1;
	      		}else{
	      			//droite 1x bas 2x
	      			indest = Number(starty)+2;
	      			indest = Number(startx)+"/"+indest;
	      			indest2 = Number(startx)+1;
	      			indest2 += "/";
	      			indest2 += Number(starty)+1;
	      		}
      		}else if(Number(startx) > Number(destx) && Number(starty) > Number(desty)){
      			//gauche 1x haut 2x
      			if(diffy == 2){
      				indest = Number(startx)-1;
      				indest += "/";
      				indest += Number(starty)-1;
      				indest2 = Number(starty)-2;
      				indest2 = startx+"/"+indest2;
      			}else{
      				//gauche 2x haut 1x
      				indest = Number(startx)-1;
      				indest += "/";
      				indest += Number(starty)-1;
      				indest2 = Number(startx)-2;
      				indest2 = indest2+"/"+starty;
      			}
      		}else{
      			//droite 2x haut 1x
      			if(diffx == 2){
      				indest = Number(startx)+2;
      				indest = indest+"/"+starty;
      				indest2 = Number(startx)+1;
      				indest2 += "/";
      				indest2 += Number(starty)-1;
      			}else{
      			//droite 1x haut 2x
      				indest = Number(startx)+1;
      				indest = indest+"/"+starty;
      				indest2 = Number(startx);
      				indest2 += "/";
      				indest2 += Number(starty)-1;
      			}
      		}

      		//check for water
      		mountfound = 0;
      		for(x=0; x < waters.length; x++){
      			subm = waters[x].posx+"/"+waters[x].posy;
      			if(subm == indest || subm == indest2){
      				mountfound++;
      				if(mountfound == 2){
      					agree = false;
      					if(leavevtb != true){
      						eval(selchar).playable = true;
      					}
      					//un fantassin ne peut ni tuer à distance, ni se déplacer.
      					if(range >= 2 && type !='gunner'){
      						kill = false;
      					}
      				}
      			}
      		}
			if(mountfound == 1){
      			for(x=0; x < mountains.length; x++){
      				subm = mountains[x].posx+"/"+mountains[x].posy;
      				if(subm == indest || subm == indest2){
      					mountfound++;
      					if(mountfound == 2){
      						agree = false;
      						if(leavevtb != true){
      							eval(selchar).playable = true;
      						}
      						//un fantassin ne peut ni tuer à distance, ni se déplacer.
      						if(range >= 2 && type !='gunner'){
      							kill = false;
      						}
      					}
      				}
      			}
      		}
      	}

      	if(((diffx == 2 && diffy == 1) || (diffy == 2 && diffx == 1)) && speed == 3){
      		// fantassin, 3 moves but not straight lines, check mountains
      		startx = Number(startx);
      		starty = Number(starty);
      		desty = Number(desty);
      		destx = Number(destx);
      		if(diffx == 2){
      			//si diffx == 2
      			if(Number(startx) > Number(destx) && Number(starty) < Number(desty)){
      			//2x gauche, 1x bas
      			indest = startx - 1;
      			indest2 = starty + 1;
      			indest = indest+"/"+starty;
      			indest2 = startx-1+"/"+indest2;

      			}else if(Number(startx) < Number(destx) && Number(starty) < Number(desty)){
      			//2x droite, 1x bas
      			indest = startx + 1;
      			indest2 = starty + 1;
      			indest = indest+"/"+starty;
      			indest2 = startx+1+"/"+indest2;

      			}else if(Number(startx) > Number(destx) && Number(starty) > Number(desty)){
      			//2x gauche, 1x haut
      			indest = startx - 1;
      			indest2 = starty - 1;
      			indest = indest+"/"+starty;
      			indest2 = startx-1+"/"+indest2;

      			}else if(Number(startx) < Number(destx) && Number(starty) > Number(desty)){
      			//2x droite, 1x haut
      			indest = startx + 1;
      			indest2 = starty - 1;
      			indest = indest+"/"+starty;
      			indest2 = startx+1+"/"+indest2;
      			}
      		}else{
      			//si diffy == 2
      			if(Number(startx) > Number(destx) && Number(starty) < Number(desty)){
      			//2x bas, 1x gauche
      			indest = starty + 1;
      			indest2 = startx - 1;
      			indest2 = indest2+"/"+indest;
      			indest = startx+"/"+indest;
      			}else if(Number(startx) < Number(destx) && Number(starty) < Number(desty)){
      			//2x bas, 1x droite
      			indest = starty + 1;
      			indest2 = startx + 1;
      			indest2 = indest2+"/"+indest;
      			indest = startx+"/"+indest;
      			}else if(Number(startx) > Number(destx) && Number(starty) > Number(desty)){
      			//2x haut, 1x gauche
      			indest = starty - 1;
      			indest2 = startx - 1;
      			indest2 = indest2+"/"+indest;
      			indest = startx+"/"+indest;
      			}else if(Number(startx) < Number(destx) && Number(starty) > Number(desty)){
      			//2x haut, 1x droite
      			indest = starty - 1;
      			indest2 = startx + 1;
      			indest2 = indest2+"/"+indest;
      			indest = startx+"/"+indest;
      			}
      		}
      		var mountfound = 0;
      		for(x=0; x < mountains.length; x++){
      			subm = mountains[x].posx+"/"+mountains[x].posy;
      			if(subm == indest || subm == indest2){
      				mountfound++;
      				if(mountfound == 2){
      					agree = false;
      					if(leavevtb != true){
      						eval(selchar).playable = true;
      					}
      					//un fantassin ne peut ni tuer à distance, ni se déplacer.
      					if(range >= 2 && type !='gunner'){
      						kill = false;
      					}
      				}
      			}
      		}
      		//same for water
      		for(x=0; x < waters.length; x++){
      			subm = waters[x].posx+"/"+waters[x].posy;
      			if(subm == indest || subm == indest2){
      				mountfound++;
      				if(mountfound == 2){
      					agree = false;
      					if(leavevtb != true){
      						eval(selchar).playable = true;
      					}
      					//un fantassin ne peut ni tuer à distance, ni se déplacer.
      					if(range >= 2 && type !='gunner'){
      						kill = false;
      					}
      				}
      			}
      		}
    	}

      	if((diffx == 3 || diffy == 3) && speed > 2){
      		startx = Number(startx);
      		starty = Number(starty);
      		desty = Number(desty);
      		destx = Number(destx);
      		if(diffx == 3){
      			if(Number(startx) > Number(destx)){
      				//gauche
      				indest = startx-2;
      				indest2 = startx-1;
      				indest = indest+"/"+starty;
      				indest2 = indest2+"/"+starty;
      			}else{
      				//droite
      				indest = startx+2;
      				indest2 = startx+1;
      				indest = indest+"/"+starty;
      				indest2 = indest2+"/"+starty;
      			}
      		}else if(Number(starty) > Number(desty)){
      			//haut
      			indest = starty-2;
      			indest2 = starty-1;
      			indest = startx+"/"+indest;
      			indest2 = startx+"/"+indest2;
      		}else{
      			//bas
      			indest = starty+2;
      			indest2 = starty+1;
      			indest = startx+"/"+indest;
      			indest2 = startx+"/"+indest2;
      		}
      		for(x=0; x < mountains.length; x++){
      			subm = mountains[x].posx+"/"+mountains[x].posy;
      			if(subm == indest || subm == indest2){
      				agree = false;
      				if(leavevtb != true){
      					eval(selchar).playable = true;
      				}
      				//un fantassin ne peut ni tuer à distance, ni se déplacer.
      				if(range == 3  && type !='gunner'){
      					kill = false;
      				}
      			}
      		}
      		//same for water
      		for(x=0; x < waters.length; x++){
      			subm = waters[x].posx+"/"+waters[x].posy;
      			if(subm == indest || subm == indest2){
      				agree = false;
      				if(leavevtb != true){
      					eval(selchar).playable = true;
      				}
      				//un fantassin ne peut ni tuer à distance, ni se déplacer.
      				if(range == 3  && type !='gunner'){
      					kill = false;
      				}
      			}
      		}
      	}
      	if(diff > speed && (type != "vtb")){
      		agree = false;
      		eval(selchar).playable = true;
      	}

      	//transport vtb
      	if(type != 'vtb' && type != 'tower' && agree == true){
      		for(i=0; i < unit.length; i++){
      			if(unit[i].posx == destx && unit[i].posy == desty){
      				if(unit[i].type == 'vtb' && unit[i].team == turn && unit[i].unitinside == 0 && diff <= speed && unit[i].cargo === false){
      					if(defaultmode == 1){
      						unit[i].unitinside = eval(selchar);
		      				eval(selchar).invtb(i);
		      				bgm.volume = 0.1;
		      				setTimeout(function(){bgm.volume=1}, 500);
		      				document.getElementById('getin').play();
		      				unit[i].upcargo();
		      				return
      					}
      				}
      			}
      		}
      	}

      	//transport cannon
      	if(type != 'tower' && agree == true && defaultmode == 1 && !isunit(selposx,selposy)){
      		for(i=0; i < cannons.length; i++){
      			if(cannons[i].posx == destx && cannons[i].posy == desty){
      				if(cannons[i].team == turn && cannons[i].unitinside == false && diff <= speed && type != "vtb"){
      					cannons[i].unitinside = eval(selchar);
		      			eval(selchar).incannon(i);
		      			bgm.volume = 0.1;
		      			setTimeout(function(){bgm.volume=1}, 500);
		      			document.getElementById('getin').play();
		      			cannons[i].upcargo();
		      			return
      				}
      			}
      		}
      	}

      	//leave vtb
      	var thisvillager = false;
      	if(type == 'vtb' && eval(selchar).unitinside != false && leavevtb == true){
      		if(diff == 1){
      			var unitfound = false;
      			for(i=0; i < unit.length; i++){
      				if(unit[i].posx == destx && unit[i].posy == desty){
      					if(unit[i].team == 3){
      						thisvillager = unit[i];
      					}else{
      						unitfound = true;
      					}
      				}
      			}

      			for(i=0; i < mountains.length; i++){
      				if(mountains[i].posx == destx && mountains[i].posy == desty){
      					unitfound = true;
      				}
      			}

      			for(i=0; i < waters.length; i++){
      				if(waters[i].posx == destx && waters[i].posy == desty){
      					unitfound = true;
      				}
      			}

      			for(i=0; i < cities.length; i++){
      				if(cities[i].posx == destx && cities[i].posy == desty && cities[i].team != team){
      					unitfound = true;
      				}
      			}

      			for(i=0; i < villages.length; i++){
      				if(villages[i].posx == destx && villages[i].posy == desty && villages[i].team != team){
      					unitfound = true;
      				}
      			}

      			for(i=0; i < cannons.length; i++){
      				if(cannons[i].posx == destx && cannons[i].posy == desty && cannons[i].team != team){
      					unitfound = true;
      				}
      			}

      			for(i=0; i < towns.length; i++){
      				if(towns[i].posx == destx && towns[i].posy == desty && towns[i].team != team){
      					unitfound = true;
      				}
      			}
      			if(unitfound == false){
      				// can take out the char
      				memoposx = destx;
	      			memoposy = desty;
	      			eval(selchar).outvtb();
	      			if(eval(selchar).leftmoves != 0){
      					eval(selchar).playable = true;
      				}
	      			poisonturninfection();
	      			bgm.volume = 0.1;
      				setTimeout(function(){bgm.volume=1}, 500);
	      			document.getElementById('getout').play();
	      			eval(selchar).delcargo();
	      			resetvisual();
	      			selchar = 'none';
	      			leavevtb = false;
	      			if(thisvillager != false){
	      				thisvillager.die();
	      				document.getElementById('sfx').currentTime = 0;
	      				document.getElementById('sfx').play();
	      			}
	      			return
      			}else{
      				//unit in the way
      				if(eval(selchar).moved == false){
      					eval(selchar).playable = true;
      				}
      				resetvisual();
      				selchar = 'none';
      				leavevtb = false;
 	     			return
      			}
      		}else{
      			//too far
      			if(eval(selchar).moved == false){
      				eval(selchar).playable = true;
      			}
      			resetvisual();
      			selchar = 'none';
      			leavevtb = false;
      			return
      		}
      	}

      	if(leavevtb == true){
      		if(eval(selchar).unitinside == false){
      			if(eval(selchar).moved == false){
      				eval(selchar).playable = true;
      			}
      		}
      		resetvisual();
      		selchar = 'none';
      		leavevtb = false;
      		return
      	}

      	if(type == 'napalm'){

      		if((defaultmode == 0 && diff <= 2) || diff == 3){
      			//shoots fire towards up
      			if(Number(startx) == Number(destx) && Number(starty) > Number(desty)){
	      			setfire(startx, Number(starty)-1, false);
	      			setfire(startx, Number(starty)-2, false);
	      			setfire(startx, Number(starty)-3, false);
	      			setfire(Number(startx)+1, Number(starty)-2, false);
	      			setfire(Number(startx)-1, Number(starty)-2, false);
	      			setfire(Number(startx)-1, Number(starty)-3, false);
	      			setfire(Number(startx)-2, Number(starty)-3, false);
	      			setfire(Number(startx)+1, Number(starty)-3, false);
	      			setfire(Number(startx)+2, Number(starty)-3, false);
	      			eval(selchar).playable = false;
	      			agree = false;
      				kill = false;
      				firekill();
      				firepoison();
      			}
      			//shoots fire towards down
      			else if(Number(startx) == Number(destx) && Number(starty) < Number(desty)){
	      			setfire(startx, Number(starty)+1, false);
	      			setfire(startx, Number(starty)+2, false);
	      			setfire(startx, Number(starty)+3, false);
	      			setfire(Number(startx)+1, Number(starty)+2, false);
	      			setfire(Number(startx)-1, Number(starty)+2, false);
	      			setfire(Number(startx)-1, Number(starty)+3, false);
	      			setfire(Number(startx)-2, Number(starty)+3, false);
	      			setfire(Number(startx)+1, Number(starty)+3, false);
	      			setfire(Number(startx)+2, Number(starty)+3, false);
	      			eval(selchar).playable = false;
	      			agree = false;
      				kill = false;
      				firekill();
      				firepoison();
      			}
      			//shoots fire towards right
      			else if(Number(starty) == Number(desty) && Number(startx) < Number(destx)){
	      			setfire(Number(startx)+1, starty, false);
	      			setfire(Number(startx)+2, starty, false);
	      			setfire(Number(startx)+3, starty, false);
	      			setfire(Number(startx)+2, Number(starty)+1, false);
	      			setfire(Number(startx)+2, Number(starty)-1, false);
	      			setfire(Number(startx)+3, Number(starty)-1, false);
	      			setfire(Number(startx)+3, Number(starty)-2, false);
	      			setfire(Number(startx)+3, Number(starty)+1, false);
	      			setfire(Number(startx)+3, Number(starty)+2, false);
	      			eval(selchar).playable = false;
	      			agree = false;
      				kill = false;
      				firekill();
      				firepoison();
      			}
      			//shoots fire towards left
      			else if(Number(starty) == Number(desty) && Number(startx) > Number(destx)){
	      			setfire(Number(startx)-1, starty, false);
	      			setfire(Number(startx)-2, starty, false);
	      			setfire(Number(startx)-3, starty, false);
	      			setfire(Number(startx)-2, Number(starty)+1, false);
	      			setfire(Number(startx)-2, Number(starty)-1, false);
	      			setfire(Number(startx)-3, Number(starty)-1, false);
	      			setfire(Number(startx)-3, Number(starty)-2, false);
	      			setfire(Number(startx)-3, Number(starty)+1, false);
	      			setfire(Number(startx)-3, Number(starty)+2, false);
	      			eval(selchar).playable = false;
      				agree = false;
      				kill = false;
      				firekill();
      				firepoison();
	      		}else{
	      			eval(selchar).playable = true;
      				agree = false;
      				kill = false;
	      		}
      		}else{
      			if(defaultmode == 0){
      				eval(selchar).playable = true;
      			}
      			kill = false;
      		}

      	}else if(type == 'poison'){
      		var thisunit = unit[isunit(destx,desty,true)];
      		if((defaultmode == 0 && diff <= 2)){
      			eval(selchar).playable = false;
      			agree = false;
      			kill = false;
      			if(isfire(destx,desty) || iswater(destx+"/"+desty)){
      					eval(selchar).playable = true;
      				}else if(thisunit){
      					if(thisunit.type != "tower"){
      					setpoison(Number(destx)+1, desty, team, 6, false, 1)
      					setpoison(Number(destx)-1, desty, team, 6, false, 1)
      					setpoison(Number(destx)+1, Number(desty)+1, team, 6, false, 1)
      					setpoison(Number(destx)-1, Number(desty)-1, team, 6, false, 1)
      					setpoison(Number(destx)+1, Number(desty)-1, team, 6, false, 1)
      					setpoison(Number(destx)-1, Number(desty)+1, team, 6, false, 1)
      					setpoison(destx, Number(desty)+1, team, 6, false, 1)
      					setpoison(destx, Number(desty)-1, team, 6, false, 1)
      					setpoison(destx, desty, team, 6, true, 1)
      					document.getElementById('splash').play();
      					bgm.volume = 0.1;
      					setTimeout(function(){bgm.volume = 0.2}, 1000);
      				}else{
      					eval(selchar).playable = true;
      				}
      			}else{
      				setpoison(Number(destx)+1, desty, team, 6, false, 1)
      				setpoison(Number(destx)-1, desty, team, 6, false, 1)
      				setpoison(Number(destx)+1, Number(desty)+1, team, 6, false, 1)
      				setpoison(Number(destx)-1, Number(desty)-1, team, 6, false, 1)
      				setpoison(Number(destx)+1, Number(desty)-1, team, 6, false, 1)
      				setpoison(Number(destx)-1, Number(desty)+1, team, 6, false, 1)
      				setpoison(destx, Number(desty)+1, team, 6, false, 1)
      				setpoison(destx, Number(desty)-1, team, 6, false, 1)
      				setpoison(destx, desty, team, 6, true, 1)
      				document.getElementById('splash').play();
      				bgm.volume = 0.1;
      				setTimeout(function(){bgm.volume = 0.2}, 1000);
      			}
      		}

      	}else if(type == 'builder' && diff > 2){
      		//si builder
      		kill = false;
      		eval(selchar).playable = true;
      	}else if(type == 'vtb'){
      		//si vtb
      		if(diff > 3){
      			kill = false;
      			agree = false;
      			eval(selchar).playable = true;
      		}
      	}else if(type == 'trumpet' && diff > 4){
      		//si trumpet
      		kill = false;
      		eval(selchar).playable = true;
      	}else if(eval(selchar).type == 'seg' && diff > 2){
      		//si seg
      		eval(selchar).playable = true;
      	}else if(type == 'fts' && diff > 3){
      		//si fantassin
      		kill = false;
      		eval(selchar).playable = true;
      	}else if(type == 'gunner' && (diff != 4 && diff != 3 && diff != 2)){
      		kill = false;
      	}else if(type == 'tower' && diff > 3){
      		kill = false;
      		eval(selchar).playable = true;
      	}else if(type == 'shield' && diff > 2){
      		kill = false;
      		eval(selchar).playable = true;
      	}else if(type == 'tank'){
      		if(diff != 4 && diff != 1){
      			kill = false;
      			eval(selchar).playable = true;
      		}
      	}else if(type == 'ninja'){
      		if(diff > 2){
      			kill = false;
      			eval(selchar).playable = true;
      		}
      	}

		for(x=0; x <= charlist.length-1; x++){
      		//check coords of each existing char
      		if(dest == getcharpos(eval(charlist[x])) ){
      			found = true;
      			// si l'attaquant est un gunner/tower/radio et que la cible est un shield
      			if((type == 'tower' || type == 'gunner' || type == 'radio') && eval(charlist[x]).type == 'shield'){
      				if(type == 'gunner' && diff != 1 && diff < 5){
      					laser.currentTime = 0;
      					document.getElementById('laser').play();
      					setTimeout(function(){document.getElementById('deflect').play()}, 200);
	      				kill = false;
      				}else if(type == 'tower' && diff < 4){
      					laser.currentTime = 0;
      					document.getElementById('laser').play();
      					setTimeout(function(){document.getElementById('deflect').play()}, 200);
	      				eval(selchar).playable = true;
	      				kill = false;
      				}else if(type == 'radio' && diff > 4 && diff < 9){
      					if(startx == destx || starty == desty){
      						document.getElementById('satellite_shot').play();
      						setTimeout(function(){document.getElementById('deflect').play()}, 200);
      					}
      				}
      			}

      			// si attaquant n'est pas un shield ou un tank et que la cible est un tower
      			if((type != 'shield' && type != 'tank') && eval(charlist[x]).type == 'tower'){
      				kill = false;
      			}

      			// si l'attaquant est un builder ou shlingus ou un trumpet
      			if(type == 'builder' || type == 'seg' || type == 'trumpet' || type == 'vtb'){
      				if(eval(charlist[x]).team != 3){
      					kill = false;
      					eval(selchar).playable = true;
      				}
      			}

      			//si trumpet, permet de rejouer l'unité cible
      			if(type == 'trumpet' && diff < 5){
      				if(eval(charlist[x]).team == team && eval(charlist[x]).playable == false && eval(charlist[x]).playedtwice == false){
      					eval(charlist[x]).playable = true;
      					eval(charlist[x]).playedtwice = true;
      					if(eval(charlist[x]).type == 'vtb'){
      						if(eval(charlist[x]).leftmoves == 0){
      							eval(charlist[x]).leftmoves = 1;
      						}
      					}
      					if(eval(charlist[x]).type == 'gunner'){
      						eval(charlist[x]).canreshoot = 0;
      					}
      					var unitnum = isunit(selposx,selposy);
      					document.getElementById("unit"+unitnum).classList.remove(unit[unitnum].type+unit[unitnum].skin+"_off");
        				document.getElementById("unit"+unitnum).classList.add(unit[unitnum].type+unit[unitnum].skin);
						eval(selchar).playable = false;
						document.getElementById('trumpet_1').currentTime = 0;
						document.getElementById('trumpet_1').play();
      				}
      			}

      			//portée d'attaque du satellite
      			if(type == 'radio' && diff != 5 && diff != 6 && diff != 7 && diff != 8){
      				kill = false;
      				eval(selchar).playable = true;
      			}

      			//satellite peut seulement tuer sauvages
      			if(type == 'radio' && (diff == 1 || diff == 2) && eval(charlist[x]).team == 3){
      				kill = true;
      				eval(selchar).playable = false;
      			}

      			if(type == 'napalm' && (diff == 1 || diff == 2) && agree == true){
      				kill = true;
      				eval(selchar).playable = false;
      			}

      			//gunner peut seulement tuer sauvages
      			if(type == 'gunner' && (diff == 1 || diff == 2) && eval(charlist[x]).team == 3){
      				kill = true;
      				eval(selchar).playable = false;
      			}

      			if(kill == true){

      				//tue la cible de la destination
      				document.getElementById('bgm').volume = 0.1;
      				if(type == 'gunner' || type == 'tower'){
      					//check for shield protection
      					var distxsh = 0;
      					var distxtr = 0;
      					var distysh = 0;
      					var distytr = 0;
      					var reldistsh = 0;
      					var reldisttr = 0;
      					var targetabs = 0;
      					var sniperabs = 0;
      					var shieldabs = 0;
      					for(i=0 ; i < charlist.length; i++){
      					
      						if(type == 'gunner' && kill == true && found == true){
      							if(eval(charlist[x]).team != 3){
      								eval(selchar).playable = false;
      								agree = false;
      							}
      						}

      						if(iswood(selposx+"/"+selposy) == true && eval(charlist[x]).type == 'ninja' && type == 'tower'){
								kill = false;
      						}

      						if(eval(charlist[i]).type == 'shield' && eval(charlist[i]).team != eval(selchar).team){
      							//distance target / shield
      							distxsh = Math.abs(eval(charlist[i]).posx - eval(charlist[x]).posx);
      							distysh = Math.abs(eval(charlist[i]).posy - eval(charlist[x]).posy);
      							reldistsh = Math.abs(parseInt(distxsh) + parseInt(distysh));

      							//distance target / sniper
      							distxtr = Math.abs(eval(charlist[x]).posx - startx);
      							distytr = Math.abs(eval(charlist[x]).posy - starty);
      							reldisttr = Math.abs(parseInt(distxtr) + parseInt(distytr));

      							//var check diagonal
      							targetabs = parseInt(eval(charlist[x]).posx) + parseInt(eval(charlist[x]).posy);
      							sniperabs = parseInt(startx) + parseInt(starty);
      							shieldabs = parseInt(eval(charlist[i]).posx) + parseInt(eval(charlist[i]).posy);
      							
      							//if shield is in between => posx
      							if(parseInt(eval(charlist[i]).posx) == parseInt(eval(charlist[x]).posx) /*&& distysh <= 3*/){
      								if(parseInt(eval(charlist[x]).posy) < parseInt(eval(charlist[i]).posy) && parseInt(eval(charlist[i]).posy) < starty){
      									if(parseInt(eval(charlist[i]).posx) == startx || parseInt(eval(charlist[i]).posy) == starty){
      										kill = false;
      										laser.currentTime = 0;
      										document.getElementById('laser').play();
      									 	setTimeout(function(){document.getElementById('deflect').play()}, 200);
      									}
      								}

      								if(parseInt(eval(charlist[x]).posy) > parseInt(eval(charlist[i]).posy) && parseInt(eval(charlist[i]).posy) > starty){
      									if(parseInt(eval(charlist[i]).posx) == startx || parseInt(eval(charlist[i]).posy) == starty){
      										kill = false;
      										laser.currentTime = 0;
      										document.getElementById('laser').play();
      								 		setTimeout(function(){document.getElementById('deflect').play()}, 200);
      								 	}
      								}
      							}

								//if shield is in between => posy
      							if(parseInt(eval(charlist[i]).posy) == parseInt(eval(charlist[x]).posy)/*&& distxsh <= 3*/){
      								if(parseInt(eval(charlist[x]).posx) < parseInt(eval(charlist[i]).posx) && parseInt(eval(charlist[i]).posx) < startx){
      									if(parseInt(eval(charlist[i]).posx) == startx || parseInt(eval(charlist[i]).posy) == starty){
      										kill = false;
      										laser.currentTime = 0;
      										document.getElementById('laser').play();
      								 		setTimeout(function(){document.getElementById('deflect').play()}, 200);
      								 	}
      								}

      								if(parseInt(eval(charlist[x]).posx) > parseInt(eval(charlist[i]).posx) && parseInt(eval(charlist[i]).posx) > startx){
      									if(parseInt(eval(charlist[i]).posx) == startx || parseInt(eval(charlist[i]).posy) == starty){
      										kill = false;
      										laser.currentTime = 0;
      										document.getElementById('laser').play();
      								 		setTimeout(function(){document.getElementById('deflect').play()}, 200);
      								 	}
      								}
      							}

      							//if all in diagonal
      							if(((targetabs == sniperabs && sniperabs == shieldabs) && reldistsh < reldisttr) || ((shieldabs+2 == targetabs &&  sniperabs+2 == shieldabs) && reldistsh < reldisttr) || ((targetabs+2 == shieldabs &&  shieldabs+2 == sniperabs) && reldistsh < reldisttr)){
      								if(parseInt(eval(charlist[x]).posx) != startx && parseInt(eval(charlist[x]).posy) != starty){
      									kill = false;
      									laser.currentTime = 0;
      									document.getElementById('laser').play();
      							 		setTimeout(function(){document.getElementById('deflect').play()}, 200);
      								}
      							}
      						}
      					}

      					//kill target if shield not protecting
      					if(kill == true){
	      					if((eval(charlist[x]).team != 3 && diff > 2) || eval(charlist[x].team != 3) && type == 'tower'){
	      						document.getElementById('laser').currentTime = 0;
	      						document.getElementById('laser').play();
	      						setTimeout(function(){document.getElementById('bgm').volume = 0.3;}, 500);
	      					}else if(eval(charlist[x]).team == 3 && diff <= 2 && defaultmode == 1){
	      						setTimeout(function(){document.getElementById('bgm').volume = 0.3;}, 500);
	      					}
	      					if(eval(charlist[x]).type == 'seg'){
	      						eval(charlist[x]).fart2();
	      					}else{
	      						sfx.currentTime = 0;
	      						document.getElementById('sfx').play();
	      						eval(charlist[x]).die();
	      					}
      					}
      				}else{
      					if(type != 'tank' && diff != 4){
      						if(type == 'radio'){
      								//check for shield protection
      								var distxsh = 0;
      								var distxtr = 0;
      								var distysh = 0;
      								var distytr = 0;
      								var reldistsh = 0;
      								var reldisttr = 0;
      								var targetabs = 0;
      								var sniperabs = 0;
      								var shieldabs = 0;
      								for(i=0 ; i < charlist.length; i++){
      									if(eval(charlist[i]).type == 'shield' && eval(charlist[i]).team != eval(selchar).team){
      										//distance target / shield
      										distxsh = Math.abs(eval(charlist[i]).posx - eval(charlist[x]).posx);
      										distysh = Math.abs(eval(charlist[i]).posy - eval(charlist[x]).posy);
      										reldistsh = Math.abs(parseInt(distxsh) + parseInt(distysh));

      										//distance target / sniper
      										distxtr = Math.abs(eval(charlist[x]).posx - startx);
      										distytr = Math.abs(eval(charlist[x]).posy - starty);
      										reldisttr = Math.abs(parseInt(distxtr) + parseInt(distytr));
      							
      											//if shield is in between => posx
			      							if(parseInt(eval(charlist[i]).posx) == parseInt(eval(charlist[x]).posx)/* && distysh <= 2*/){
			      								if(parseInt(eval(charlist[x]).posy) < parseInt(eval(charlist[i]).posy) && parseInt(eval(charlist[i]).posy) < starty){
      												kill = false;
      												eval(selchar).playable = false;
      											 	setTimeout(function(){document.getElementById('deflect').play()}, 200);
			      								}

      											if(parseInt(eval(charlist[x]).posy) > parseInt(eval(charlist[i]).posy) && parseInt(eval(charlist[i]).posy) > starty){
      												kill = false;
      												eval(selchar).playable = false;
      											 	setTimeout(function(){document.getElementById('deflect').play()}, 200);
      											}
			      							}

											//if shield is in between => posy
      										if(parseInt(eval(charlist[i]).posy) == parseInt(eval(charlist[x]).posy)/*&& distxsh <= 2*/){
      											if(parseInt(eval(charlist[x]).posx) < parseInt(eval(charlist[i]).posx) && parseInt(eval(charlist[i]).posx) < startx){
			      									kill = false;
			      									eval(selchar).playable = false;
      											 	setTimeout(function(){document.getElementById('deflect').play()}, 200);
      											}

      											if(parseInt(eval(charlist[x]).posx) > parseInt(eval(charlist[i]).posx) && parseInt(eval(charlist[i]).posx) > startx){
      												kill = false;
      												eval(selchar).playable = false;
			      								 	setTimeout(function(){document.getElementById('deflect').play()}, 200);
      											}
      										}
      									}
      								}
      							//if is not a villager, shoot
      							if(eval(charlist[x]).team == 3 && diff <= 2){
      								document.getElementById('sfx').currentTime = 0;
      								document.getElementById('sfx').play();
      								setTimeout(function() {document.getElementById('bgm').volume = 0.3;}, 1500);
      							}else{
      								if(startx == destx || starty == desty){
      									bgm.volume = 0;
      									document.getElementById('satellite_shot').play();
      									setTimeout(function() {document.getElementById('bgm').volume = 0.3;}, 2500);	
      								}else{
      									kill = false;
      									document.getElementById('bgm').volume = 0.3;
      								}
      							}
      							if(kill == true){
      							
      								if(eval(charlist[x]).type == 'seg'){
      									eval(charlist[x]).fart2();
      								}else if(eval(charlist[x]).type != 'shield'){
      									eval(charlist[x]).die();
      								}
      								eval(selchar).playable = false;
      							}

      						}else{
      							if(eval(charlist[x]).type != 'tower'){
	      							document.getElementById('sfx').currentTime = 0;
	      							document.getElementById('sfx').play();
      							}else{
	      							collapse.currentTime = 0;
      								collapse.play();
      							}
      							setTimeout(function() {document.getElementById('bgm').volume = 0.3;}, 1500);
      							if(eval(charlist[x]).type == 'seg'){
      								eval(charlist[x]).fart2();
      							}else{
      								if(eval(charlist[x]).type == 'vtb' && eval(charlist[x]).unitinside != 0){
      									eval(charlist[x]).unitinside.die();
      								}
      								if(type == 'ninja' && eval(charlist[x]).team != team){
      									if(eval(charlist[x]).type != "villager"){
      										eval(selchar).playable = true;
      									}
      								}
      								eval(charlist[x]).die();
      							}
      						}
      					}else{
      						if(type == 'tank'){
      							if(diff == 1){
      								document.getElementById('sfx').currentTime = 0;
      								document.getElementById('sfx').play();
      								setTimeout(function(){document.getElementById('bgm').volume = 0.3;}, 1500);
      								if(eval(charlist[x]).type == 'seg'){
      									eval(charlist[x]).fart2();
      								}else{
      									eval(charlist[x]).die();
      								}
      							}else if(diff == 4){
      								if(eval(charlist[x]).type == 'shield'){
      									shilded = true;
      								}else if(eval(charlist[x]).type == 'tower'){
      									shieldtower = true;
      									collapse.play();
      								}
      							}
      						}
      					}
      				}
      			}
      		}
      	}
      	
      	//if radio shoots the air
      	if(type == 'radio' && (diff == 5 || diff == 6 || diff == 7 || diff == 8) && found == false){
      		//si pas en ligne droite de 5/6/7/8 cases
      		if(startx == destx || starty == desty){
      			bgm.volume = 0;
      			document.getElementById('satellite_shot').play();
      			setTimeout(function() {document.getElementById('bgm').volume = 0.3;}, 2500);
      			eval(selchar).playable = false;
      		}
      	}

      	if(type == "fts" && agree == true){
      		sidekill(destx, desty, team);
      	}

      	if(type == "gunner" && (diff == 1 || diff == 2)){
      		if(defaultmode == 0){
      			agree = false;
      		}
      	}

      	if(type == "gunner"){
    		if(diff == 2 || diff == 3 || diff == 4){
			//when gunner shot from distance, can't replay
      			if(agree == false){
      				eval(selchar).playable = false;
      				laser.currentTime = 0;
	      			document.getElementById('laser').play();
    			}
      		}
      	}

      	if(agree == true && kill == false && found == true && ai == false){
      		//can't move on a tile if ennemy doesn't die
			agree = false;
			if(type != 'trumpet'){
				if(type == 'gunner'){
					if(diff == 1){
						eval(selchar).playable = true;
					}
				}else{
					eval(selchar).playable = true;
				}
			}
			var iswoodninja = isunit(destx, desty);
			if(iswoodninja !== false){
				if(unit[iswoodninja].type == "ninja" && iswood(destx+"/"+desty ,false)){
					eval(selchar).playable = false;
					amogus.play();
					eval(unit[iswoodninja].id).style.display = "block";
					bgm.volume = 0.1;
					setTimeout(function(){bgm.volume = 0.2},3500);
					unit[iswoodninja].amogus = true;
					tempsave();
				}
			}
		}

		if(type == 'gunner' && defaultmode == 0 && diff == 1){
			eval(selchar).playable = true;
		}

		if(agree == true && ai == false){
			for(x=0; x < cities.length; x++){
      			if(dest == cities[x].posx+"/"+cities[x].posy){
      				if(cities[x].team != team){
      					if(found == true && (type == 'gunner' || type == "tower")){
      						//nothing. gunner can't capture city when shouting on an enemy 
      					}else{
      						capture(team, destx, desty);
      					}
      				}
      			}
      		}
      	}

      	if(agree == true && ai == false){
			for(x=0; x < villages.length; x++){
      			if(dest == villages[x].posx+"/"+villages[x].posy){
      				eval(selchar).infected = false;
      				if(villages[x].team != team){
      					if(found == true && (type == 'gunner' || type == "tower")){
      						//nothing. gunner can't capture city when shouting on an enemy 
      					}else{
      						captureVillage(destx, desty, team, false);
      						bgm.volume = 0.1;
      						document.getElementById('house').play();
      						setTimeout(function(){bgm.volume = 0.2}, 1000); 
      						if(isnight == 1 && enableShadows > 0){
	      						shadowExList();
      						}
      					}
      				}
      			}
      		}
      	}

      	if(type == 'gunner' && agree == false && diff > 1 && diff < 5){
      		//check if gunner can reshoot
      		if(eval(selchar).canreshoot == 0){
				eval(selchar).canreshoot++;
      			eval(selchar).playable = true;
      		}else{
      			eval(selchar).canreshoot = 0;
      		}
      	}

      	if(type == 'tower' && found == false){
      		eval(selchar).playable = true;
      	}

      	if(type == 'tank' && diff == 4){
      		if(shilded == false){
	      		var destxp1 = Number(destx)+1;
	      		var destxm1 = destx-1;
	      		var destyp1 = Number(desty)+1;
	      		var destym1 = desty-1;
	      		var sumdest = destx+'/'+desty;
	      		var sumdestleft = destxm1+'/'+desty;
	      		var sumdestright = destxp1+'/'+desty;
	      		var sumdesttop = destx+'/'+destym1;
	      		var sumdestbottom = destx+'/'+destyp1;
      			for(l=0 ; l < unit.length; l++){
      				if(shieldtower == false && sumdestleft == unit[l].posx+'/'+unit[l].posy && (unit[l].type != 'tower' && unit[l].type != 'shield')){

     	 				if(unit[l].type == 'seg'){
     	 					unit[l].fart2();
     	 				}else{
     	 					unit[l].die();
     	 				}
     	 			}
     				if(shieldtower == false && sumdestright == unit[l].posx+'/'+unit[l].posy && (unit[l].type != 'tower' && unit[l].type != 'shield')){

    	 				if(unit[l].type == 'seg'){
    	  					unit[l].fart2();
    	  				}else{
    	  					unit[l].die();
    	  				}
    	  			}
	      			if(shieldtower == false && sumdesttop == unit[l].posx+'/'+unit[l].posy && (unit[l].type != 'tower' && unit[l].type != 'shield')){

      					if(unit[l].type == 'seg'){
      						unit[l].fart2();
      					}else{
      						unit[l].die();
      					}
      				}
      				if(shieldtower == false && sumdestbottom == unit[l].posx+'/'+unit[l].posy && (unit[l].type != 'tower' && unit[l].type != 'shield')){

      					if(unit[l].type == 'seg'){
      						unit[l].fart2();
      					}else{
      						unit[l].die();
      					}
      				}

      				if(sumdest == unit[l].posx+'/'+unit[l].posy && unit[l].type != 'shield'){

      					if(unit[l].type == 'seg'){
      						unit[l].fart2();
      					}else{
      						unit[l].die();
      					}
      				}
      				if(ismountain(destx+'/'+desty)){
      					casen = 1; 
      					sdmount(destx, desty);
      					draw(destx, desty);
      				}else if(isbridge(destx+'/'+desty)){
      					casen = 9;
      					sdbridge(destx, desty);
      					draw(destx, desty);
      				}else if(iscannon(destx+'/'+desty)){
      					casen = 1;
      					sdcannon(destx, desty);
      					draw(destx, desty);
      				}else if(istown(destx+'/'+desty)){
      					casen = 1;
      					sdtown(destx, desty);
      					draw(destx, desty);
      				}
      			}
      		}
      		document.getElementById('bgm').volume = 0.1;
	      	eval(selchar).playable = false;
	      	agree = false;
	      	if(shilded == true){
      			document.getElementById('muffled').play();
	      	}else{
      			document.getElementById('bomb').play();
	      	}
      		setTimeout(function() {document.getElementById('bgm').volume = 0.3;}, 1400);
      	}

      	//if builder && destination == wood, switch wood to plain and gain 50 gold
      	if(iswood(destx+'/'+desty) == true && type == 'builder' && agree == true){
      		if(team == 1){
      			sdwood(destx,desty);
      			casen = 1;
      			draw(destx, desty);
      			balanceteam1 = balanceteam1 + 50;
      			updatemoney();
      			document.getElementById('tree').currentTime = 0;
      			document.getElementById('tree').play();
      			document.getElementById('cash50').style.opacity = 1;
				setTimeout(function(){document.getElementById('cash50').style.opacity = 0}, 1500);
      		}else if(team == 2){
      			sdwood(destx,desty);
      			casen = 1;
      			draw(destx, desty);
      			balanceteam2 = balanceteam2 + 50;
      			updatemoney();
      			document.getElementById('tree').currentTime = 0;
      			document.getElementById('tree').play();
      			document.getElementById('cash50').style.opacity = 1;
				setTimeout(function(){document.getElementById('cash50').style.opacity = 0}, 1500);
      		}
      		
      		if(eval(selchar).cuttree == 0){
      			eval(selchar).cuttree++;
      			eval(selchar).playable = true;
      		}else{
      			eval(selchar).cuttree = 0;
      		}
      	}

      	//when infected unit walks
      	if(agree == true){
      		var poisoned = ispoison(selposx,selposy);
      	}

      	if(poisonmemo != -1){
      		if(poisonmap[poisonmemo].team != team){
      			if(team == 1){
      			var _team = 2; 
      		}else{
      			var _team = 1;
      		}
      		memofirstpoison = eval(selchar).numid;
      		setpoison(Number(destx)+1, Number(desty), _team, 3, false, 0);
      		setpoison(Number(destx)-1, Number(desty), _team, 3, false, 0);
      		setpoison(Number(destx), Number(desty)-1, _team, 3, false, 0);
      		setpoison(Number(destx), Number(desty)+1, _team, 3, false, 0);
      		setpoison(Number(destx), Number(desty), _team, 3, true, 0);
      		poisonhide();
      		}
      	}

      	if(eval(selchar).infected != false && agree == true){
      		if(team == 1){
      			var _team = 2; 
      		}else{
      			var _team = 1;
      		}
      		memofirstpoison = eval(selchar).numid;
      		setpoison(Number(destx)+1, Number(desty), _team, 3, false, 0);
      		setpoison(Number(destx)-1, Number(desty), _team, 3, false, 0);
      		setpoison(Number(destx), Number(desty)-1, _team, 3, false, 0);
      		setpoison(Number(destx), Number(desty)+1, _team, 3, false, 0);
      		setpoison(Number(destx), Number(desty), _team, 3, true, 0);
      		poisonhide();
      	}

      	if(type == 'vtb' && agree == true){
      		stopengine.currentTime = 0;
      		stopengine.play();
      		eval(selchar).leftmoves--;
      		if(iscity(startx+'/'+starty, false) == true || isvillage(startx+'/'+starty) == true || istown(startx+'/'+starty, false) == true){
      			if(eval(selchar).leftmoves != 0){
      				eval(selchar).playable = true;
      			}
      		} 
      	}

      	if((type == 'fts' || type == 'ninja') && kill == true && found == true){
      		slash.currentTime = 0;
      		slash.play();
      	}

      	if(eval(selchar).playable == false && eval(selchar).id && ai == false){
      		//set skin as played
      		if(type == 'villager' && team == 3){
      			document.getElementById(id).classList.remove('villager'+skin);
        		document.getElementById(id).classList.add('villager'+skin+"_off");
      		}else if(cpuOn == true && team == 2){
      			//cpu skin
      			document.getElementById(id).classList.remove('villager'+skin);
        		document.getElementById(id).classList.add('villager'+skin+"_off");
      		}else{
      			document.getElementById(id).classList.remove(type+skin);
        		document.getElementById(id).classList.add(type+skin+"_off");
      		}
      	}

      	if(citiesTeam2 == 0){
      		victory(1);
    	}

    	if(citiesTeam1 == 0){
      		victory(2);
    	}

    	//if unit walk into poison, check for infection 
      	if(ispoison(destx,desty) == true && agree == true){
      		tryinfect(poisonmemo, eval(selchar), 4);
      	}

		return agree;
	}

	function victory(team){
    		bgm.pause();
    		document.getElementById('victory_theme').play();
    		document.getElementById('victory_splashscreen').style.opacity = 1;
    		if(team == 1){
    			document.getElementById('victory_bigslime').style.background = "url('tiles/villager"+player1+"/1.png')";
    			document.getElementById('victory_splashscreen').src = "tiles/victory_splash"+player1+".png";
    		}else{
    			document.getElementById('victory_bigslime').style.background = "url('tiles/villager"+player2+"/1.png')";
    			document.getElementById('victory_splashscreen').src = "tiles/victory_splash"+player2+".png";
    		}
    		document.getElementById('victory_bigslime').style.opacity = 1;
    	}

	function mvchar(char, x, y){
		//move a character to a specific position (x:0~xtiles, y:0~ytiles)
		char.posx = x;
		char.posy = y;
	document.getElementById(char.id).style.left = (char.posx*64+17)+marginsizex+'px';
		document.getElementById(char.id).style.top = (char.posy*64+10)+marginsizey+'px';

    	if(char.type != 'tower'){
      		selchar = "none";
      		resetvisual();
    		gaskill();
    		firekill();
      	}
      	if(char.team == 1){
      		var townfound = istown(x+'/'+y, true);
      		if(townfound != false || townfound === 0){
      			if(checktown(towns[townfound].posx, towns[townfound].posy) == 2){
      				casen = 1;
      				sdtown(x,y);
      				draw(x,y)
      				townteam2--;
      			}
      		}
      	}else if(char.team == 2){
      		var townfound = istown(x+'/'+y, true);
      		if(townfound != false || townfound === 0){
      			if(checktown(towns[townfound].posx, towns[townfound].posy) == 1){
      				casen = 1;
      				sdtown(x,y);
      				draw(x,y)
      				townteam1--;
      			}
      		}
      	}
      	if(char.team == 1){
      		var cannonfound = iscannon(x+'/'+y, true);
      		if(cannonfound != false || cannonfound === 0){
      			if(checkcannon(cannons[cannonfound].posx, cannons[cannonfound].posy) == 2){
      				casen = 1;
      				sdcannon(x,y);
      				draw(x,y)
      			}
      		}
      	}else if(char.team == 2){
      		var cannonfound = iscannon(x+'/'+y, true);
      		if(cannonfound != false || cannonfound === 0){
      			if(checkcannon(cannons[cannonfound].posx, cannons[cannonfound].posy) == 1){
      				casen = 1;
      				sdcannon(x,y);
      				draw(x,y)
      			}
      		}
      	}

      	if(char.team == 3){
      		//plant tree
      		if(isplain(x+'/'+y)){
      			if(Math.floor(Math.random()*2) == 1 && isfire(x,y) == false){
	      			casen = 2;
	      			sdplain(x,y);
    	  			draw(x,y);
    	  		}
      		}
      	}

      	if(char.type == 'builder'){
      		var townN = istown(x+'/'+y, true);
      		if((townN != false || townN === 0) && towns[townN].lastquality == 0){
      			if(towns[townN].team == 1){
      				townteam1--;
      			}else{
      				townteam2--;
      			}
      			casen = 1;
      			sdtown(x,y);
      			draw(x,y);
      		}
      	}
      	if(char.type == 'vtb'){
      		char.moved = true;
      		char.upcargo();
      		var townN = istown(x+'/'+y, true);
      		if(townN != false || townN === 0){
      			if(towns[townN].progression <= 0 && (char.cargo == false && char.cargo !== 0 && char.unitinside == false) && towns[townN].lastquality != 0){
      				char.cargoQ = towns[townN].lastquality;
      				towns[townN].newprog();
      				char.cargo = townN;
      				char.upcargo();
      				cargosound();
	      			}
      		}else{
      			var villageN = isvillage2(x+'/'+y);
      			if(villageN != false || villageN === 0){
      				if(char.cargo != false || char.cargo === 0){
      					sellcargo(char.cargoQ);
      					char.delcargo();
      					char.cargo = false;
      				}
      			}	
      		}
      	}
	}

	function cargosound(){
		if(turn == 1){
      		switch(player1){
      			case "1":
      			case "7":
      			document.getElementById('cargosfx').src = "sfx/cargo.mp3";
      			break

      			case "2":
      			case "4":
      			document.getElementById('cargosfx').src = "sfx/cargo3.mp3";
      			break

      			default:
      			document.getElementById('cargosfx').src = "sfx/cargo2.mp3";
      		}
      	}else{
      		switch(player2){
      			case "1":
      			case "7":
      			document.getElementById('cargosfx').src = "sfx/cargo.mp3";
      			break

      			case "2":
      			case "4":
      			document.getElementById('cargosfx').src = "sfx/cargo3.mp3";
     			break

      			default:
      			document.getElementById('cargosfx').src = "sfx/cargo2.mp3";
      		}
	    }
	    	bgm.volume = 0.1;
	    	setTimeout(function(){bgm.volume = 0.2}, 1500);
      		cargosfx.currentTime = 0;
      		cargosfx.play();
	}

	function getcharpos(char){
		//return a character's position eg: 20/7
		if(char){
			return eval(char.posx)+"/"+eval(char.posy);
		}
	}

	function create(type, team, x, y, origin, canplay, canplaytwice, unitin, carg, cargq, canresh, cutt, isinfect, loadvtb, loadmoved, loadleftmoves, loadcannon, loadamogus){
		charlist.push('unit['+cur_uniId+']');
		unit[cur_uniId] = new createunit(type, team, x, y, origin, canplay, canplaytwice, unitin, carg, cargq, canresh, cutt, isinfect, loadvtb, loadmoved, loadleftmoves, loadcannon, loadamogus);
		unit[cur_uniId].spawn();
		gaskill();
		if(unit[cur_uniId].team == 3){
			document.getElementById('spawn2').play();
		}else if(unit[cur_uniId].team == 1){
			if(player1 == 1 || player1 == 3 || player1 == 7){
				document.getElementById('spawn').currentTime = 0;
				document.getElementById('spawn').play();
			}else{
				document.getElementById('spawn').currentTime = 0;
				document.getElementById('spawn3').play();
			}
		}else{
			if(player2 == 1 || player2 == 3 || player2 == 7){
				document.getElementById('spawn').currentTime = 0;
				document.getElementById('spawn').play();
			}else{
				document.getElementById('spawn').currentTime = 0;
				document.getElementById('spawn3').play();
			}
		}
		cur_uniId++;
	}

	function updatemoney(){
		if(legoteam1 > 20){
			legoteam1 = 20;
		}
		if(legoteam2 > 20){
			legoteam2 = 20;
		}
		if(turn == 1){
			if(legoteam1 == 20){
				document.getElementById('money').innerHTML = balanceteam1+" 🪙<br>"+eval('citiesTeam'+1)*50+" 🪙/Tour<br><span class='rgb'>"+legoteam1+"§</span><br>"+eval(villageteam1+1)+"§/Tour";
			}else{
				document.getElementById('money').innerHTML = balanceteam1+" 🪙<br>"+eval('citiesTeam'+1)*50+" 🪙/Tour<br>"+legoteam1+"§<br>"+eval(villageteam1+1)+"§/Tour";
			}
		}else{
			if(legoteam2 == 20){
				document.getElementById('money').innerHTML = balanceteam2+" 🪙<br>"+eval('citiesTeam'+2)*50+" 🪙/Tour<br><span class='rgb'>"+legoteam2+"§</span><br>"+eval(villageteam2+1)+"§/Tour";
			}else{
				document.getElementById('money').innerHTML = balanceteam2+" 🪙<br>"+eval('citiesTeam'+2)*50+" 🪙/Tour<br>"+legoteam2+"§<br>"+eval(villageteam2+1)+"§/Tour";
			}
		}
	}

	function capture(t, x, y){
		for(i=0; i < cities.length; i++){
    	  	if(x == cities[i].posx && y == cities[i].posy){
    	  		if(t == 1){
    	  			citiesTeam1++;
    	  			if(eval(cities[i]).team == 2){
    	  				citiesTeam2--;
    	  			}
    	  				document.getElementById('bgm').volume = 0.1;
      					setTimeout(function(){document.getElementById('bgm').volume = 0.3;}, 2200);
      					if(player1 == 1){
    	  					ctx.drawImage(image, 297, 0, 99, 100, x*64, y*64, 64, 64);
    	  					document.getElementById('capta').currentTime = 0;
    	  					document.getElementById('capta').play();
      					}else if(player1 == 2){
    	  					ctx.drawImage(image, 792, 0, 99, 100, x*64, y*64, 64, 64);
    	  					document.getElementById('captb').currentTime = 0;
    	  					document.getElementById('captb').play();
    	  				}else if(player1 == 3){
    	  					ctx.drawImage(image, 2476, 0, 99, 100, x*64, y*64, 64, 64);
    	  					document.getElementById('captb').currentTime = 0;
    	  					document.getElementById('captb').play();
      					}else if(player1 == 4){
    	  					document.getElementById('capta').currentTime = 0;
    	  					document.getElementById('capta').play();
    	  					ctx.drawImage(image, 891, 0, 99, 100, x*64, y*64, 64, 64);
      					}else if(player1 == 5){
      						
      						document.getElementById('capta').currentTime = 0;
      						document.getElementById('capta').play();
    	  					ctx.drawImage(image, 1089, 0, 99, 100, x*64, y*64, 64, 64);
      					}else if(player1 == 6){
      						document.getElementById('captb').currentTime = 0;
      						document.getElementById('captb').play();
    	  					ctx.drawImage(image, 1386, 0, 99, 100, x*64, y*64, 64, 64);
      					}else if(player1 == 7){
      						document.getElementById('capta').currentTime = 0;
      						document.getElementById('capta').play();
    	  					ctx.drawImage(image, 1485, 0, 99, 100, x*64, y*64, 64, 64);
    	  				}
    	  		}else if(t == 2){
    	  			citiesTeam2++;
    	  			if(eval(cities[i]).team == 1){
    	  				citiesTeam1--;
    	  			}
    	  				document.getElementById('bgm').volume = 0.1;
      					setTimeout(function(){document.getElementById('bgm').volume = 0.3;}, 3000);
    	  				if(player2 == 1){
    	  					ctx.drawImage(image, 297, 0, 100, 100, x*64, y*64, 64, 64);
    	  					document.getElementById('capta').currentTime = 0;
    	  					document.getElementById('capta').play();
      					}else if(player2 == 2){
    	  					ctx.drawImage(image, 792, 0, 100, 100, x*64, y*64, 64, 64);
    	  					document.getElementById('captb').currentTime = 0;
    	  					document.getElementById('captb').play();
    	  				}else if(player2 == 3){
    	  					ctx.drawImage(image, 2476, 0, 99, 100, x*64, y*64, 64, 64);
    	  					document.getElementById('captb').currentTime = 0;
    	  					document.getElementById('captb').play();
      					}else if(player2 == 4){
    	  					document.getElementById('capta').currentTime = 0;
    	  					document.getElementById('capta').play();
    	  					ctx.drawImage(image, 891, 0, 100, 100, x*64, y*64, 64, 64);
      					}else if(player2 == 5){
      						document.getElementById('capta').currentTime = 0;
      						document.getElementById('capta').play();
    	  					ctx.drawImage(image, 1089, 0, 100, 100, x*64, y*64, 64, 64);
      					}else if(player2 == 6){
      						document.getElementById('captb').currentTime = 0;
      						document.getElementById('captb').play();
    	  					ctx.drawImage(image, 1386, 0, 100, 100, x*64, y*64, 64, 64);
      					}else if(player2 == 7){
      						document.getElementById('capta').currentTime = 0;
      						document.getElementById('capta').play();
    	  					ctx.drawImage(image, 1485, 0, 100, 100, x*64, y*64, 64, 64);
    	  				}
    	  			}
    	  		cities[i].team = t;
    	  		updatemoney();
    	  	}
    	}
	}

	function captureVillage(x,y,t,built){
		var tileposx = 0;
		var originvillage = -1;
		for(i=0; i < villages.length; i++){
			if(villages[i].posx == x && villages[i].posy == y){

				if(villages[i].team == 1){
					//village from team 1 gets captured
					villageteam1--;
					//townprogressionupdate(1, "plus");
				}else if(villages[i].team == 2){
					//village from team 2 gets captured
					villageteam2--;
					//townprogressionupdate(2, "plus");
				}else if(villages[i].team == 3){
				//if captured village isn't neutral
					if(editmode == 0 && built == false){
						document.getElementById('cash100').style.opacity = 1;
						setTimeout(function(){document.getElementById('cash100').style.opacity = 0}, 1500);
						if(t == 1){
							balanceteam1 += 100;
						}else{
							balanceteam2 += 100;
						}
					}
				}

				villages[i].team = t;
				originvillage = i;
				var player = 0;
				if(t == 1){
					player = player1;
					//townprogressionupdate(1, "minus");
					villageteam1++;
				}else if (t == 2){
					player = player2;
					//townprogressionupdate(2, "minus");
					villageteam2++;
				}else{
					player = player3;
				}
				switch(player){
					case '1':
					tileposx = 1783;
					break
					
					case '2':
					tileposx = 1882;
					break
					
					case '3':
					tileposx = 1684;
					break
					
					case '4':
					tileposx = 1981;
					break
				
					case '5':
					tileposx = 2080;
					break
			
					case '6':
					tileposx = 2179;
					break
		
					case '7':
					tileposx = 2278;
					break
				}
				ctx.drawImage(image, tileposx, 0, 100, 100, x*64, y*64, 64, 64);
			}
			updatemoney();
		}

		for(i=0; i < unit.length; i++){
			if(unit[i].team == 3){
				if(originvillage == unit[i].origin){
					unit[i].teamskin = turn;
					document.getElementById("unit"+i).classList.remove('villager'+unit[i].skin);
					if(turn == 1){
						unit[i].skin = player1;
					}else{
						unit[i].skin = player2;
					}
        			document.getElementById("unit"+i).classList.add('villager'+unit[i].skin);
				}

			}
		}
	}

	function isunit(x,y,char_numid){
		for(o=0; o < unit.length; o++){
			if(unit[o].posx == x && unit[o].posy == y){
				if(char_numid == false){
					return true
				}else{
					return unit[o].numid
				}
			}
		}
		return false
	}

	function isfire(x,y){
		for(o=0; o < firemap.length; o++){
			if(firemap[o] == x+"/"+y){
					return true
			}
		}
		for(o=0; o < firemap2.length; o++){
			if(firemap2[o] == x+"/"+y){
					return true
			}
		}

		return false
	}

	function treecycle(){
		if(turnstotal == 0){return}
		var treepx = -1;
		var treepy = -1;
		var checkposx = -1; 
		var checkposy = -1;
		var randnum = -1;
		var max = woods.length;
		for(i=0; i < max; i++){
			treepx = woods[i].posx;
			treepy = woods[i].posy;

			//right
			checkposx = parseInt(treepx)+1;
			checkposy = treepy;
			if(isplain(checkposx+"/"+checkposy)){
				randnum = Math.floor(Math.random()*12);
				//1 chance sur 16 de planter arbre
				if(randnum === 1){
					if(isunit(checkposx, checkposy, false) == false && isfire(checkposx, checkposy) == false){
						casen = 2;
      					sdplain(checkposx,checkposy);
      					draw(checkposx,checkposy);
					}
				}
			}

			//left
			checkposx = treepx-1;
			if(isplain(checkposx+"/"+checkposy)){
				randnum = Math.floor(Math.random()*12);
				//1 chance sur 16 de planter arbre
				if(randnum === 1){
					if(isunit(checkposx, checkposy, false) == false && isfire(checkposx, checkposy) == false){
						casen = 2;
      					sdplain(checkposx,checkposy);
      					draw(checkposx,checkposy);
					}
				}
			}

			//bottom
			checkposx = treepx;
			checkposy = parseInt(treepy)+1;
			if(isplain(checkposx+"/"+checkposy)){
				randnum = Math.floor(Math.random()*12);
				//1 chance sur 16 de planter arbre
				if(randnum === 1){
					if(isunit(checkposx, checkposy, false) == false && isfire(checkposx, checkposy) == false){;
						casen = 2;
      					sdplain(checkposx,checkposy);
      					draw(checkposx,checkposy);
					}
				}
			}

			//top
			checkposy = treepy-1;
			if(isplain(checkposx+"/"+checkposy)){
				randnum = Math.floor(Math.random()*12);
				//1 chance sur 16 de planter arbre
				if(randnum === 1){
					if(isunit(checkposx, checkposy, false) == false && isfire(checkposx, checkposy) == false){
						casen = 2;
      					sdplain(checkposx,checkposy);
      					draw(checkposx,checkposy);
					}
				}
			}
		}
	}

	function newplace(type, x, y, q, sleft, team){
		switch(type){
			case'plain':
			plains[plainsN] = new plain(x,y);
			plainsN++;
			break

			case'wood':
			woods[woodsN] = new wood(x,y);
			woodsN++;
			break

			case'mountain':
			mountains[mountainsN] = new mountain(x,y);
			mountainsN++;
			break

			case'city':
			cities[citiesN] = new city(x,y);
			citiesN++;
			break

			case'town':
			towns[townN] = new town(x,y,q);
			townN++;
			break

			case'cannon':
			cannons[cannonN] = new cannon(x,y,q,sleft,team);
			cannonN++;
			break

			case'water':
			waters[watersN] = new water(x,y);
			watersN++;
			break

			case'bridge':
			bridges[bridgesN] = new bridge(x,y);
			bridgesN++;
			break

			case'village':
			villages[villageN] = new village(x,y,sleft,team);
			villageN++
		}
	}

	function resetvisual(){
		defaultmode = 1
		document.getElementById('selection').style.background = 'black';
		document.getElementById('tankrange').style.top = -30*64+"px";
		document.getElementById('radiorange').style.top = -30*64+"px";
		document.getElementById('napalm_range').style.top = -30*64+"px";
		document.getElementById('speed1').style.top = -30*64+"px";
		document.getElementById('speed2').style.top = -30*64+"px";
		document.getElementById('speed2').style.left = -30*64+"px";
		document.getElementById('gunnerange').style.top = -30*64+"px";
		document.getElementById('gunnerange').style.left = -30*64+"px";
		document.getElementById('speed3').style.top = -30*64+"px";
		document.getElementById('speed3').style.left = -30*64+"px";
		document.getElementById('speed4').style.left = -30*64+"px";
		document.getElementById('speed4').style.left = -30*64+"px";
		document.getElementById('builder-menu').style.top = -30*64+"px";
		document.getElementById('builder-menu').style.left = -30*64+"px";
		var biome = $_GET('biome');
	}

	function sdwood(x,y){
		//search and delete mountain if exists
		for(i=0; i < woods.length ;i++){
			if(woods[i]){
				if(x == woods[i].posx && y == woods[i].posy){
					woods.splice(i, 1);
					woodsN--;
					return
				}
			}
		}
	}

	function sdmount(x,y){
		//search and delete mountain if exists
		for(i=0; i < mountains.length ;i++){
			if(mountains[i]){
				if(x == mountains[i].posx && y == mountains[i].posy){
					mountains.splice(i, 1);
					mountainsN--;
					return
				}
			}
		}
	}

	function sdwater(x,y){
		//search and delete mountain if exists
		for(i=0; i < waters.length ;i++){
			if(waters[i]){
				if(x == waters[i].posx && y == waters[i].posy){
					waters.splice(i, 1);
					watersN--;
					return
				}
			}
		}
	}

	function sdbridge(x,y){
		//search and delete mountain if exists
		for(i=0; i < bridges.length ;i++){
			if(bridges[i]){
				if(x == bridges[i].posx && y == bridges[i].posy){
					bridges.splice(i, 1);
					bridgesN--;
					return
				}
			}
		}
	}

	function sdtown(x,y){
		//search and delete town if exists
		for(i=0; i < towns.length ;i++){
			if(towns[i]){
				if(x == towns[i].posx && y == towns[i].posy){
					towns.splice(i, 1);
					townN--;
					bgm.volume = 0.1;
					if(document.getElementById("town_"+i+"_carg")){
						document.getElementById("town_"+i+"_carg").remove();
					}
					setTimeout(function(){bgm.volume = 0.2}, 1500)
					collapse.play();
					return
				}
			}
		}
	}

	function sdcannon(x,y){
		//search and delete cannon if exists
		for(i=0; i < cannons.length; i++){
			if(cannons[i]){
				if(x == cannons[i].posx && y == cannons[i].posy){
					bgm.volume = 0.1;
					if(document.getElementById(cannons[i].id+"_carg")){
						document.getElementById(cannons[i].id+"_carg").remove();
					}
					cannons[i].die();
					setTimeout(function(){bgm.volume = 0.2}, 1500)
					collapse.play();
					return
				}
			}
		}
	}

	function sdcity(x,y){
		//search and delete city if exists
		for(i=0; i < cities.length ;i++){
			if(cities[i]){
				if(x == cities[i].posx && y == cities[i].posy){
					cities.splice(i, 1);
					citiesN--;
					return
				}
			}
		}
	}

	function sdvillage(x,y){
		//search and delete village if exists
		for(i=0; i < villages.length ;i++){
			if(villages[i]){
				if(x == villages[i].posx && y == villages[i].posy){
					if(villages[i].team == 1){
						//substract team 1 village
						villageteam1--;
						//townprogressionupdate(1, "plus");
					}else if(villages[i].team == 2){
						//substract team 2 village
						villageteam2--;
						//townprogressionupdate(2, "plus");
					}
					villages.splice(i, 1);
					villageN--;
					return
				}
			}
		}
	}

	function sdplain(x,y){
		//search and delete plain if exists
		for(i=0; i < plains.length ;i++){
			if(plains[i]){
				if(x == plains[i].posx && y == plains[i].posy){
					plains.splice(i, 1);
					plainsN--;
					return
				}
			}
		}
	}

	function sdtown(x,y){
		//search and delete town if exists
		for(i=0; i < towns.length ;i++){
			if(towns[i]){
				if(x == towns[i].posx && y == towns[i].posy){
					towns.splice(i, 1);
					townN--;
					bgm.volume = 0.1;
					if(document.getElementById("town_"+i+"_carg")){
						document.getElementById("town_"+i+"_carg").remove();
					}
					setTimeout(function(){bgm.volume = 0.2}, 1500)
					collapse.play();
					return
				}
			}
		}
	}

	function wateranimation(){
		for(i=0; i < waters.length; i++){
			var x = waters[i].posx;
			var y = waters[i].posy;
			var position = 3762-(wateranim);
			ctx.drawImage(image, position, 0, 99, 100, x*64, y*64, 64, 64);
		}
		if(wateranim != 99){
			wateranim++;
		}else{
			wateranim = 0;
		}
	}

	function checktile(coord){
		var cityteam = iscity(coord, true);
		if(iswood(coord)){
			return "wood";
		}else if(isplain(coord)){
			return "plain";
		}else if(ismountain(coord)){
			return "mountain";
		}else if(cityteam){
			return cityteam;
		}else if(iscannon(coord)){
			return "cannon";
		}else if(isvillage(coord)){
			return "village";
		}else if(iswater(coord)){
			return "water";
		}else if(isbridge(coord)){
			return "bridge";
		}else if(istown(coord)){
			return "town";
		}
	}

	function healthcheck(){
		for(i=0; i < tiles.length; i++){
			doubletile(tiles[i]);
		}
		console.log("End of process !");
	}

	function doubletile(coord){
		//search for any tile having double attributes
		var cityteam = iscity(coord, true);
		var answer = "";
		iteration = 0;
		if(iswood2(coord)){
			if(count != 1){answer += "multi "};
			answer+= "wood;";
			iteration++;
		}
		if(isplain(coord)){
			if(count != 1){answer += "multi "};
			answer+= "plain;";
			iteration++;
		}
		if(ismountain(coord)){
			if(count != 1){answer += "multi "};
			answer+= "mountain;";
			iteration++;
		}
		if(cityteam){
			if(count != 1){answer += "multi "};
			answer+= "city;";
			iteration++;
		}
		if(isvillage(coord)){
			if(count != 1){answer += "multi "};
			answer+= "village;";
			iteration++;
		}
		if(iscannon(coord)){
			if(count != 1){answer += "multi "};
			answer+= "cannon;";
			iteration++;
		}
		if(iswater(coord)){
			if(count != 1){answer += "multi "};
			answer+= "water;";
			iteration++;
		}
		if(isbridge(coord)){
			if(count != 1){answer += count+" "};
			answer+= "bridge;";
			iteration++;
		}
		if(iteration > 1){
			console.log(coord+" : "+answer);
		}
	}

	function ispoison(x,y){
		for(a=0; a < poisonmap.length ; a++){
			if(poisonmap[a]){
				if(x == poisonmap[a].posx && y == poisonmap[a].posy){
					poisonmemo = a;
					return true
				}
			}
		}
		poisonmemo = -1;
		return false
	}

	function iswood(coord, sendid){
		count = 0
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < woods.length ;a++){
			if(woods[a]){
				if(x == woods[a].posx && y == woods[a].posy){
					if(sendid == 'true'){
						return a;
					}else{
						return true
					}
				}
			}
		}
		return false
	}

	function iswood2(coord){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < woods.length ;a++){
			if(woods[a]){
				if(x == woods[a].posx && y == woods[a].posy){
					count++;
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function isplain(coord){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < plains.length ;a++){
			if(plains[a]){
				if(x == plains[a].posx && y == plains[a].posy){
					count++;
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function ismountain(coord){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < mountains.length ;a++){
			if(mountains[a]){
				if(x == mountains[a].posx && y == mountains[a].posy){
					memo = a;
					count++;
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function iswater(coord){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < waters.length ;a++){
			if(waters[a]){
				if(x == waters[a].posx && y == waters[a].posy){
					count++;
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function isbridge(coord){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < bridges.length ;a++){
			if(bridges[a]){
				if(x == bridges[a].posx && y == bridges[a].posy){
					memo = a;
					count++;
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function isvillage(coord){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < villages.length ;a++){
			if(villages[a]){
				if(x == villages[a].posx && y == villages[a].posy){
					count++;
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function iscannon(coord,sendid){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < cannons.length ;a++){
			if(cannons[a]){
				if(x == cannons[a].posx && y == cannons[a].posy){
					if(sendid == true){
						return a	
					}else{
						count++;
					}
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function iscity(coord, sendteam){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < cities.length ;a++){
			if(cities[a]){
				if(x == cities[a].posx && y == cities[a].posy){
					if(sendteam == false){
						count++;
					}else{
						return cities[a].team;
					}
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function iscity2(coord){
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < cities.length ;a++){
			if(cities[a]){
				if(x == cities[a].posx && y == cities[a].posy){
					return a
				}
			}
		}
		return false
	}

	function isvillage2(coord){
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < villages.length ;a++){
			if(villages[a]){
				if(x == villages[a].posx && y == villages[a].posy){
					return a
				}
			}
		}
		return false
	}

	function istown(coord, sendid){
		count = 0;
		var x = coord.substr(0, coord.indexOf('/') );
      	var y = coord.substr(coord.indexOf('/')+1, coord.length);
		for(a=0; a < towns.length ;a++){
			if(towns[a]){
				if(x == towns[a].posx && y == towns[a].posy){
					if(sendid == true){
						return a	
					}else{
						count++;
					}
				}
			}
		}
		if(count == 0){
			return false
		}else{
			if(count >= 2){iteration++}
			return true
		}
	}

	function getx(coord){
		return coord.substr(0, coord.indexOf('/') );
	}

	function gety(coord){
		return coord.substr(coord.indexOf('/')+1, coord.length);
	}

	function checktown(posx,posy){
		for(dd=0;dd < towns.length ;dd++){
			if(towns[dd].posx == posx & towns[dd].posy == posy){
				return towns[dd].team
			}
		}
	}

	function checkcannon(posx,posy){
		for(dd=0;dd < cannons.length ;dd++){
			if(cannons[dd].posx == posx & cannons[dd].posy == posy){
				return cannons[dd].team
			}
		}
	}

	function capturetown(px,py,team){
		for(ab=0; ab < towns.length; ab++){
			if(towns[ab].posx == px && towns[ab].posy == py){
				towns[ab].team = team;
			}
		}
	}

	function tempsave(){
		content = 'plains='+JSON.stringify(plains)+';\n';
		content += 'woods='+JSON.stringify(woods)+';\n';
		content += 'mountains='+JSON.stringify(mountains)+';\n';
		content += 'waters='+JSON.stringify(waters)+';\n';
		content += 'bridges='+JSON.stringify(bridges)+';\n';
		content += 'cities='+JSON.stringify(cities)+';\n';
		content += 'villages='+JSON.stringify(villages)+';\n';
		content += 'loadcannons='+JSON.stringify(cannons)+';\n';
		content += 'towns='+JSON.stringify(towns)+';\n';
		content += 'loadfiremap='+JSON.stringify(firemap)+';\n';
		content += 'loadpoison='+JSON.stringify(poisonmap)+';\n';
		content += 'loadUnits='+JSON.stringify(unit)+';\n';
		content += 'loadgas='+JSON.stringify(gas)+';\n';
		content += 'xtiles='+xtiles+';\n';
		content += 'ytiles='+ytiles+';\n';
		content += 'turn='+turn+';\n';
		content += 'isnight='+isnight+';\n';
		content += 'nightcycle='+nightcycle+';\n';
		content += 'wind="'+wind+'";\n';
		content += 'turnswind='+turnswind+';\n';
		content += 'legoteam1='+legoteam1+';\n';
		content += 'legoteam2='+legoteam2+';\n';
		content += 'balanceteam1='+balanceteam1+';\n';
		content += 'balanceteam2='+balanceteam2+';\n';
		content += 'cannonN='+cannonN+';\n';
		content += 'turnstotal='+turnstotal+';'
	}

	function exportmap(){
		content = 'plains='+JSON.stringify(plains)+'\n';
		content += 'woods='+JSON.stringify(woods)+'\n';
		content += 'mountains='+JSON.stringify(mountains)+'\n';
		content += 'waters='+JSON.stringify(waters)+'\n';
		content += 'bridges='+JSON.stringify(bridges)+'\n';
		content += 'cities='+JSON.stringify(cities)+'\n';
		content += 'villages='+JSON.stringify(villages)+'\n';
		content += 'loadcannons='+JSON.stringify(cannons)+';\n';
		content += 'towns='+JSON.stringify(towns)+'\n';
		content += 'loadfiremap='+JSON.stringify(firemap)+'\n';
		content += 'loadpoison='+JSON.stringify(poisonmap)+'\n';
		content += 'loadUnits='+JSON.stringify(unit)+'\n';
		content += 'loadgas='+JSON.stringify(gas)+'\n';
		content += 'xtiles='+xtiles+'\n';
		content += 'ytiles='+ytiles+'\n';
		content += 'turn='+turn+'\n';
		content += 'isnight='+isnight+'\n';
		content += 'nightcycle='+nightcycle+'\n';
		content += 'wind="'+wind+'"\n';
		content += 'turnswind='+turnswind+'\n';
		content += 'legoteam1='+legoteam1+'\n';
		content += 'legoteam2='+legoteam2+'\n';
		content += 'balanceteam1='+balanceteam1+'\n';
		content += 'balanceteam2='+balanceteam2+'\n';
		content += 'cannonN='+cannonN+';\n';
		content += 'drawFromSave();';

		var filename = prompt('choose a file name');
		var mapfile = new Blob([content], {type: "text/plain;charset=utf-8"});
        saveAs(mapfile, filename);
	}

	function drawFromSave(){
		cannonN = 0;
		screenposy = 0;
   		screenposx = 0;
		marginsizex = 0;
		marginsizey = 0;
  		if(xtiles < 22){
  			marginsizex = (1366-(xtiles*64))/2;
  			canvas.style.left = marginsizex+"px";
  			selposx = 0;
  		}
  		if(ytiles < 13){
			marginsizey = (768-ytiles*64)/2;
  			canvas.style.top = marginsizey+"px";
  			selposy = 0;
  		}
		gentiles();
		citiesTeam1--;
		citiesTeam2--;
		loadedmap = true;
		casen = 1;
		for(i=0; i < plains.length; i++){
			posx = plains[i].posx;
			posy = plains[i].posy;
			draw(posx, posy);
		}

		casen = 2;
		for(i=0; i < woods.length; i++){
			posx = woods[i].posx;
			posy = woods[i].posy;
			draw(posx, posy);
		}

		casen = 3;
		for(i=0; i < mountains.length; i++){
			posx = mountains[i].posx;
			posy = mountains[i].posy;
			draw(posx, posy);
		}

		casen = 4;
		for(i=0; i < cities.length; i++){
			posx = cities[i].posx;
			posy = cities[i].posy;
			if(cities[i].team == 1){
				var city1 = cities[i].territoire;
				draw(posx, posy);
				cities[i].team = 1;
				if(player1 == 1){
					ctx.drawImage(image, 297, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
				}else if(player1 == 2){
					ctx.drawImage(image, 792, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
				}else if(player1 == 3){
					ctx.drawImage(image, 2476, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
				}else if(player1 == 4){
					ctx.drawImage(image, 892, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}else if(player1 == 5){
					ctx.drawImage(image, 1089, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}else if(player1 == 6){
					ctx.drawImage(image, 1386, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}else if(player1 == 7){
					ctx.drawImage(image, 1485, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}
				citiesTeam1++;
			}else if(cities[i].team == 2){
				var city2 = cities[i].territoire;
				draw(posx, posy);
				cities[i].team = 2;
				if(player2 == 1){
					ctx.drawImage(image, 297, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
				}else if(player2 == 2){
					ctx.drawImage(image, 792, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
				}else if(player2 == 3){
					ctx.drawImage(image, 2476, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
				}else if(player2 == 4){
					ctx.drawImage(image, 892, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}else if(player2 == 5){
					ctx.drawImage(image, 1089, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}else if(player2 == 6){
					ctx.drawImage(image, 1386, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}else if(player2 == 7){
					ctx.drawImage(image, 1485, 0, 99, 100, cities[i].posx*64, cities[i].posy*64, 64, 64);
      			}
				citiesTeam2++;
			}else{
				draw(posx, posy);
			}
		}

		casen = 5;
		for(i=0; i < towns.length; i++){
			if(towns[i].posx){
				posx = towns[i].posx;
				posy = towns[i].posy;
				var thisteam = towns[i].team;
				var qual = towns[i].quality;
				var lastqual = towns[i].lastquality;
				var prog = towns[i].progression;

				if(thisteam == 1){
					if(player1 == 1){
						//blue
						ctx.drawImage(image, 693, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 2){
						//black
						ctx.drawImage(image, 495, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 3){
						//green
						ctx.drawImage(image, 2574, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 4){
						//white
						ctx.drawImage(image, 990, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 5){
						//pink
						ctx.drawImage(image, 1188, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 6){
						//yellow
						ctx.drawImage(image, 1287, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 7){
						//red
						ctx.drawImage(image, 1584, 0, 99, 100, posx*64, posy*64, 64, 64);
					}
					townteam1++;			
				}else{
					if(player2 == 1){
						//blue
						ctx.drawImage(image, 693, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 2){
						//black
						ctx.drawImage(image, 495, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 3){
						//green
						ctx.drawImage(image, 2575, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 4){
						//white
						ctx.drawImage(image, 990, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 5){
						//pink
						ctx.drawImage(image, 1188, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 6){
						//yellow
						ctx.drawImage(image, 1287, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 7){
						//red
						ctx.drawImage(image, 1584, 0, 99, 100, posx*64, posy*64, 64, 64);
					}
					townteam2++;	
				}
				towns[townN] = new town(posx,posy,qual,true,thisteam,prog,lastqual);
				towns[townN].work(true);
				townN++;
			}
		}

		casen = 6;
		for(i=0; i < loadcannons.length; i++){
			if(loadcannons[i].id){
			posx = loadcannons[i].posx;
			posy = loadcannons[i].posy;
			team = loadcannons[i].team;
			var buildid = loadcannons[i].id;
			var loadunitinside = loadcannons[i].unitinside;
			var loadcanplay = loadcannons[i].canplay;
				if(team == 1){
					if(player1 == 1){
						//blue
						ctx.drawImage(image, 2970, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 2){
						//black
						ctx.drawImage(image, 3069, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 3){
						//green
						ctx.drawImage(image, 3168, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 4){
						//white
						ctx.drawImage(image, 3267, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 5){
						//pink
						ctx.drawImage(image, 3366, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 6){
						//yellow
						ctx.drawImage(image, 3465, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player1 == 7){
						//red
						ctx.drawImage(image, 3564, 0, 99, 100, posx*64, posy*64, 64, 64);
					}			
				}else{
					if(player2 == 1){
						//blue
						ctx.drawImage(image, 2970, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 2){
						//black
						ctx.drawImage(image, 3069, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 3){
						//green
						ctx.drawImage(image, 3168, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 4){
						//white
						ctx.drawImage(image, 3267, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 5){
						//pink
						ctx.drawImage(image, 3366, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 6){
						//yellow
						ctx.drawImage(image, 3465, 0, 99, 100, posx*64, posy*64, 64, 64);
					}else if(player2 == 7){
						//red
						ctx.drawImage(image, 3564, 0, 99, 100, posx*64, posy*64, 64, 64);
					}	
				}
				newplace("cannon",posx,posy,team,buildid,loadunitinside);
			}else{
				cannons[i]={};
				cannonN++;
			}
		}

		casen = 7;
		for(i=0; i < villages.length; i++){
			posx = villages[i].posx;
			posy = villages[i].posy;
			sleft = villages[i].slimeleft;
			team = villages[i].team;
			if(team == 1){
				villageteam1++;
				switch(player1){
				case '1':
				ctx.drawImage(image, 1783, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '2':
				ctx.drawImage(image, 1882, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '3':
				ctx.drawImage(image, 1684, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '4':
				ctx.drawImage(image, 1981, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '5':
				ctx.drawImage(image, 2080, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '6':
				ctx.drawImage(image, 2179, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '7':
				ctx.drawImage(image, 2278, 0, 99, 100, posx*64, posy*64, 64, 64);
				break
				}
			}else if(team == 2){
				villageteam2++;
				switch(player2){
				case '1':
				ctx.drawImage(image, 1783, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '2':
				ctx.drawImage(image, 1882, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '3':
				ctx.drawImage(image, 1684, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '4':
				ctx.drawImage(image, 1981, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '5':
				ctx.drawImage(image, 2080, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '6':
				ctx.drawImage(image, 2179, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '7':
				ctx.drawImage(image, 2278, 0, 99, 100, posx*64, posy*64, 64, 64);
				break
				}
			}else{
				switch(player3){
				case '1':
				ctx.drawImage(image, 1783, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '2':
				ctx.drawImage(image, 1882, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '3':
				ctx.drawImage(image, 1684, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '4':
				ctx.drawImage(image, 1981, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '5':
				ctx.drawImage(image, 2080, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '6':
				ctx.drawImage(image, 2179, 0, 99, 100, posx*64, posy*64, 64, 64);
				break

				case '7':
				ctx.drawImage(image, 2278, 0, 99, 100, posx*64, posy*64, 64, 64);
				break
				}
			}
		newplace("village",posx,posy,0,sleft,team);
		}

		casen = 9;
		for(i=0; i < waters.length; i++){
			posx = waters[i].posx;
			posy = waters[i].posy;
			draw(posx, posy);
		}
		loadbiome();

		casen = 10;
		for(i=0; i < bridges.length; i++){
			posx = bridges[i].posx;
			posy = bridges[i].posy;
			draw(posx, posy);
		}

		activeCities = citiesTeam1+citiesTeam2;
		setbgm(turn);

		if(loadUnits){
			for(let x=0; x < loadUnits.length; x++){
				if(loadUnits[x].id){
					if(loadUnits[x].type == 'villager'){
					create(loadUnits[x].type, loadUnits[x].team, loadUnits[x].posx, loadUnits[x].posy, loadUnits[x].origin, loadUnits[x].playable, loadUnits[x].playedtwice, 0, 0, 0, 0, 0, loadUnits[x].infected, loadUnits[x].vtb);
						if(loadUnits[x].posx == -10){
							document.getElementById(loadUnits[x].id).remove();
						}
					}else if(loadUnits[x].type == 'vtb'){
						create('vtb', loadUnits[x].team, loadUnits[x].posx, loadUnits[x].posy, false, loadUnits[x].playable, loadUnits[x].playedtwice, loadUnits[x].unitinside, loadUnits[x].cargo, loadUnits[x].cargoQ, 0, 0, loadUnits[x].infected, loadUnits[x].vtb, loadUnits[x].moved, loadUnits[x].leftmoves, loadUnits[x].cannon);
					}else if(loadUnits[x].type == 'gunner'){
						create('gunner', loadUnits[x].team, loadUnits[x].posx, loadUnits[x].posy, false, loadUnits[x].playable, loadUnits[x].playedtwice, 0, 0, 0, loadUnits[x].canreshoot, 0, loadUnits[x].infected, loadUnits[x].vtb, false, false, loadUnits[x].cannon);
						if(loadUnits[x].posx == -10){
							document.getElementById(loadUnits[x].id).remove();
						}
					}else if(loadUnits[x].type == 'builder'){
						create('builder', loadUnits[x].team, loadUnits[x].posx, loadUnits[x].posy, false, loadUnits[x].playable, loadUnits[x].playedtwice, 0, 0, 0, 0, loadUnits[x].cuttree, loadUnits[x].infected, loadUnits[x].vtb, false, false, loadUnits[x].cannon);
						if(loadUnits[x].posx == -10){
							document.getElementById(loadUnits[x].id).remove();
						}
					}else{
						create(loadUnits[x].type, loadUnits[x].team, loadUnits[x].posx, loadUnits[x].posy, false, loadUnits[x].playable, loadUnits[x].playedtwice, 0, 0, 0, 0, 0, loadUnits[x].infected, loadUnits[x].vtb, false, false, loadUnits[x].cannon, loadUnits[x].amogus);
						if(loadUnits[x].posx == -10){
							document.getElementById(loadUnits[x].id).remove();
						}
					}
				}else{
					unit[cur_uniId]={};
					cur_uniId++;
				}
			}
		}
		
		if(loadfiremap){
		positionx = 0;
		positiony = 0;
			for(x=0; x < loadfiremap.length; x++){
				positionx = loadfiremap[x].substr(0, loadfiremap[x].indexOf('/') );
	      		positiony = loadfiremap[x].substr(loadfiremap[x].indexOf('/')+1, loadfiremap[x].length);
	      		setfire(positionx, positiony, false);
			}
		}

		if(loadpoison){
			for(x=0; x < loadpoison.length; x++){
				if(loadpoison[x].id){
	      			setpoison(loadpoison[x].posx, loadpoison[x].posy, loadpoison[x].team, loadpoison[x].leftturns, false, loadpoison[x].size);
				}
			}
		}

		if(loadgas){
			for(x=0; x < loadgas.length; x++){
				if(loadgas[x].team){
					positionx = loadgas[x].posx1;
					positiony = loadgas[x].posy1;
					var positiony = loadgas[x].posy1;
					var team = loadgas[x].team;
					var ori = loadgas[x].id;
					var wi = loadgas[x].wind;
					gas[x] = new gasfart(positionx, positiony, 0, team, wi);
    				gas[x].spawn();
    				gasN++;
    			}else{
    				gas[x]={};
    				gasN++;
    			}
			}
		}

		if(isnight == 1){
			document.getElementById('night-filter').style.opacity = 1;
			document.getElementById('night-ambient').play();
			document.getElementById('owl-ambient').play();
		}
		
		if(enableShadows > 0 && isnight == 1){
      		shadowExList();
      	}

      	if(enableShadows == 2){
      		isnight = 1;
      	}

      	particlesUpdate(wind);
      	if(wind == 'left'){
      		switch(turnswind){
      			case 0:
      			document.getElementById('wsymb').innerHTML = '↞';
				document.getElementById('wsymb2').innerHTML = '↟';
				document.getElementById('wsymb3').innerHTML = '↟';
				document.getElementById('wsymb4').innerHTML = '↟';
      			break
      			case 1:
    		  	document.getElementById('wsymb').innerHTML = '↞';
				document.getElementById('wsymb2').innerHTML = '↞';
				document.getElementById('wsymb3').innerHTML = '↞';
				document.getElementById('wsymb4').innerHTML = '↟';
      			break
      			case 2:
    		  	document.getElementById('wsymb').innerHTML = '↞';
				document.getElementById('wsymb2').innerHTML = '↞';
				document.getElementById('wsymb3').innerHTML = '↟';
				document.getElementById('wsymb4').innerHTML = '↟';
      			break
      		}
      	}else if(wind == 'top'){
      		switch(turnswind){
      			case 0:
      			document.getElementById('wsymb').innerHTML = '↟';
				document.getElementById('wsymb2').innerHTML = '↠';
				document.getElementById('wsymb3').innerHTML = '↠';
				document.getElementById('wsymb4').innerHTML = '↠';
      			break
      			case 1:
    		 	document.getElementById('wsymb').innerHTML = '↟';
				document.getElementById('wsymb2').innerHTML = '↟';
				document.getElementById('wsymb3').innerHTML = '↟';
				document.getElementById('wsymb4').innerHTML = '↠';
      			break
      			case 2:
    			document.getElementById('wsymb').innerHTML = '↟';
				document.getElementById('wsymb2').innerHTML = '↟';
				document.getElementById('wsymb3').innerHTML = '↠';
				document.getElementById('wsymb4').innerHTML = '↠';
      			break
      		}
		}else if(wind == 'right'){
			switch(turnswind){
      			case 0:
    		  	document.getElementById('wsymb').innerHTML = '↠';
				document.getElementById('wsymb2').innerHTML = '↡';
				document.getElementById('wsymb3').innerHTML = '↡';
				document.getElementById('wsymb4').innerHTML = '↡';
      			break
      			case 1:
    		 	document.getElementById('wsymb').innerHTML = '↠';
				document.getElementById('wsymb2').innerHTML = '↠';
				document.getElementById('wsymb3').innerHTML = '↠';
				document.getElementById('wsymb4').innerHTML = '↡';
      			break
      			case 2:
    			document.getElementById('wsymb').innerHTML = '↠';
				document.getElementById('wsymb2').innerHTML = '↠';
				document.getElementById('wsymb3').innerHTML = '↡';
				document.getElementById('wsymb4').innerHTML = '↡';
      			break	
      		}
		}else{
			switch(turnswind){
      			case 0:
      			document.getElementById('wsymb').innerHTML = '↡';
				document.getElementById('wsymb2').innerHTML = '↞';
				document.getElementById('wsymb3').innerHTML = '↞';
				document.getElementById('wsymb4').innerHTML = '↞';
      			break
      			case 1:
    		 	document.getElementById('wsymb').innerHTML = '↡';
				document.getElementById('wsymb2').innerHTML = '↡';
				document.getElementById('wsymb3').innerHTML = '↡';
				document.getElementById('wsymb4').innerHTML = '↞';
      			break
      			case 2:
    			document.getElementById('wsymb').innerHTML = '↡';
				document.getElementById('wsymb2').innerHTML = '↡';
				document.getElementById('wsymb3').innerHTML = '↞';
				document.getElementById('wsymb4').innerHTML = '↞';
      			break
      		}
		}

		updatemoney();
		if(turn == 1){
			turn = 2;
		}else{
			turn = 1;
		}
		resetselection();
		hidespies();
		if(turn == 2){
			turn = 1;
			Nskin = player1;
		}else{
			turn = 2;
			Nskin = player2;
		}
		document.getElementById('fts-img').src = "tiles/fts"+Nskin+"/fts1.png";
      	document.getElementById('gunner-img').src = "tiles/gunner"+Nskin+"/gunner1.png";
      	document.getElementById('shield-img').src = "tiles/shield"+Nskin+"/shield1.png";
      	document.getElementById('builder-img').src = "tiles/builder"+Nskin+"/builder1.png";
      	document.getElementById('tank-img').src = "tiles/tank"+Nskin+"/tank1.png";
      	document.getElementById('ninja-img').src = "tiles/ninja"+Nskin+"/ninja1.png";
      	document.getElementById('seg-img').src = "tiles/seg"+Nskin+"/seg1.png";
      	document.getElementById('radio-img').src = "tiles/radio"+Nskin+"/radio1.png";
      	document.getElementById('vtb-img').src = "tiles/vtb"+Nskin+"/vtb1.png";
      	document.getElementById('trumpet-img').src = "tiles/trumpet"+Nskin+"/trumpet1.png";
      	document.getElementById('napalm-img').src = "tiles/napalm"+Nskin+"/napalm1.png";
      	document.getElementById('poison-img').src = "tiles/poison"+Nskin+"/poison1.png";
    	switch(Nskin){
    		case '1':
				document.getElementsByClassName('upperbuy')[0].style.background = 'deepskyblue';
			break
			case '2':
				document.getElementsByClassName('upperbuy')[0].style.background = 'mediumpurple';
			break
			case '3':
    	    	document.getElementsByClassName('upperbuy')[0].style.background = 'lawngreen';
    	    break
			case '4':
				document.getElementsByClassName('upperbuy')[0].style.background = '#CCC';
			break
			case '5':
				document.getElementsByClassName('upperbuy')[0].style.background = 'deeppink';
			break
			case '6':
				document.getElementsByClassName('upperbuy')[0].style.background = 'darkorange';
			break
			case '7':
				document.getElementsByClassName('upperbuy')[0].style.background = '#D00';
			break

   		}


   			setTimeout(function(){
			barbecuetime();
			setTimeout(function(){isgasexplosion();barbecuetime();
				setTimeout(function(){
					treecycle();nospace = false; noenter = false
					}, 500);
				}, 500);
			}, 500);
   			poisonhide();
			setTimeout(function(){isgasexplosion();nospace = false; noenter = false}, 2000);
			gaskill();
			cycletowers();
			loadUnits = false;
	}

	function windupdate(progress){
		if(turnswind == 0){
			if(wind == 'left'){
				//top
				wind = 'top';
				particlesUpdate('top');
				document.getElementById('wsymb').innerHTML = '↟';
				document.getElementById('wsymb2').innerHTML = '↟';
				document.getElementById('wsymb3').innerHTML = '↟';
				document.getElementById('wsymb4').innerHTML = '↠';

			}else if(wind == 'top'){
				//right
				wind = 'right';
				particlesUpdate('right');
				document.getElementById('wsymb').innerHTML = '↠';
				document.getElementById('wsymb2').innerHTML = '↠';
				document.getElementById('wsymb3').innerHTML = '↠';
				document.getElementById('wsymb4').innerHTML = '↡';

			}else if (wind == 'right'){
				//bottom
				wind = 'bottom';
				particlesUpdate('bottom');
				document.getElementById('wsymb').innerHTML = '↡';
				document.getElementById('wsymb2').innerHTML = '↡';
				document.getElementById('wsymb3').innerHTML = '↡';
				document.getElementById('wsymb4').innerHTML = '↞';

			}else{
				//left
				wind = 'left';
				particlesUpdate('left');
				document.getElementById('wsymb').innerHTML = '↞';
				document.getElementById('wsymb2').innerHTML = '↞';
				document.getElementById('wsymb3').innerHTML = '↞';
				document.getElementById('wsymb4').innerHTML = '↟';
			}
			if(!progress){turnswind++;}

		}else if(turnswind == 1){
			if(wind == 'left'){
				//left
				particlesUpdate('left');
				document.getElementById('wsymb').innerHTML = '↞';
				document.getElementById('wsymb2').innerHTML = '↞';
				document.getElementById('wsymb3').innerHTML = '↟';
				document.getElementById('wsymb4').innerHTML = '↟';

			}else if(wind == 'top'){
				//top
				particlesUpdate('top');
				document.getElementById('wsymb').innerHTML = '↟';
				document.getElementById('wsymb2').innerHTML = '↟';
				document.getElementById('wsymb3').innerHTML = '↠';
				document.getElementById('wsymb4').innerHTML = '↠';

			}else if (wind == 'right'){
				//right
				particlesUpdate('right');
				document.getElementById('wsymb').innerHTML = '↠';
				document.getElementById('wsymb2').innerHTML = '↠';
				document.getElementById('wsymb3').innerHTML = '↡';
				document.getElementById('wsymb4').innerHTML = '↡';

			}else{
				//bottom
				particlesUpdate('bottom');
				document.getElementById('wsymb').innerHTML = '↡';
				document.getElementById('wsymb2').innerHTML = '↡';
				document.getElementById('wsymb3').innerHTML = '↞';
				document.getElementById('wsymb4').innerHTML = '↞';
			}
			if(!progress){turnswind++;}
		}else if(turnswind == 2){
			if(wind == 'left'){
				//left
				particlesUpdate('left');
				document.getElementById('wsymb').innerHTML = '↞';
				document.getElementById('wsymb2').innerHTML = '↟';
				document.getElementById('wsymb3').innerHTML = '↟';
				document.getElementById('wsymb4').innerHTML = '↟';

			}else if(wind == 'top'){
				//top
				particlesUpdate('top');
				document.getElementById('wsymb').innerHTML = '↟';
				document.getElementById('wsymb2').innerHTML = '↠';
				document.getElementById('wsymb3').innerHTML = '↠';
				document.getElementById('wsymb4').innerHTML = '↠';

			}else if (wind == 'right'){
				//right
				particlesUpdate('right');
				document.getElementById('wsymb').innerHTML = '↠';
				document.getElementById('wsymb2').innerHTML = '↡';
				document.getElementById('wsymb3').innerHTML = '↡';
				document.getElementById('wsymb4').innerHTML = '↡';

			}else{
				//bottom
				particlesUpdate('bottom');
				document.getElementById('wsymb').innerHTML = '↡';
				document.getElementById('wsymb2').innerHTML = '↞';
				document.getElementById('wsymb3').innerHTML = '↞';
				document.getElementById('wsymb4').innerHTML = '↞';
			}
			turnswind = 0;
		}
	}

	function newgas(x, y, origin, team){
		gas[gasN] = new gasfart(x, y, origin, team);
	}

	function gaskill(ignore){

		for(z2=0; z2 < unit.length; z2++){
			if(unit[ignore]){
				if(z2 != ignore){
					gaskill2(unit[z2]);
				}
			}else{
				gaskill2(unit[z2]);
			}
		}
	}

	function isgasexplosion(){
		for(i=0; i < gas.length; i++){
			if(isfire(gas[i].posx1, gas[i].posy1)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx2, gas[i].posy2)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx3, gas[i].posy3)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx4, gas[i].posy4)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx5, gas[i].posy5)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx6, gas[i].posy6)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx7, gas[i].posy7)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx8, gas[i].posy8)){
				gasexplosion(gas[i]);
			}else if(isfire(gas[i].posx9, gas[i].posy9)){
				gasexplosion(gas[i]);
			}
		}
	}

	function gasexplosion(thisgas){
		setfire(thisgas.posx1, thisgas.posy1, true);
		setfire(thisgas.posx2, thisgas.posy2, true);
		setfire(thisgas.posx3, thisgas.posy3, true);
		setfire(thisgas.posx4, thisgas.posy4, true);
		setfire(thisgas.posx5, thisgas.posy5, true);
		setfire(thisgas.posx6, thisgas.posy6, true);
		setfire(thisgas.posx7, thisgas.posy7, true);
		setfire(thisgas.posx8, thisgas.posy8, true);
		setfire(thisgas.posx9, thisgas.posy9, true);
		document.getElementById('bomb').currentTime = 0;
		document.getElementById('bomb').play();
		if(thisgas){thisgas.die();}
		firekill();
		firepoison();
	}

	function gaskill2(thisun){
		var un = '';
		if(thisun.type){
			if(isvillage(thisun.posx+"/"+thisun.posy) || istown(thisun.posx+"/"+thisun.posy)){
				return
			}
			for(z=0; z < toxtilesblue.length; z = z+2){
				if(toxtilesblue[z] == thisun.posx && toxtilesblue[z+1] == thisun.posy){
					if(thisun.team != 1 && thisun.team != 3){
						un = thisun;
						if(thisun){
							if(thisun.type != 'tower'){
								noenter = true;
								setTimeout(function(){noenter = false; eval(un.die()); document.getElementById('gib').play(); if(isnight == 1 && enableShadows > 0){shadowExList()}}, 1500);
							}
						}
					}else if(thisun.team == 1 || thisun.teamskin == player1){

					}else{
						un = thisun;
						if(thisun){
							noenter = true;
							setTimeout(function(){noenter = false; eval(un.die()); document.getElementById('gib').play(); if(isnight == 1 && enableShadows > 0){shadowExList()}}, 1500);
						}
						if(eval(un).type == 'vtb' && eval(un).unitinside != 0){
      						eval(un).unitinside.die();
      					}
					}
				}
			}
		}
		if(thisun){
			for(z=0; z < toxtilespurple.length; z = z+2){
				if(toxtilespurple[z] == thisun.posx && toxtilespurple[z+1] == thisun.posy){
					if(thisun.team != 2 && thisun.team != 3){
						un = thisun;
						if(thisun){
							if(thisun.type != 'tower'){
								noenter = true;
								setTimeout(function(){noenter = false; eval(un.die()); document.getElementById('gib').play(); if(isnight == 1 && enableShadows > 0){shadowExList()}}, 1500);
							}
						}
					}else if(thisun.team == 2 || thisun.teamskin == player2){
						
					}else{
						un = thisun;
						if(thisun){
							noenter = true;
							setTimeout(function(){noenter = false; eval(un.die()); document.getElementById('gib').play(); if(isnight == 1 && enableShadows > 0){shadowExList()}}, 1500);
						}
						if(eval(un).type == 'vtb' && eval(un).unitinside != 0){
      						eval(un).unitinside.die();
      					}
					}
				}
			}
		}
	}

	function buildtown(){
		
		var px = eval(selchar).posx;
		var py = eval(selchar).posy;
		var quality = 0;
		
		//check mountain on right
		var newpx = parseInt(px)+1;
		var newpy = py;
		if(ismountain(newpx+"/"+newpy)){quality++};

		//check mountain on left
		newpx = px-1;
		if(ismountain(newpx+"/"+newpy)){quality++};

		//check mountain on top
		newpx = px;
		newpy = py-1;
		if(ismountain(newpx+"/"+newpy)){quality++};

		//check mountain on bottom
		newpy = parseInt(py)+1;
		if(ismountain(newpx+"/"+newpy)){quality++};

		if(quality == 0){
			alert("nécessite une montagne adjacente !")
			return
		}

		casen = 5;
		sdplain(px, py);
		draw(px, py, quality);
	}

	function sdall(posx,posy){
		sdcannon(posx,posy);
		sdplain(posx,posy);
		sdwood(posx,posy);
		sdmount(posx,posy);
		sdcity(posx,posy);
		sdvillage(posx,posy);
		sdwater(posx,posy);
		sdbridge(posx,posy);
	}

	function buildcity(){
		var px = eval(selchar).posx;
		var py = eval(selchar).posy;
		casen = 4;
		sdplain(px, py);
		draw(px, py);
		capture(eval(selchar).team, px, py);
	}

	function buildvillage(){
		var px = eval(selchar).posx;
		var py = eval(selchar).posy;
		casen = 7;
		sdplain(px, py);
		draw(px, py);
		captureVillage(px, py, eval(selchar).team, true);
		house.play();
	}

	function buildcannon(){
		var px = eval(selchar).posx;
		var py = eval(selchar).posy;
		casen = 6;
		sdplain(px, py);
		draw(px, py);
		strider.play();
	}

	function changetoplain(){
		sdall(selposx, selposy);
      	casen = 1;
      	draw(selposx, selposy);
	}

	function changetovillage(){
		var found = 0;
		var coord = selposx+"/"+selposy;
		if(isplain(coord)){
			found = "plain";
		}else if(iswood(coord)){
			found = "wood";
		}else if(ismountain(coord)){
			found = "mount";
		}else if(iscity(coord)){
			found = "city";
		}else if(isvillage(coord)){
			found = "village";
		}else if(iswater(coord)){
			found = "water";
		}else if(isbridge(coord)){
			found = "bridge";
		}
		
		switch(found){
		
			case 'plain':
			case 'water':
			case 'bridge':
			case 'wood':
			case 'mount':
			case 'city':
			sdmount(selposx,selposy);
			sdcity(selposx,selposy);
			sdwood(selposx,selposy);
			sdplain(selposx,selposy);
			sdvillage(selposx,selposy);
			sdwater(selposx,selposy);
			sdbridge(selposx,selposy);
      		casen = 7;
      		changetoteam = 3;
      		draw(selposx, selposy);
			break

			case 'village':
			if(changetoteam == 1){
				changetoteam = 2;
				captureVillage(selposx, selposy, 1, false);
			}else if(changetoteam == 2){
				changetoteam = 3;
				captureVillage(selposx, selposy, 3, false);
			}else{
				changetoteam = 1;
				captureVillage(selposx, selposy, 2, false);
			}
			break
		}
	}
	function changetowood(){
		var found = 0;
		sdall(selposx,selposy);
      	casen = 2;
      	draw(selposx, selposy);
	}

	function changetomount(){
		var found = 0;
		sdall(selposx, selposy);
      	casen = 3;
      	draw(selposx, selposy);
      }

      function changetowater(){
		var found = 0;
		sdall(selposx, selposy);
      	casen = 9;
      	draw(selposx, selposy);
      }

      function changetobridge(){
		var found = 0;
		sdall(selposx, selposy);
      	casen = 10;
      	draw(selposx, selposy);
      }

	function changetocity(){
		var found = 0;
		var coord = selposx+"/"+selposy;
		if(isplain(coord)){
			found = "plain";
		}else if(iswood(coord)){
			found = "wood";
		}else if(ismountain(coord)){
			found = "mount";
		}else if(iscity(coord)){
			found = "city";
		}else if(isvillage(coord)){
			found = "village";
		}else if(iswater(coord)){
			found = "water";
		}else if(isbridge(coord)){
			found = "bridge";
		}
		
		switch(found){
		
			case 'plain':
			case 'water':
			case 'bridge':
			case 'wood':
			case 'mount':
			case 'village':
			sdmount(selposx,selposy);
			sdcity(selposx,selposy);
			sdwood(selposx,selposy);
			sdplain(selposx,selposy);
			sdvillage(selposx,selposy);
			sdwater(selposx,selposy);
			sdbridge(selposx,selposy);
      		casen = 4;
      		changetoteam = 1;
      		draw(selposx, selposy);
			break

			case 'city':
			if(changetoteam == 1){
				changetoteam = 2;
				if(player2 == 1){
					ctx.drawImage(image, 297, 0, 99, 100, selposx*64, selposy*64, 64, 64);
				}else if(player2 == 2){
					ctx.drawImage(image, 792, 0, 99, 100, selposx*64, selposy*64, 64, 64);
				}else if(player2 == 3){
					ctx.drawImage(image, 2476, 0, 99, 100, selposx*64, selposy*64, 64, 64);
				}else if(player2 == 4){
					ctx.drawImage(image, 892, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}else if(player2 == 5){
					ctx.drawImage(image, 1089, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}else if(player2 == 6){
					ctx.drawImage(image, 1386, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}else if(player2 == 7){
					ctx.drawImage(image, 1485, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}
			}else if(changetoteam == 2){
				changetoteam = 3;
				ctx.drawImage(image, 396, 0, 99, 100, selposx*64, selposy*64, 64, 64);
			}else{
				changetoteam = 1;
				if(player1 == 1){
					ctx.drawImage(image, 297, 0, 99, 100, selposx*64, selposy*64, 64, 64);
				}else if(player1 == 2){
					ctx.drawImage(image, 792, 0, 99, 100, selposx*64, selposy*64, 64, 64);
				}else if(player1 == 3){
					ctx.drawImage(image, 2476, 0, 99, 100, selposx*64, selposy*64, 64, 64);
				}else if(player1 == 4){
					ctx.drawImage(image, 892, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}else if(player1 == 5){
					ctx.drawImage(image, 1089, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}else if(player1 == 6){
					ctx.drawImage(image, 1386, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}else if(player1 == 7){
					ctx.drawImage(image, 1485, 0, 99, 100, selposx*64, selposy*64, 64, 64);
      			}
			}
			break
		}
		for(bb=0; bb < cities.length; bb++){
      		if(selposx+'/'+selposy == cities[bb].posx+"/"+cities[bb].posy){
      			cities[bb].team = changetoteam;
	      	}
	     }
	}

	function hidespies(){
		var coord = "";
		for(i=0; i < unit.length; i++){
			if(unit[i].type == "ninja" && unit[i].amogus == false){
				if(unit[i].team == turn){
					coord = unit[i].posx+"/"+unit[i].posy;
					if(iswood(coord) && unit[i].posx != -10){
						eval(unit[i].id).style.display = "none";
					}
				}else{
					if(unit[i].posx != -10){
						eval(unit[i].id).style.display = "block";
					}
				}
			}
			if(unit[i].amogus == true){
				unit[i].amogus = false;
			}
		}
	}

	function shielding(unitid,tower){
		//check for shield protection
		if(unit[unitid].type == "ninja"){
			if(iswood(unit[unitid].posx+"/"+unit[unitid].posy) == true){
				return
			}
		}

		if(unit[unitid].type == "shield"){
			laser.currentTime = 0;
			setTimeout(function(){document.getElementById('laser').play();}, 500);
      		setTimeout(function(){document.getElementById('deflect').play()}, 700);
			return
		}

		if((unit[unitid].type == "shield" && unit[unitid].team == unit[tower].team) || unit[unitid].type == "tower"){
			return
		}

		var kill = true;
		var diffx = Math.abs(unit[tower].posx-unit[unitid].posx);
      	var diffy = Math.abs(unit[tower].posy-unit[unitid].posy);
      	var diff = diffx + diffy;
      	var distxsh = 0;
      	var distxtr = 0;
     	var distysh = 0;
     	var distytr = 0;
     	var reldistsh = 0;
      	var reldisttr = 0;
      	var targetabs = 0;
      	var sniperabs = 0;
      	var shieldabs = 0;
      	for(i=0 ; i < charlist.length; i++){

      		if(eval(charlist[i]).type == 'shield' && eval(charlist[i]).team == unit[unitid].team){
      			//distance target / shield
      			distxsh = Math.abs(eval(charlist[i]).posx - unit[unitid].posx);
      			distysh = Math.abs(eval(charlist[i]).posy - unit[unitid].posy);
      			reldistsh = Math.abs(parseInt(distxsh) + parseInt(distysh));

      			//distance target / sniper
      			distxtr = Math.abs(unit[unitid].posx - unit[tower].posx);
      			distytr = Math.abs(unit[unitid].posy - unit[tower].posy);
      			reldisttr = Math.abs(parseInt(distxtr) + parseInt(distytr));

      			//var check diagonal
      			targetabs = parseInt(unit[unitid].posx) + parseInt(unit[unitid].posy);
      			sniperabs = parseInt(unit[tower].posx) + parseInt(unit[tower].posy);
      			shieldabs = parseInt(eval(charlist[i]).posx) + parseInt(eval(charlist[i]).posy);

      			//if shield is in between => posx
      			if(parseInt(eval(charlist[i]).posx) == parseInt(unit[unitid].posx) /*&& distysh <= 3*/){
      				if(parseInt(unit[unitid].posy) < parseInt(eval(charlist[i]).posy) && parseInt(eval(charlist[i]).posy) < unit[tower].posy){
      					if(parseInt(eval(charlist[i]).posx) == unit[tower].posx || parseInt(eval(charlist[i]).posy) == unit[tower].posy){
      						kill = false;
      						laser.currentTime = 0;
      						setTimeout(function(){document.getElementById('laser').play();}, 500);
      						setTimeout(function(){document.getElementById('deflect').play()}, 700);
      					}
      				}

      				if(parseInt(unit[unitid].posy) > parseInt(eval(charlist[i]).posy) && parseInt(eval(charlist[i]).posy) > unit[tower].posy){
      					if(parseInt(eval(charlist[i]).posx) == unit[tower].posx || parseInt(eval(charlist[i]).posy) == unit[tower].posy){
      						kill = false;
      						laser.currentTime = 0;
      						setTimeout(function(){document.getElementById('laser').play();}, 500);
      							setTimeout(function(){document.getElementById('deflect').play()}, 700);
      						}
      				}
      			}

				//if shield is in between => posy
      			if(parseInt(eval(charlist[i]).posy) == parseInt(unit[unitid].posy)/*&& distxsh <= 3*/){
      				if(parseInt(unit[unitid].posx) < parseInt(eval(charlist[i]).posx) && parseInt(eval(charlist[i]).posx) < unit[tower].posx){
      					if(parseInt(eval(charlist[i]).posx) == unit[tower].posx || parseInt(eval(charlist[i]).posy) == unit[tower].posy){
      						kill = false;
      						laser.currentTime = 0;
      						setTimeout(function(){document.getElementById('laser').play();}, 500);
      							setTimeout(function(){document.getElementById('deflect').play()}, 700);
      					}
      				}

      				if(parseInt(unit[unitid].posx) > parseInt(eval(charlist[i]).posx) && parseInt(eval(charlist[i]).posx) > unit[tower].posx){
      					if(parseInt(eval(charlist[i]).posx) == unit[tower].posx || parseInt(eval(charlist[i]).posy) == unit[tower].posy){
      							kill = false;
      							laser.currentTime = 0;
      						setTimeout(function(){document.getElementById('laser').play();}, 500);
      						setTimeout(function(){document.getElementById('deflect').play()}, 700);
      					}
      				}
      			}

      			//if all in diagonal
      			if(((targetabs == sniperabs && sniperabs == shieldabs) && reldistsh < reldisttr) || ((shieldabs+2 == targetabs &&  sniperabs+2 == shieldabs) && reldistsh < reldisttr) || ((targetabs+2 == shieldabs &&  shieldabs+2 == sniperabs) && reldistsh < reldisttr)){
      				if(parseInt(unit[unitid].posx) != unit[tower].posx && parseInt(unit[unitid].posy) != unit[tower].posy){
      					kill = false;
      					laser.currentTime = 0;
      					setTimeout(function(){document.getElementById('laser').play();}, 500);
      					setTimeout(function(){document.getElementById('deflect').play()}, 700);
      				}
      			}
      		}
      	}
      	//kill target if shield not protecting
      	if(kill == true){
      		if(unit[unitid].type == 'seg'){
	      		setTimeout(function(){unit[unitid].fart2()}, 500);
	      	}else{
	      		noenter = true;
	      		setTimeout(function(){unit[unitid].die(); noenter = false}, 500);
	      	}
	      	laser.currentTime = 0;
	      	document.getElementById('laser').currentTime = 0;
	      	setTimeout(function(){document.getElementById('laser').play(); if(isnight == 1 && enableShadows > 0){shadowExList()}}, 500);
      	}
	}

	function sellcargo(quality){
		switch(quality){
			case 1:
			var benef = 150;
			document.getElementById('cash150').style.opacity = 1;
			setTimeout(function(){document.getElementById('cash150').style.opacity = 0}, 1500);
			break

			case 2:
			var benef = 250;
			document.getElementById('cash250').style.opacity = 1;
			setTimeout(function(){document.getElementById('cash250').style.opacity = 0}, 1500);
			break

			case 3:
			var benef = 400;
			document.getElementById('cash400').style.opacity = 1;
			setTimeout(function(){document.getElementById('cash400').style.opacity = 0}, 1500);
			break

			case 4:
			var benef = 700;
			document.getElementById('cash700').style.opacity = 1;
			setTimeout(function(){document.getElementById('cash700').style.opacity = 0}, 1500);
			break
		}

		sellsfx.play();
		if(turn == 1){
			balanceteam1 = balanceteam1+benef;
		}else{
			balanceteam2 = balanceteam2+benef;
		}
		updatemoney();
	}

	//objects ----------------------------------------------

	function shadowtile(x, y){
		this.id = "shadow_"+shadowNum;
		this.posx = x;
		this.posy = y;
		this.die = function(){
			document.getElementById(this.id).remove();
			delete this.spawn;
			delete this.posx;
			delete this.posy;
			delete this.id;
			delete this.die;
		}

		this.spawn = function(){
			var div = '';
			div = document.createElement('div');
    		div.id = this.id;
    		div.classList.add('blackshadow');
    		document.body.appendChild(div);
			div.style.left = this.posx+marginsizex+'px';
			div.style.top = this.posy+marginsizey+'px';
		}
	}

	function createunit(t, a, x, y, ori, canplay, canplaytwice, unitin, carg, cargq, canresh, cutt, isinfect, loadvtb, loadmoved, loadleftmoves, loadcannon, loadamogus){
	//spawn a unit (type, team, x, y, origincity)
    this.type = t;
    this.team = a;
    if(!loadvtb){this.vtb = -1;}else{this.vtb = loadvtb}
    if(!loadcannon){this.cannon = -1;}else{this.cannon = loadcannon}
    if(!canplaytwice){this.playedtwice = false;}else{this.playedtwice = canplaytwice}
    this.posx = x;
    this.posy = y;
    this.id = 'unit'+cur_uniId;
    this.numid = cur_uniId;
	if(!canplay){this.playable = false;}else{this.playable = canplay;}
	if(!isinfect){this.infected = false;}else{this.infected = isinfect;}
    if(this.team == 1){
     	this.skin = player1; 
    }else if(this.team == 2){
    	this.skin = player2;
     }else if(this.team == 3){
    	this.skin = player3;
     }
    switch(this.type){
    	case'fts':
    	this.speed = 3;
    	this.range = 3;
    	break

    	case'napalm':
    	this.speed = 2;
    	this.range = 3;
    	break

    	case'ninja':
    	if(!loadamogus){this.amogus = false}else{this.amogus = true}
    	this.speed = 2;
    	this.range = 2;
    	break

    	case'poison':
    	this.speed = 2;
    	this.range = 2;
    	break

    	case'vtb':
    	this.speed = 3;
    	if(!loadleftmoves){this.leftmoves = 0;}else{this.leftmoves = loadleftmoves;}
    	this.range = 3;
    	if(carg == undefined){this.cargo = false;}else{this.cargo = carg;}
    	if(cargq == undefined){this.cargoQ = 0;}else{this.cargoQ = cargq;}
    	if(!unitin){this.unitinside = 0;}else{this.unitinside = unitin}
    	if(!loadmoved){this.moved = false;}else{this.moved = loadmoved;}
    	this.upcargo = function(){

    		if(document.getElementById(this.id+"_carg")){
    			//move
    			var div = document.getElementById(this.id+'_carg');
	    		div.style.left = (this.posx*64)+marginsizex+"px";
	   			div.style.top = (this.posy*64+0)+marginsizey+"px";

			}else{
				//create
				if(this.cargo != false || this.cargo === 0){
					
					var div = document.createElement('div');
	    			div.id = this.id+"_carg";
	    			div.classList.add('carg');
	    		
	    			div.style.left = (this.posx*64)+marginsizex+"px";
	   				div.style.top = (this.posy*64+0)+marginsizey+"px";
	    		
	    			document.body.appendChild(div);
	    			document.getElementById(this.id+'_carg').style.backgroundImage = "url('tiles/cargo"+this.cargoQ+".png')";
	    			
	    		}else if(this.unitinside != false){
	    			var div = document.createElement('div');
	    			div.id = this.id+"_carg";
	    			div.classList.add('carg');
	    		
	    			div.style.left = (this.posx*64)+marginsizex+"px";
	   				div.style.top = (this.posy*64+0)+marginsizey+"px";
	    		
	    			document.body.appendChild(div);
	    			var path = "url('tiles/"+this.unitinside.type+""+this.unitinside.skin+"/"+this.unitinside.type+"1.png')";
	    			document.getElementById(this.id+'_carg').style.backgroundImage = path;
	    		}
			}
		}

		this.upcargo();

		this.delcargo = function(){
			if(document.getElementById(this.id+"_carg")){
				document.getElementById(this.id+"_carg").remove();
			}
		}

		this.outvtb = function(){
			if(this.unitinside.id){
				this.unitinside.vtb = -1;
    			this.unitinside.posx = memoposx;
    			this.unitinside.posy = memoposy;
    			unit[this.unitinside.numid].spawn();
    			if(this.unitinside.id){
    				unit[this.unitinside.numid].playedtwice = false;
    				unit[this.unitinside.numid].playable = false;
    				unit[this.unitinside.numid].posx = selposx;
    				unit[this.unitinside.numid].posy = selposy;
    				eval(this.unitinside.id).style.left = (this.unitinside.posx*64+17)+marginsizex+"px";
    				eval(this.unitinside.id).style.top = (this.unitinside.posy*64+10)+marginsizey+"px";
    				document.getElementById(this.unitinside.id).classList.remove(this.unitinside.type+this.unitinside.skin);
	        		document.getElementById(this.unitinside.id).classList.add(this.unitinside.type+this.unitinside.skin+"_off");
    			}
    			this.unitinside = 0;
    			if(isnight == 1 && enableShadows > 0){
	    			shadowExList();
    			}
    			firekill();
    			gaskill();
			}else{
				this.unitinside = 0;
			}
    	}

    	break

    	case'villager':
    	this.speed = 1;
    	this.range = 1;
    	this.origin = ori;
    	if(villages[this.origin].team == 1){
			this.skin = player1;
			this.teamskin = 1;
    	}else if(villages[this.origin].team == 2){
    		this.skin = player2;
			this.teamskin = 2;
    	}else{
    		this.skin = player3;
    	}
    	break

    	case'shield':
    	this.speed = 2;
    	this.range = 2;
    	break

    	case'gunner':
    	this.speed = 2;
    	this.range = 4;
    	if(!canresh){this.canreshoot = 0;}else{this.canreshoot = canresh;}
    	break

    	case'seg':
    	this.speed = 2;
    	this.range = 0;
    	this.alreadygone = false;
    	this.fart = function(){
    		noenter = true;
    		nospace = true;
    		selchar = "none";
			resetvisual();
    		document.getElementById(this.id).style.transition = 'all ease-in-out 7s';
    		document.getElementById(this.id).style.transform = 'scale(2.0)';
    		document.getElementById('fart').play();
    		setTimeout(function(){scream.play()}, 7100);
    		document.getElementById('bgm').volume = 0;
    		var tthis = this;
    		setTimeout(function(){
    			newgas(tthis.posx, tthis.posy, tthis.numid, tthis.team);
    			gas[gasN].spawn();
    			gasN++;
    			selchar = 'none';
    			document.getElementById('speed2').style.left = "-412px";
 		   		document.getElementById('selection').style.background = 'black';
	    		document.getElementById('bgm').volume = 0.3;
    			noenter = false;
    			nospace = false;
 		   		tthis.die();

    		}, 7575)
    	}

    	this.fart2 = function(){
    		if(this.alreadygone == false){
    			this.alreadygone = true;
    		}else{
    			return
    		}
    		noenter = true;
    		nospace = true;
    		document.getElementById('fart_short').play();
    		document.getElementById('bgm').volume = 0.1;
    		var tthis = this;
    		setTimeout(function(){
    			newgas(tthis.posx, tthis.posy, tthis.numid, tthis.team);
    			gas[gasN].spawn();
    			gasN++;
    			selchar = 'none';
    			document.getElementById('speed2').style.left = "-412px";
 		   		document.getElementById('selection').style.background = 'black';
	    		document.getElementById('bgm').volume = 0.3;
    			noenter = false;
    			nospace = false;
 		   		tthis.die();

    		}, 100);
    	}
    	break

    	case'builder':
    	this.speed = 2;
    	this.range = 2;
    	if(!cutt){this.cuttree = 0;}else{this.cuttree = cutt;}
    	this.build = function(){
    		create('tower',this.team,this.posx,this.posy,'non-équipé',false);
    		ctx.drawImage(image, 0, 0, 99, 100, this.posx*64, this.posy*64, 64, 64);
    		document.getElementById('bgm').volume = 0.1;
    		document.getElementById('sfx2').play();
      		setTimeout(function() {document.getElementById('bgm').volume = 0.3;}, 600);
    		this.die();
    		delete this.build;
    	}
    	break
    	case'tower':
    	let thisnumA = Number(this.posx)+1;
    	let thisnumB = Number(this.posx)+2;
    	let thisnumC = Number(this.posx)+3;
    	let thisnumD = Number(this.posy)+1;
    	let thisnumE = Number(this.posy)+2;
    	let thisnumF = Number(this.posy)+3;
    	this.speed = 0;
    	this.range = 3;
    	this.rangemap = [Number(this.posx)+Number(1)+"/"+Number(this.posy), Number(this.posx)+Number(2)+"/"+Number(this.posy), Number(this.posx)+Number(3)+"/"+this.posy, Number(this.posx-1)+"/"+Number(this.posy), Number(this.posx-2)+"/"+Number(this.posy), Number(this.posx-3)+"/"+this.posy, Number(this.posx)+"/"+thisnumD, Number(this.posx)+"/"+thisnumE, Number(this.posx)+"/"+thisnumF, Number(this.posx)+"/"+Number(this.posy-1), Number(this.posx)+"/"+Number(this.posy-2), Number(this.posx)+"/"+Number(this.posy-3), Number(this.posx)+Number(1)+"/"+thisnumD, Number(this.posx-1)+"/"+thisnumD, Number(this.posx)+Number(1)+"/"+Number(this.posy-1), Number(this.posx-1)+"/"+Number(this.posy-1), Number(this.posx)+Number(1)+"/"+thisnumE, Number(this.posx)+Number(1)+"/"+Number(this.posy-2), Number(this.posx)+Number(2)+"/"+thisnumD, Number(this.posx)+Number(2)+"/"+Number(this.posy-1), Number(this.posx-2)+"/"+thisnumD, Number(this.posx-2)+"/"+Number(this.posy-1), Number(this.posx-1)+"/"+thisnumE, Number(this.posx-1)+"/"+Number(this.posy-2)];
    	break

    	case'tank':
    	this.speed = 1;
    	this.range = 4;
    	break

    	case'radio':
    	this.speed = 2;
    	this.range = 8;
    	break

    	case'ninja':
    	this.speed = 2;
    	this.range = 2;
    	break

    	case'trumpet':
    	this.speed = 3;
    	this.range = 4;
    	break
    }

    this.die = function(){
    	if(document.getElementById(this.id)){
	    	document.getElementById(this.id).remove();
    	}

    	if(this.type == 'villager'){
    		delete this.origin;
    		delete this.teamskin;
    	}

 		if(this.type == 'seg'){
 			delete this.fart;
 			delete this.fart2;
 		}

 		if(this.type == 'gunner'){
 			delete this.canreshoot;
 		}

 		if(this.type == 'builder'){
 			delete this.cuttree;
 		}

 		if(this.type == 'tower'){
 			delete this.rangemap;
 		}

 		if(this.type == 'vtb'){
 			if(document.getElementById(this.id+"_carg")){
 				document.getElementById(this.id+"_carg").remove();
 			}
 			delete this.unitinside;
 			delete this.cargoQ
 			delete this.upcargo;
 			delete this.delcargo;
 			delete this.cargo;
 			delete this.outvtb;
 			delete this.moved;
 			delete this.leftmoves;
 		}

    	delete this.infected;
 		delete this.playedtwice;
    	delete this.type;
    	delete this.team;
    	delete this.posx;
    	delete this.posy;
    	delete this.speed;
    	delete this.mobile;
    	delete this.range;
    	delete this.playable;
    	delete this.id;
    	delete this.build;
    	delete this.numid;
    	delete this.skin
    	delete this.invtb;
    	delete this.incannon;
    	delete this.spawn;
    	delete this.vtb;
    	delete this.cannon;
    	cycletowers();
    	delete this.die;
    }

    if(this.infected == 1){
    	var _this = this;
		if(this.type == 'vtb' && this.unitinside != 0){
			this.unitinside.die();
		}else if(this.vtb != -1){
			unit[this.vtb].unitinside = 0;
			unit[this.vtb].delcargo();
		}else if(this.cannon != -1){
			cannons[this.cannon].unitinside = 0;
			cannons[this.cannon].delcargo();
		}
		setTimeout(function(){_this.die()}, 500);
		bgm.volume = 0.1;
		document.getElementById("oof").play();
		setTimeout(function(){bgm.volume = 0.2}, 2000);
	}

    this.invtb = function(vtbid){
    	document.getElementById(this.id).remove();
    	this.posx = -10;
    	this.posy = -10;
    	this.vtb = vtbid;
    }

    this.incannon = function(cannonid){
    	document.getElementById(this.id).remove();
    	if(isnight == 1 && enableShadows > 0){shadowExList()}
    	this.posx = -10;
    	this.posy = -10;
    	this.cannon = cannonid;
    }

    this.spawn = function(){
    	var div = document.createElement('div');
    	div.id = this.id;
    	if(canplay){
    		div.classList.add(this.type+this.skin);
    	}else{
    		div.classList.add(this.type+this.skin+'_off');
    	}
    	if(this.type == 'tower'){
    		div.classList.add('large_char');
    		div.style.left = (this.posx*64)+marginsizex+"px";
    		div.style.top = (this.posy*64+0)+marginsizey+"px";
    	}else{
    		div.classList.add('char');
    		div.style.left = (this.posx*64+17)+marginsizex+"px";
    		div.style.top = (this.posy*64+10)+marginsizey+"px";
    	}
    	document.body.appendChild(div);
    	if(!loadUnits){
    		cycletowers();
    	}
    }
}

function poisonhide(){
	for(i=0; i < poisonmap.length; i++){
		if(poisonmap[i].team){
			if(poisonmap[i].team != turn){
				document.getElementById("poison_"+i).style.display = "none";
			}else{
				document.getElementById("poison_"+i).style.display = "block";
			}
		}
	}
}

function poison(x,y,team,temp,loadsize){
	this.id = "poison_"+poisonN;
	this.team = team;
	this.posx = x;
	this.posy = y;
	this.leftturns = temp;
	this.size = loadsize;
	this.spawn = function(){
		div = document.createElement('div');
		posx = this.posx;
		posy = this.posy;
   		div.id = this.id;
    	if(this.size == 0){
    		div.classList.add('classpoison');
    	}else{
    		div.classList.add('classpoisonbig');
    	}
    	document.body.appendChild(div);
		div.style.left = (posx*64)+marginsizex+'px';
		div.style.top = (posy*64)+marginsizey+'px';
	}

	this.die = function(){
		document.getElementById(this.id).remove();
		delete this.spawn;
		delete this.team;
		delete this.leftturns;
		delete this.posx;
		delete this.posy;
		delete this.id;
		delete this.size;
		delete this.die;
	}
}

function gasfart(x,y,origin,t,wi){
	x = Number(x);
	y = Number(y);
	if(!wi){this.wind = wind;}else{this.wind = wi}
	this.team = t;
	if(this.team == 1){
		this.skin = player1;
	}else if(this.team == 2){
		this.skin = player2;
	}else{
		this.skin = player3; 
	}
	this.id = "gasfart_"+gasN;
	this.posx1 = x;
	this.posy1 = y;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx1);
		toxtilesblue.push(this.posy1);
		break

		case 2:
		toxtilespurple.push(this.posx1);
		toxtilespurple.push(this.posy1);
		break

		case 3:	
		toxtiles.push(this.posx1);
		toxtiles.push(this.posy1);
		break
	}

	this.posx2 = eval(x+1);
	this.posy2 = y;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx2);
		toxtilesblue.push(this.posy2);
		break

		case 2:
		toxtilespurple.push(this.posx2);
		toxtilespurple.push(this.posy2);
		break

		case 3:	
		toxtiles.push(this.posx2);
		toxtiles.push(this.posy2);
		break
	}

	this.posx3 = x-1;
	this.posy3 = y;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx3);
		toxtilesblue.push(this.posy3);
		break

		case 2:
		toxtilespurple.push(this.posx3);
		toxtilespurple.push(this.posy3);
		break

		case 3:	
		toxtiles.push(this.posx3);
		toxtiles.push(this.posy3);
		break
	}

	this.posx4 = x;
	this.posy4 = eval(y+1);
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx4);
		toxtilesblue.push(this.posy4);
		break

		case 2:
		toxtilespurple.push(this.posx4);
		toxtilespurple.push(this.posy4);
		break

		case 3:	
		toxtiles.push(this.posx4);
		toxtiles.push(this.posy4);
		break
	}

	this.posx5 = eval(x+1);
	this.posy5 = y+1;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx5);
		toxtilesblue.push(this.posy5);
		break

		case 2:
		toxtilespurple.push(this.posx5);
		toxtilespurple.push(this.posy5);
		break

		case 3:	
		toxtiles.push(this.posx5);
		toxtiles.push(this.posy5);
		break
	}

	this.posx6 = x-1;
	this.posy6 = eval(y+1);
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx6);
		toxtilesblue.push(this.posy6);
		break

		case 2:
		toxtilespurple.push(this.posx6);
		toxtilespurple.push(this.posy6);
		break

		case 3:	
		toxtiles.push(this.posx6);
		toxtiles.push(this.posy6);
		break
	}

	this.posx7 = x;
	this.posy7 = y-1;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx7);
		toxtilesblue.push(this.posy7);
		break

		case 2:
		toxtilespurple.push(this.posx7);
		toxtilespurple.push(this.posy7);
		break

		case 3:	
		toxtiles.push(this.posx7);
		toxtiles.push(this.posy7);
		break
	}

	this.posx8 = eval(x+1);
	this.posy8 = y-1;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx8);
		toxtilesblue.push(this.posy8);
		break

		case 2:
		toxtilespurple.push(this.posx8);
		toxtilespurple.push(this.posy8);
		break

		case 3:	
		toxtiles.push(this.posx8);
		toxtiles.push(this.posy8);
		break
	}

	this.posx9 = x-1;
	this.posy9 = y-1;
	switch(this.team){
		case 1:
		toxtilesblue.push(this.posx9);
		toxtilesblue.push(this.posy9);
		break

		case 2:
		toxtilespurple.push(this.posx9);
		toxtilespurple.push(this.posy9);
		break

		case 3:	
		toxtiles.push(this.posx9);
		toxtiles.push(this.posy9);
		break
	}

	this.die = function(){
		setTimeout(function(){}, 1500);
		document.getElementById(this.id+"_1").remove();
		document.getElementById(this.id+"_2").remove();
		document.getElementById(this.id+"_3").remove();
		document.getElementById(this.id+"_4").remove();
		document.getElementById(this.id+"_5").remove();
		document.getElementById(this.id+"_6").remove();
		document.getElementById(this.id+"_7").remove();
		document.getElementById(this.id+"_8").remove();
		document.getElementById(this.id+"_9").remove();
		delete this.posx1;
		delete this.posy1;
		delete this.posx2;
		delete this.posy2;
		delete this.posx3;
		delete this.posy3;
		delete this.posx4;
		delete this.posy4;
		delete this.posx5;
		delete this.posy5;
		delete this.posx6;
		delete this.posy6;
		delete this.posx7;
		delete this.posy7;
		delete this.posx8;
		delete this.posy8;
		delete this.posx9;
		delete this.posy9;
		delete this.spawn;
		delete this.move;
		delete this.wind;
		delete this.team;
		delete this.skin;
		delete this.id;
		delete this.die;
	}

	this.spawn = function(){
		var tthis = this;
		var div = '';
		var tempx = '';
		var tempy = '';
		for(i=1 ; i < 10; i++){
			div = document.createElement('div');
			tempx = eval('this.posx'+i);
			tempy = eval('this.posy'+i);
    		div.id = this.id+"_"+i;
    		if(!wi){div.style.background = 'url("tiles/gas'+tthis.skin+'_'+wind+'.png")';}else{div.style.background = 'url("tiles/gas'+tthis.skin+'_'+wi+'.png")';}
    		div.classList.add('classgas'+tthis.skin);
    		document.body.appendChild(div);
			div.style.left = (tempx*64)+marginsizex+'px';
			div.style.top = (tempy*64)+marginsizey+'px';
		}
		gaskill(origin);
	}

	this.move = function(){
		if(this.wind == 'right'){
			//wind right
			this.posx1 = this.posx1+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx1);
				toxtilesblue.push(this.posy1);
				break

				case 2:
				toxtilespurple.push(this.posx1);
				toxtilespurple.push(this.posy1);
				break

				case 3:	
				toxtiles.push(this.posx1);
				toxtiles.push(this.posy1);
				break
			}

			this.posx2 = this.posx2+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx2);
				toxtilesblue.push(this.posy2);
				break

				case 2:
				toxtilespurple.push(this.posx2);
				toxtilespurple.push(this.posy2);
				break

				case 3:	
				toxtiles.push(this.posx2);
				toxtiles.push(this.posy2);
				break
			}

			this.posx3 = this.posx3+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx3);
				toxtilesblue.push(this.posy3);
				break

				case 2:
				toxtilespurple.push(this.posx3);
				toxtilespurple.push(this.posy3);
				break

				case 3:	
				toxtiles.push(this.posx3);
				toxtiles.push(this.posy3);
				break
			}

			this.posx4 = this.posx4+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx4);
				toxtilesblue.push(this.posy4);
				break

				case 2:
				toxtilespurple.push(this.posx4);
				toxtilespurple.push(this.posy4);
				break

				case 3:	
				toxtiles.push(this.posx4);
				toxtiles.push(this.posy4);
				break
			}

			this.posx5 = this.posx5+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx5);
				toxtilesblue.push(this.posy5);
				break

				case 2:
				toxtilespurple.push(this.posx5);
				toxtilespurple.push(this.posy5);
				break

				case 3:	
				toxtiles.push(this.posx5);
				toxtiles.push(this.posy5);
				break
			}

			this.posx6 = this.posx6+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx6);
				toxtilesblue.push(this.posy6); 
				break

				case 2:
				toxtilespurple.push(this.posx6);
				toxtilespurple.push(this.posy6); 
				break

				case 3:	
				toxtiles.push(this.posx6);
				toxtiles.push(this.posy6); 
				break
			}

			this.posx7 = this.posx7+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx7);
				toxtilesblue.push(this.posy7);
				break

				case 2:
				toxtilespurple.push(this.posx7);
				toxtilespurple.push(this.posy7);
				break

				case 3:	
				toxtiles.push(this.posx7);
				toxtiles.push(this.posy7);
				break
			}

			this.posx8 = this.posx8+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx8);
				toxtilesblue.push(this.posy8);
				break

				case 2:
				toxtilespurple.push(this.posx8);
				toxtilespurple.push(this.posy8);
				break

				case 3:	
				toxtiles.push(this.posx8);
				toxtiles.push(this.posy8);
				break
			}

			this.posx9 = this.posx9+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx9);
				toxtilesblue.push(this.posy9);
				break

				case 2:
				toxtilespurple.push(this.posx9);
				toxtilespurple.push(this.posy9);
				break

				case 3:	
				toxtiles.push(this.posx9);
				toxtiles.push(this.posy9);
				break
			}
		}else if(this.wind == 'left'){
			//wind left
			this.posx1 = this.posx1-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx1);
				toxtilesblue.push(this.posy1);
				break

				case 2:
				toxtilespurple.push(this.posx1);
				toxtilespurple.push(this.posy1);
				break

				case 3:	
				toxtiles.push(this.posx1);
				toxtiles.push(this.posy1);
				break
			}

			this.posx2 = this.posx2-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx2);
				toxtilesblue.push(this.posy2);
				break

				case 2:
				toxtilespurple.push(this.posx2);
				toxtilespurple.push(this.posy2);
				break

				case 3:	
				toxtiles.push(this.posx2);
				toxtiles.push(this.posy2);
				break
			}

			this.posx3 = this.posx3-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx3);
				toxtilesblue.push(this.posy3);
				break

				case 2:
				toxtilespurple.push(this.posx3);
				toxtilespurple.push(this.posy3);
				break

				case 3:	
				toxtiles.push(this.posx3);
				toxtiles.push(this.posy3);
				break
			}

			this.posx4 = this.posx4-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx4);
				toxtilesblue.push(this.posy4);
				break

				case 2:
				toxtilespurple.push(this.posx4);
				toxtilespurple.push(this.posy4);
				break

				case 3:	
				toxtiles.push(this.posx4);
				toxtiles.push(this.posy4);
				break
			}

			this.posx5 = this.posx5-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx5);
				toxtilesblue.push(this.posy5);
				break

				case 2:
				toxtilespurple.push(this.posx5);
				toxtilespurple.push(this.posy5);
				break

				case 3:	
				toxtiles.push(this.posx5);
				toxtiles.push(this.posy5);
				break
			}

			this.posx6 = this.posx6-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx6);
				toxtilesblue.push(this.posy6); 
				break

				case 2:
				toxtilespurple.push(this.posx6);
				toxtilespurple.push(this.posy6); 
				break

				case 3:	
				toxtiles.push(this.posx6);
				toxtiles.push(this.posy6); 
				break
			}

			this.posx7 = this.posx7-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx7);
				toxtilesblue.push(this.posy7);
				break

				case 2:
				toxtilespurple.push(this.posx7);
				toxtilespurple.push(this.posy7);
				break

				case 3:	
				toxtiles.push(this.posx7);
				toxtiles.push(this.posy7);
				break
			}

			this.posx8 = this.posx8-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx8);
				toxtilesblue.push(this.posy8);
				break

				case 2:
				toxtilespurple.push(this.posx8);
				toxtilespurple.push(this.posy8);
				break

				case 3:	
				toxtiles.push(this.posx8);
				toxtiles.push(this.posy8);
				break
			}

			this.posx9 = this.posx9-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx9);
				toxtilesblue.push(this.posy9);
				break

				case 2:
				toxtilespurple.push(this.posx9);
				toxtilespurple.push(this.posy9);
				break

				case 3:	
				toxtiles.push(this.posx9);
				toxtiles.push(this.posy9);
				break
			}
		}else if(this.wind == 'top'){
			//wind top
			this.posy1 = this.posy1-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx1);
				toxtilesblue.push(this.posy1);
				break

				case 2:
				toxtilespurple.push(this.posx1);
				toxtilespurple.push(this.posy1);
				break

				case 3:	
				toxtiles.push(this.posx1);
				toxtiles.push(this.posy1);
				break
			}

			this.posy2 = this.posy2-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx2);
				toxtilesblue.push(this.posy2);
				break

				case 2:
				toxtilespurple.push(this.posx2);
				toxtilespurple.push(this.posy2);
				break

				case 3:	
				toxtiles.push(this.posx2);
				toxtiles.push(this.posy2);
				break
			}

			this.posy3 = this.posy3-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx3);
				toxtilesblue.push(this.posy3);
				break

				case 2:
				toxtilespurple.push(this.posx3);
				toxtilespurple.push(this.posy3);
				break

				case 3:	
				toxtiles.push(this.posx3);
				toxtiles.push(this.posy3);
				break
			}

			this.posy4 = this.posy4-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx4);
				toxtilesblue.push(this.posy4);
				break

				case 2:
				toxtilespurple.push(this.posx4);
				toxtilespurple.push(this.posy4);
				break

				case 3:	
				toxtiles.push(this.posx4);
				toxtiles.push(this.posy4);
				break
			}

			this.posy5 = this.posy5-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx5);
				toxtilesblue.push(this.posy5);
				break

				case 2:
				toxtilespurple.push(this.posx5);
				toxtilespurple.push(this.posy5);
				break

				case 3:	
				toxtiles.push(this.posx5);
				toxtiles.push(this.posy5);
				break
			}

			this.posy6 = this.posy6-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx6);
				toxtilesblue.push(this.posy6); 
				break

				case 2:
				toxtilespurple.push(this.posx6);
				toxtilespurple.push(this.posy6); 
				break

				case 3:	
				toxtiles.push(this.posx6);
				toxtiles.push(this.posy6); 
				break
			}

			this.posy7 = this.posy7-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx7);
				toxtilesblue.push(this.posy7);
				break

				case 2:
				toxtilespurple.push(this.posx7);
				toxtilespurple.push(this.posy7);
				break

				case 3:	
				toxtiles.push(this.posx7);
				toxtiles.push(this.posy7);
				break
			}

			this.posy8 = this.posy8-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx8);
				toxtilesblue.push(this.posy8);
				break

				case 2:
				toxtilespurple.push(this.posx8);
				toxtilespurple.push(this.posy8);
				break

				case 3:	
				toxtiles.push(this.posx8);
				toxtiles.push(this.posy8);
				break
			}

			this.posy9 = this.posy9-2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx9);
				toxtilesblue.push(this.posy9);
				break

				case 2:
				toxtilespurple.push(this.posx9);
				toxtilespurple.push(this.posy9);
				break

				case 3:	
				toxtiles.push(this.posx9);
				toxtiles.push(this.posy9);
				break
			}
		}else{
			//wind bottom
			this.posy1 = this.posy1+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx1);
				toxtilesblue.push(this.posy1);
				break

				case 2:
				toxtilespurple.push(this.posx1);
				toxtilespurple.push(this.posy1);
				break

				case 3:
				toxtiles.push(this.posx1);
				toxtiles.push(this.posy1);
				break
			}

			this.posy2 = this.posy2+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx2);
				toxtilesblue.push(this.posy2);
				break

				case 2:
				toxtilespurple.push(this.posx2);
				toxtilespurple.push(this.posy2);
				break

				case 3:
				toxtiles.push(this.posx2);
				toxtiles.push(this.posy2);
				break
			}

			this.posy3 = this.posy3+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx3);
				toxtilesblue.push(this.posy3);
				break

				case 2:
				toxtilespurple.push(this.posx3);
				toxtilespurple.push(this.posy3);
				break

				case 3:
				toxtiles.push(this.posx3);
				toxtiles.push(this.posy3);
				break
			}

			this.posy4 = this.posy4+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx4);
				toxtilesblue.push(this.posy4);
				break

				case 2:
				toxtilespurple.push(this.posx4);
				toxtilespurple.push(this.posy4);
				break

				case 3:
				toxtiles.push(this.posx4);
				toxtiles.push(this.posy4);
				break
			}

			this.posy5 = this.posy5+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx5);
				toxtilesblue.push(this.posy5);
				break

				case 2:
				toxtilespurple.push(this.posx5);
				toxtilespurple.push(this.posy5);
				break

				case 3:
				toxtiles.push(this.posx5);
				toxtiles.push(this.posy5);
				break
			}

			this.posy6 = this.posy6+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx6);
				toxtilesblue.push(this.posy6);
				break

				case 2:
				toxtilespurple.push(this.posx6);
				toxtilespurple.push(this.posy6);
				break

				case 3:
				toxtiles.push(this.posx6);
				toxtiles.push(this.posy6); 
				break
			}

			this.posy7 = this.posy7+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx7);
				toxtilesblue.push(this.posy7);
				break

				case 2:
				toxtilespurple.push(this.posx7);
				toxtilespurple.push(this.posy7);
				break

				case 3:
				toxtiles.push(this.posx7);
				toxtiles.push(this.posy7);
				break
			}

			this.posy8 = this.posy8+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx8);
				toxtilesblue.push(this.posy8);
				break

				case 2:
				toxtilespurple.push(this.posx8);
				toxtilespurple.push(this.posy8);
				break

				case 3:
				toxtiles.push(this.posx8);
				toxtiles.push(this.posy8);
				break
			}

			this.posy9 = this.posy9+2;
			switch(this.team){
				case 1:
				toxtilesblue.push(this.posx9);
				toxtilesblue.push(this.posy9);
				break

				case 2:
				toxtilespurple.push(this.posx9);
				toxtilespurple.push(this.posy9);
				break

				case 3:
				toxtiles.push(this.posx9);
				toxtiles.push(this.posy9);
				break
			}
		}
		for(i=1 ; i < 10; i++){
			div = document.getElementById(this.id+'_'+i);
			tempx = eval('this.posx'+i);
			tempy = eval('this.posy'+i);
			div.style.left = (tempx*64)+marginsizex+'px';
			div.style.top = (tempy*64)+marginsizey+'px';
		}
		if(this.posx1 <= -2 || this.posx1 >= Number(xtiles)+1 || this.posy1 <= -2 || this.posy1 >= Number(ytiles)+1){
			this.die();
		}
	}
}

function mountain(x,y){
	this.posx = x;
	this.posy = y;
}

function water(x,y){
	this.posx = x;
	this.posy = y;
}

function bridge(x,y){
	this.posx = x;
	this.posy = y;
}

function village(x,y,sleft,t){
	this.posx = x;
	this.posy = y;
	if(!t){this.team = 3;}else{this.team = t};
	this.slimeleft = 1;
	if(sleft == false){
		this.slimeleft = 0;
	}
}

function city(x,y){
	this.team = 3;
	this.posx = x;
	this.posy = y;
	this.territoire = 0;
}

function cannon(x,y,loadteam,loadid,loadunitinside){
	this.posx = x;
	this.posy = y;
	if(!loadid){this.id = "cannon"+cannonN}else{this.id = loadid}
	if(!loadteam){this.team = turn}else{this.team = loadteam}
	if(!loadunitinside){this.unitinside = false}else{this.unitinside = loadunitinside}
	this.outcannon = function(){
		if(this.unitinside.id){
			this.unitinside.cannon = -1;
    		this.unitinside.posx = memoposx;
    		this.unitinside.posy = memoposy;
    		unit[this.unitinside.numid].spawn();
    		if(this.unitinside.id){
    			unit[this.unitinside.numid].posx = selposx;
    			unit[this.unitinside.numid].posy = selposy;
    			eval(this.unitinside.id).style.left = (selposx*64+17)+marginsizex+"px";
    			eval(this.unitinside.id).style.top = (selposy*64+10)+marginsizey+"px";
    			if(unit[this.unitinside.numid].playable == false){
    				document.getElementById(this.unitinside.id).classList.remove(this.unitinside.type+this.unitinside.skin);
        			document.getElementById(this.unitinside.id).classList.add(this.unitinside.type+this.unitinside.skin+"_off");
        		}
    		}
    		if(this.unitinside.type == "seg"){
    			var distx = Math.abs(cannons[cannonselected].posx - selposx);
      			var disty = Math.abs(cannons[cannonselected].posy - selposy);
      			var distot = distx + disty;
      			if(distot > 1){
	    			var _this = this;
	    			setTimeout(function(){unit[_this.unitinside.numid].fart2();_this.unitinside = 0}, 250);
      			}
    		}
    		this.delcargo();
    		poisonturninfection();
    		if(isnight == 1 && enableShadows > 0){
	   			shadowExList();
    		}
    		var _this = this;
    		setTimeout(function(){firekill();gaskill();_this.unitinside = 0;}, 1000);
		}else{
			this.unitinside = 0;
		}
    }

    this.upcargo = function(){

    		if(document.getElementById(this.id+"_carg")){
    			//move
    			var div = document.getElementById(this.id+'_carg');
	    		div.style.left = (this.posx*64)+marginsizex+"px";
	   			div.style.top = (this.posy*64+0)+marginsizey+"px";

			}else{
				if(this.unitinside != false){
	    			var div = document.createElement('div');
	    			div.id = this.id+"_carg";
	    			div.classList.add('carg');
	    		
	    			div.style.left = (this.posx*64)+marginsizex+"px";
	   				div.style.top = (this.posy*64+0)+marginsizey+"px";
	    		
	    			document.body.appendChild(div);
	    			var path = "url('tiles/"+this.unitinside.type+""+this.unitinside.skin+"/"+this.unitinside.type+"1.png')";
	    			document.getElementById(this.id+'_carg').style.backgroundImage = path;
	    		}
			}
		}

		this.upcargo();

		this.delcargo = function(){
			if(document.getElementById(this.id+"_carg")){
				document.getElementById(this.id+"_carg").remove();
			}
		}

    this.die = function(){
    	if(this.unitinside){unit[this.unitinside.numid].die()}
    	delete this.posx;
    	delete this.posy;
    	delete this.id;
    	delete this.team;
    	delete this.outcannon;
    	delete this.unitinside;
    	delete this.upcargo;
    	delete this.delcargo;
    	if(enableShadows > 0 && isnight == 1){
    		shadowExList();
    	}
    	delete this.die;
    }
}

function town(x,y,q,load,t,prog,lastqual){
	this.id = townN;
	if(!load){this.team = eval(selchar).team;}else{this.team = t;}
	this.posx = x;
	this.posy = y;
	if(!load){this.quality = q;}else{this.quality = q;}
	if(!load){this.lastquality = q;}else{this.lastquality = lastqual;}
	if(!load){this.progression = 6;}else{this.progression = prog;}
	this.work = function(dontwork){
		if(!dontwork){this.progression--;}
		if(this.quality != 0){
			if(this.progression <= 0){
				if(document.getElementById("town_"+this.id+"_carg")){
					//do nothing
				}else{
					var div = document.createElement('div');
					div.id = "town_"+this.id+"_carg";
					div.classList.add('carg');

					div.style.left = (this.posx*64+44)+marginsizex+"px";
					div.style.top = (this.posy*64+0)+marginsizey+"px";
				
					document.body.appendChild(div);
					document.getElementById('town_'+this.id+'_carg').style.backgroundImage = "url('tiles/cargo"+this.quality+".png')";
					var unitid = unit[isunit(this.posx, this.posy)];
					if(unitid){
						if(unit[unitid.numid].type == "vtb" && unit[unitid.numid].cargo == false && unit[unitid.numid].cargo !== 0 && unit[unitid.numid].unitinside == false){
							unit[unitid.numid].cargoQ = this.lastquality;
      						unit[unitid.numid].cargo = this.id;
      						unit[unitid.numid].upcargo();
      						this.newprog();
      						cargosound();
						}
					}
				}
			}
		}else{
			this.lastquality = 0;
		}
	}

	this.newprog = function(){
		this.lastquality = this.quality;

		if(document.getElementById("town_"+this.id+"_carg")){
			document.getElementById("town_"+this.id+"_carg").remove();
		}
		if(this.team == 1){
			this.progression = 6;
		}else{
			this.progression = 6;
		}
	}

	if(!load){
		this.newprog();
	}
}

function wood(x,y){
	this.posx = x;
	this.posy = y;
}

function plain(x,y){
	this.posx = x;
	this.posy = y;
}

document.getElementById('buybox').style.zIndex = -1;
selcity1.pause();
selcity1.currentTime = 0;
selcity2.pause();
selcity2.currentTime = 0;
selcity3.pause();
selcity3.currentTime = 0;
setbgm(turn);
if(turn == 1){
     var Nskin = player1; 
}else{
	var Nskin = player2;
}
document.getElementById('fts-img').src = "tiles/fts"+Nskin+"/fts1.png";
document.getElementById('gunner-img').src = "tiles/gunner"+Nskin+"/gunner1.png";
document.getElementById('shield-img').src = "tiles/shield"+Nskin+"/shield1.png";
document.getElementById('builder-img').src = "tiles/builder"+Nskin+"/builder1.png";
document.getElementById('tank-img').src = "tiles/tank"+Nskin+"/tank1.png";
document.getElementById('ninja-img').src = "tiles/ninja"+Nskin+"/ninja1.png";
document.getElementById('seg-img').src = "tiles/seg"+Nskin+"/seg1.png";
document.getElementById('radio-img').src = "tiles/radio"+Nskin+"/radio1.png";
document.getElementById('vtb-img').src = "tiles/vtb"+Nskin+"/vtb1.png";
document.getElementById('trumpet-img').src = "tiles/trumpet"+Nskin+"/trumpet1.png";
document.getElementById('napalm-img').src = "tiles/napalm"+Nskin+"/napalm1.png";
document.getElementById('poison-img').src = "tiles/poison"+Nskin+"/poison1.png";

function particlesUpdate(direction){ 
	if($_GET('biome') == 1){
		window.pJSDom[0].pJS.particles.color.value = "#AFF";
	}else if($_GET('biome') == 2){
		window.pJSDom[0].pJS.particles.color.value = "#500";
	}else{
		window.pJSDom[0].pJS.particles.color.value = "#EE6";
	}
	 window.pJSDom[0].pJS.particles.move.direction = direction; 
	 window.pJSDom[0].pJS.particles.move.direction = direction;
     window.pJSDom[0].pJS.fn.particlesRefresh();
}

function particles(){
	particlesJS('particles-js',
  
  {
    "particles": {
      "number": {
        "value": 25,
        "density": {
          "enable": true,
          "value_area": 1200
        }
      },
      "color": {
        "value": "#EE6"
      },
      "shape": {
        "type": "edge",
        "stroke": {
          "width": 0,
          "color": "#000000"
        },
        "polygon": {
          "nb_sides": 5
        },
        "image": {
          "src": "img/github.svg",
          "width": 100,
          "height": 100
        }
      },
      "opacity": {
        "value": 0.5,
        "random": false,
        "anim": {
          "enable": false,
          "speed": 1,
          "opacity_min": 0.1,
          "sync": false
        }
      },
      "size": {
        "value": 5,
        "random": true,
        "anim": {
          "enable": false,
          "speed": 40,
          "size_min": 0.1,
          "sync": false
        }
      },
      "line_linked": {
        "enable": false,
        "distance": 150,
        "color": "#ffffff",
        "opacity": 0.4,
        "width": 1
      },
      "move": {
        "enable": true,
        "speed": 3,
        "direction": "none",
        "random": false,
        "straight": true,
        "out_mode": "out",
        "attract": {
          "enable": false,
          "rotateX": 600,
          "rotateY": 1200
        }
      }
    },
    "interactivity": {
      "detect_on": "canvas",
      "events": {
        "onhover": {
          "enable": false,
          "mode": "repulse"
        },
        "onclick": {
          "enable": false,
          "mode": "push"
        },
        "resize": false
      },
      "modes": {
        "grab": {
          "distance": 400,
          "line_linked": {
            "opacity": 1
          }
        },
        "bubble": {
          "distance": 400,
          "size": 40,
          "duration": 2,
          "opacity": 8,
          "speed": 3
        },
        "repulse": {
          "distance": 200
        },
        "push": {
          "particles_nb": 4
        },
        "remove": {
          "particles_nb": 2
        }
      }
    },
    "retina_detect": true,
    "config_demo": {
      "hide_card": false,
      "background_color": "#b61924",
      "background_image": "",
      "background_position": "50% 50%",
      "background_repeat": "no-repeat",
      "background_size": "cover"
    }
  }
);
}

function money(){
	balanceteam1 = 1000000;
	//balanceteam2 = 1000000;
	updatemoney();
}

if(enableShadows == 2){
	document.getElementById('night-filter').style.opacity = 1;
	document.getElementById('night-ambient').play();
	document.getElementById('owl-ambient').play();
	shadowExList();
	setTimeout(function(){killshadows();shadowExList();}, 500);
}

 setInterval(wateranimation, 50);
 loadbiome();

</script>
</html>

<script src="lib/particles.js"></script>